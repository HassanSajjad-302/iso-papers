<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang xml:lang>
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="mpark/wg21" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <meta name="dcterms.date" content="2023-09-19" />
  <title>A New Approach For Compiling C++</title>
  <style>
      code{white-space: pre-wrap;}
      span.smallcaps{font-variant: small-caps;}
      span.underline{text-decoration: underline;}
      div.column{display: inline-block; vertical-align: top; width: 50%;}
      div.csl-block{margin-left: 1.5em;}
      ul.task-list{list-style: none;}
      pre > code.sourceCode { white-space: pre; position: relative; }
      pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
      pre > code.sourceCode > span:empty { height: 1.2em; }
      .sourceCode { overflow: visible; }
      code.sourceCode > span { color: inherit; text-decoration: inherit; }
      div.sourceCode { margin: 1em 0; }
      pre.sourceCode { margin: 0; }
      @media screen {
      div.sourceCode { overflow: auto; }
      }
      @media print {
      pre > code.sourceCode { white-space: pre-wrap; }
      pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
      }
      pre.numberSource code
        { counter-reset: source-line 0; }
      pre.numberSource code > span
        { position: relative; left: -4em; counter-increment: source-line; }
      pre.numberSource code > span > a:first-child::before
        { content: counter(source-line);
          position: relative; left: -1em; text-align: right; vertical-align: baseline;
          border: none; display: inline-block;
          -webkit-touch-callout: none; -webkit-user-select: none;
          -khtml-user-select: none; -moz-user-select: none;
          -ms-user-select: none; user-select: none;
          padding: 0 4px; width: 4em;
          color: #aaaaaa;
        }
      pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
      div.sourceCode
        {  background-color: #f6f8fa; }
      @media screen {
      pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
      }
      code span { } /* Normal */
      code span.al { color: #ff0000; } /* Alert */
      code span.an { } /* Annotation */
      code span.at { } /* Attribute */
      code span.bn { color: #9f6807; } /* BaseN */
      code span.bu { color: #9f6807; } /* BuiltIn */
      code span.cf { color: #00607c; } /* ControlFlow */
      code span.ch { color: #9f6807; } /* Char */
      code span.cn { } /* Constant */
      code span.co { color: #008000; font-style: italic; } /* Comment */
      code span.cv { color: #008000; font-style: italic; } /* CommentVar */
      code span.do { color: #008000; } /* Documentation */
      code span.dt { color: #00607c; } /* DataType */
      code span.dv { color: #9f6807; } /* DecVal */
      code span.er { color: #ff0000; font-weight: bold; } /* Error */
      code span.ex { } /* Extension */
      code span.fl { color: #9f6807; } /* Float */
      code span.fu { } /* Function */
      code span.im { } /* Import */
      code span.in { color: #008000; } /* Information */
      code span.kw { color: #00607c; } /* Keyword */
      code span.op { color: #af1915; } /* Operator */
      code span.ot { } /* Other */
      code span.pp { color: #6f4e37; } /* Preprocessor */
      code span.re { } /* RegionMarker */
      code span.sc { color: #9f6807; } /* SpecialChar */
      code span.ss { color: #9f6807; } /* SpecialString */
      code span.st { color: #9f6807; } /* String */
      code span.va { } /* Variable */
      code span.vs { color: #9f6807; } /* VerbatimString */
      code span.wa { color: #008000; font-weight: bold; } /* Warning */
      code.diff {color: #898887}
      code.diff span.va {color: #006e28}
      code.diff span.st {color: #bf0303}
  </style>
  <style type="text/css">
body {
margin: 5em;
font-family: serif;

hyphens: auto;
line-height: 1.35;
text-align: justify;
}
@media screen and (max-width: 30em) {
body {
margin: 1.5em;
}
}
div.wrapper {
max-width: 60em;
margin: auto;
}
ul {
list-style-type: none;
padding-left: 2em;
margin-top: -0.2em;
margin-bottom: -0.2em;
}
a {
text-decoration: none;
color: #4183C4;
}
a.hidden_link {
text-decoration: none;
color: inherit;
}
li {
margin-top: 0.6em;
margin-bottom: 0.6em;
}
h1, h2, h3, h4 {
position: relative;
line-height: 1;
}
a.self-link {
position: absolute;
top: 0;
left: calc(-1 * (3.5rem - 26px));
width: calc(3.5rem - 26px);
height: 2em;
text-align: center;
border: none;
transition: opacity .2s;
opacity: .5;
font-family: sans-serif;
font-weight: normal;
font-size: 83%;
}
a.self-link:hover { opacity: 1; }
a.self-link::before { content: "§"; }
ul > li:before {
content: "\2014";
position: absolute;
margin-left: -1.5em;
}
:target { background-color: #C9FBC9; }
:target .codeblock { background-color: #C9FBC9; }
:target ul { background-color: #C9FBC9; }
.abbr_ref { float: right; }
.folded_abbr_ref { float: right; }
:target .folded_abbr_ref { display: none; }
:target .unfolded_abbr_ref { float: right; display: inherit; }
.unfolded_abbr_ref { display: none; }
.secnum { display: inline-block; min-width: 35pt; }
.header-section-number { display: inline-block; min-width: 35pt; }
.annexnum { display: block; }
div.sourceLinkParent {
float: right;
}
a.sourceLink {
position: absolute;
opacity: 0;
margin-left: 10pt;
}
a.sourceLink:hover {
opacity: 1;
}
a.itemDeclLink {
position: absolute;
font-size: 75%;
text-align: right;
width: 5em;
opacity: 0;
}
a.itemDeclLink:hover { opacity: 1; }
span.marginalizedparent {
position: relative;
left: -5em;
}
li span.marginalizedparent { left: -7em; }
li ul > li span.marginalizedparent { left: -9em; }
li ul > li ul > li span.marginalizedparent { left: -11em; }
li ul > li ul > li ul > li span.marginalizedparent { left: -13em; }
div.footnoteNumberParent {
position: relative;
left: -4.7em;
}
a.marginalized {
position: absolute;
font-size: 75%;
text-align: right;
width: 5em;
}
a.enumerated_item_num {
position: relative;
left: -3.5em;
display: inline-block;
margin-right: -3em;
text-align: right;
width: 3em;
}
div.para { margin-bottom: 0.6em; margin-top: 0.6em; text-align: justify; }
div.section { text-align: justify; }
div.sentence { display: inline; }
span.indexparent {
display: inline;
position: relative;
float: right;
right: -1em;
}
a.index {
position: absolute;
display: none;
}
a.index:before { content: "⟵"; }

a.index:target {
display: inline;
}
.indexitems {
margin-left: 2em;
text-indent: -2em;
}
div.itemdescr {
margin-left: 3em;
}
.bnf {
font-family: serif;
margin-left: 40pt;
margin-top: 0.5em;
margin-bottom: 0.5em;
}
.ncbnf {
font-family: serif;
margin-top: 0.5em;
margin-bottom: 0.5em;
margin-left: 40pt;
}
.ncsimplebnf {
font-family: serif;
font-style: italic;
margin-top: 0.5em;
margin-bottom: 0.5em;
margin-left: 40pt;
background: inherit; 
}
span.textnormal {
font-style: normal;
font-family: serif;
white-space: normal;
display: inline-block;
}
span.rlap {
display: inline-block;
width: 0px;
}
span.descr { font-style: normal; font-family: serif; }
span.grammarterm { font-style: italic; }
span.term { font-style: italic; }
span.terminal { font-family: monospace; font-style: normal; }
span.nonterminal { font-style: italic; }
span.tcode { font-family: monospace; font-style: normal; }
span.textbf { font-weight: bold; }
span.textsc { font-variant: small-caps; }
a.nontermdef { font-style: italic; font-family: serif; }
span.emph { font-style: italic; }
span.techterm { font-style: italic; }
span.mathit { font-style: italic; }
span.mathsf { font-family: sans-serif; }
span.mathrm { font-family: serif; font-style: normal; }
span.textrm { font-family: serif; }
span.textsl { font-style: italic; }
span.mathtt { font-family: monospace; font-style: normal; }
span.mbox { font-family: serif; font-style: normal; }
span.ungap { display: inline-block; width: 2pt; }
span.textit { font-style: italic; }
span.texttt { font-family: monospace; }
span.tcode_in_codeblock { font-family: monospace; font-style: normal; }
span.phantom { color: white; }

span.math { font-style: normal; }
span.mathblock {
display: block;
margin-left: auto;
margin-right: auto;
margin-top: 1.2em;
margin-bottom: 1.2em;
text-align: center;
}
span.mathalpha {
font-style: italic;
}
span.synopsis {
font-weight: bold;
margin-top: 0.5em;
display: block;
}
span.definition {
font-weight: bold;
display: block;
}
.codeblock {
margin-left: 1.2em;
line-height: 127%;
}
.outputblock {
margin-left: 1.2em;
line-height: 127%;
}
div.itemdecl {
margin-top: 2ex;
}
code.itemdeclcode {
white-space: pre;
display: block;
}
span.textsuperscript {
vertical-align: super;
font-size: smaller;
line-height: 0;
}
.footnotenum { vertical-align: super; font-size: smaller; line-height: 0; }
.footnote {
font-size: small;
margin-left: 2em;
margin-right: 2em;
margin-top: 0.6em;
margin-bottom: 0.6em;
}
div.minipage {
display: inline-block;
margin-right: 3em;
}
div.numberedTable {
text-align: center;
margin: 2em;
}
div.figure {
text-align: center;
margin: 2em;
}
table {
border: 1px solid black;
border-collapse: collapse;
margin-left: auto;
margin-right: auto;
margin-top: 0.8em;
text-align: left;
hyphens: none; 
}
td, th {
padding-left: 1em;
padding-right: 1em;
vertical-align: top;
}
td.empty {
padding: 0px;
padding-left: 1px;
}
td.left {
text-align: left;
}
td.right {
text-align: right;
}
td.center {
text-align: center;
}
td.justify {
text-align: justify;
}
td.border {
border-left: 1px solid black;
}
tr.rowsep, td.cline {
border-top: 1px solid black;
}
tr.even, tr.odd {
border-bottom: 1px solid black;
}
tr.capsep {
border-top: 3px solid black;
border-top-style: double;
}
tr.header {
border-bottom: 3px solid black;
border-bottom-style: double;
}
th {
border-bottom: 1px solid black;
}
span.centry {
font-weight: bold;
}
div.table {
display: block;
margin-left: auto;
margin-right: auto;
text-align: center;
width: 90%;
}
span.indented {
display: block;
margin-left: 2em;
margin-bottom: 1em;
margin-top: 1em;
}
ol.enumeratea { list-style-type: none; background: inherit; }
ol.enumerate { list-style-type: none; background: inherit; }

code.sourceCode > span { display: inline; }
</style>
  <link href="data:image/x-icon;base64,AAABAAIAEBAAAAEAIABoBAAAJgAAACAgAAABACAAqBAAAI4EAAAoAAAAEAAAACAAAAABACAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA////AIJEAACCRAAAgkQAAIJEAACCRAAAgkQAVoJEAN6CRADegkQAWIJEAACCRAAAgkQAAIJEAACCRAAA////AP///wCCRAAAgkQAAIJEAACCRAAsgkQAvoJEAP+CRAD/gkQA/4JEAP+CRADAgkQALoJEAACCRAAAgkQAAP///wD///8AgkQAAIJEABSCRACSgkQA/IJEAP99PQD/dzMA/3czAP99PQD/gkQA/4JEAPyCRACUgkQAFIJEAAD///8A////AHw+AFiBQwDqgkQA/4BBAP9/PxP/uZd6/9rJtf/bybX/upd7/39AFP+AQQD/gkQA/4FDAOqAQgBc////AP///wDKklv4jlEa/3o7AP+PWC//8+3o///////////////////////z7un/kFox/35AAP+GRwD/mVYA+v///wD///8A0Zpk+NmibP+0d0T/8evj///////+/fv/1sKz/9bCs//9/fr//////+/m2/+NRwL/nloA/5xYAPj///8A////ANKaZPjRmGH/5cKh////////////k149/3UwAP91MQD/lmQ//86rhv+USg3/m1YA/5hSAP+bVgD4////AP///wDSmmT4zpJY/+/bx///////8+TV/8mLT/+TVx//gkIA/5lVAP+VTAD/x6B//7aEVv/JpH7/s39J+P///wD///8A0ppk+M6SWP/u2sf///////Pj1f/Nj1T/2KFs/8mOUv+eWhD/lEsA/8aee/+0glT/x6F7/7J8Rvj///8A////ANKaZPjRmGH/48Cf///////+/v7/2qt//82PVP/OkFX/37KJ/86siv+USg7/mVQA/5hRAP+bVgD4////AP///wDSmmT40ppk/9CVXP/69O////////7+/v/x4M//8d/P//7+/f//////9u7n/6tnJf+XUgD/nFgA+P///wD///8A0ppk+NKaZP/RmWL/1qNy//r07///////////////////////+vXw/9akdP/Wnmn/y5FY/6JfFvj///8A////ANKaZFTSmmTo0ppk/9GYYv/Ql1//5cWm//Hg0P/x4ND/5cWm/9GXYP/RmGH/0ppk/9KaZOjVnmpY////AP///wDSmmQA0ppkEtKaZI7SmmT60ppk/9CWX//OkVb/zpFW/9CWX//SmmT/0ppk/NKaZJDSmmQS0ppkAP///wD///8A0ppkANKaZADSmmQA0ppkKtKaZLrSmmT/0ppk/9KaZP/SmmT/0ppkvNKaZCrSmmQA0ppkANKaZAD///8A////ANKaZADSmmQA0ppkANKaZADSmmQA0ppkUtKaZNzSmmTc0ppkVNKaZADSmmQA0ppkANKaZADSmmQA////AP5/AAD4HwAA4AcAAMADAACAAQAAgAEAAIABAACAAQAAgAEAAIABAACAAQAAgAEAAMADAADgBwAA+B8AAP5/AAAoAAAAIAAAAEAAAAABACAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA////AP///wCCRAAAgkQAAIJEAACCRAAAgkQAAIJEAACCRAAAgkQAAIJEAACCRAAAgkQAAIJEAAyCRACMgkQA6oJEAOqCRACQgkQAEIJEAACCRAAAgkQAAIJEAACCRAAAgkQAAIJEAACCRAAAgkQAAIJEAACCRAAA////AP///wD///8A////AIJEAACCRAAAgkQAAIJEAACCRAAAgkQAAIJEAACCRAAAgkQAAIJEAACCRABigkQA5oJEAP+CRAD/gkQA/4JEAP+CRADqgkQAZoJEAACCRAAAgkQAAIJEAACCRAAAgkQAAIJEAACCRAAAgkQAAIJEAAD///8A////AP///wD///8AgkQAAIJEAACCRAAAgkQAAIJEAACCRAAAgkQAAIJEAACCRAA4gkQAwoJEAP+CRAD/gkQA/4JEAP+CRAD/gkQA/4JEAP+CRAD/gkQAxIJEADyCRAAAgkQAAIJEAACCRAAAgkQAAIJEAACCRAAAgkQAAP///wD///8A////AP///wCCRAAAgkQAAIJEAACCRAAAgkQAAIJEAACCRAAWgkQAmIJEAP+CRAD/gkQA/4JEAP+CRAD/gkQA/4JEAP+CRAD/gkQA/4JEAP+CRAD/gkQA/4JEAJyCRAAYgkQAAIJEAACCRAAAgkQAAIJEAACCRAAA////AP///wD///8A////AIJEAACCRAAAgkQAAIJEAACCRAAAgkQAdIJEAPCCRAD/gkQA/4JEAP+CRAD/gkQA/4JEAP+CRAD/gkQA/4JEAP+CRAD/gkQA/4JEAP+CRAD/gkQA/4JEAPSCRAB4gkQAAIJEAACCRAAAgkQAAIJEAAD///8A////AP///wD///8AgkQAAIJEAACCRAAAgkQASoJEANKCRAD/gkQA/4JEAP+CRAD/g0YA/39AAP9zLgD/bSQA/2shAP9rIQD/bSQA/3MuAP9/PwD/g0YA/4JEAP+CRAD/gkQA/4JEAP+CRADUgkQAToJEAACCRAAAgkQAAP///wD///8A////AP///wB+PwAAgkUAIoJEAKiCRAD/gkQA/4JEAP+CRAD/hEcA/4BBAP9sIwD/dTAA/5RfKv+viF7/vp56/76ee/+wiF7/lWAr/3YxAP9sIwD/f0AA/4RHAP+CRAD/gkQA/4JEAP+CRAD/gkQArIJEACaBQwAA////AP///wD///8A////AIBCAEBzNAD6f0EA/4NFAP+CRAD/gkQA/4VIAP92MwD/bSUA/6N1Tv/ezsL/////////////////////////////////38/D/6V3Uv9uJgD/dTEA/4VJAP+CRAD/gkQA/4JEAP+BQwD/fUAA/4FDAEj///8A////AP///wD///8AzJRd5qBlKf91NgD/dDUA/4JEAP+FSQD/cy4A/3YyAP/PuKP//////////////////////////////////////////////////////9K7qP94NQD/ciwA/4VJAP+CRAD/fkEA/35BAP+LSwD/mlYA6v///wD///8A////AP///wDdpnL/4qx3/8KJUv+PUhf/cTMA/3AsAP90LgD/4dK+/////////////////////////////////////////////////////////////////+TYxf91MAD/dTIA/31CAP+GRwD/llQA/6FcAP+gWwD8////AP///wD///8A////ANGZY/LSm2X/4ap3/92mcP+wdT3/byQA/8mwj////////////////////////////////////////////////////////////////////////////+LYxv9zLgP/jUoA/59bAP+hXAD/nFgA/5xYAPL///8A////AP///wD///8A0ppk8tKaZP/RmWL/1p9q/9ubXv/XqXj////////////////////////////7+fD/vZyG/6BxS/+gcUr/vJuE//r37f//////////////////////3MOr/5dQBf+dVQD/nVkA/5xYAP+cWAD/nFgA8v///wD///8A////AP///wDSmmTy0ppk/9KaZP/SmWP/yohJ//jo2P//////////////////////4NTG/4JDFf9lGAD/bSQA/20kAP9kGAD/fz8S/+Xb0f//////5NG9/6txN/+LOgD/m1QA/51aAP+cWAD/m1cA/5xYAP+cWADy////AP///wD///8A////ANKaZPLSmmT/0ppk/8+TWf/Unmv//v37//////////////////////+TWRr/VwsA/35AAP+ERgD/g0UA/4JGAP9lHgD/kFga/8KXX/+TRwD/jT4A/49CAP+VTQD/n10A/5xYAP+OQQD/lk4A/55cAPL///8A////AP///wD///8A0ppk8tKaZP/SmmT/y4tO/92yiP//////////////////////8NnE/8eCQP+rcTT/ez0A/3IyAP98PgD/gEMA/5FSAP+USwD/jj8A/5lUAP+JNwD/yqV2/694Mf+HNQD/jkAA/82rf/+laBj/jT4A8v///wD///8A////AP///wDSmmTy0ppk/9KaZP/LiUr/4byY///////////////////////gupX/0I5P/+Wuev/Lklz/l1sj/308AP+QSwD/ol0A/59aAP+aVQD/k0oA/8yoh///////+fXv/6pwO//Lp3v///////Pr4f+oay7y////AP///wD///8A////ANKaZPLSmmT/0ppk/8uJSv/hvJj//////////////////////+G7l//Jhkb/0ppk/96nc//fqXX/x4xO/6dkFP+QSQD/llEA/5xXAP+USgD/yaOA///////38uv/qG05/8ijdv//////8efb/6ZpLPL///8A////AP///wD///8A0ppk8tKaZP/SmmT/zIxO/9yxh///////////////////////7dbA/8iEQf/Sm2X/0Zlj/9ScZv/eqHf/2KJv/7yAQf+XTgD/iToA/5lSAP+JNgD/yKFv/611LP+HNQD/jT8A/8qmeP+kZRT/jT4A8v///wD///8A////AP///wDSmmTy0ppk/9KaZP/Pk1n/1J5q//78+//////////////////+/fv/1aFv/8iEQv/Tm2b/0ppl/9GZY//Wn2z/1pZc/9eldf/Bl2b/kUcA/4w9AP+OQAD/lUwA/59eAP+cWQD/jT8A/5ZOAP+eXADy////AP///wD///8A////ANKaZPLSmmT/0ppk/9KZY//KiEn/8d/P///////////////////////47+f/05tm/8iCP//KiEj/yohJ/8eCP//RmGH//vfy///////n1sP/rXQ7/4k4AP+TTAD/nVoA/5xYAP+cVwD/nFgA/5xYAPL///8A////AP///wD///8A0ppk8tKaZP/SmmT/0ptl/8uLTf/aq37////////////////////////////+/fz/6c2y/961jv/etY7/6Myx//78+v//////////////////////3MWv/5xXD/+ORAD/mFQA/51ZAP+cWAD/nFgA8v///wD///8A////AP///wDSmmTy0ppk/9KaZP/SmmT/0ppk/8mFRP/s1b//////////////////////////////////////////////////////////////////////////////+PD/0JFU/7NzMv+WUQD/kUsA/5tXAP+dWQDy////AP///wD///8A////ANKaZP/SmmT/0ppk/9KaZP/Sm2X/z5NZ/8yMT//z5NX/////////////////////////////////////////////////////////////////9Ofa/8yNUP/UmGH/36p5/8yTWv+qaSD/kksA/5ROAPz///8A////AP///wD///8A0ppk5NKaZP/SmmT/0ppk/9KaZP/TnGf/zY9T/82OUv/t1sD//////////////////////////////////////////////////////+7Yw//OkFX/zI5R/9OcZ//SmmP/26V0/9ymdf/BhUf/ol8R6P///wD///8A////AP///wDSmmQ80ppk9tKaZP/SmmT/0ppk/9KaZP/TnGj/zpFW/8qJSv/dson/8uHS//////////////////////////////////Lj0//etIv/y4lL/86QVf/TnGj/0ppk/9KaZP/RmWP/05xn/9ymdfjUnWdC////AP///wD///8A////ANKaZADSmmQc0ppkotKaZP/SmmT/0ppk/9KaZP/Tm2b/0Zli/8qJSf/NjlH/16Z3/+G8mP/myKr/5siq/+G8mP/Xp3f/zY5S/8qISf/RmGH/05tm/9KaZP/SmmT/0ppk/9KaZP/SmmSm0pljINWdaQD///8A////AP///wD///8A0ppkANKaZADSmmQA0ppkQtKaZMrSmmT/0ppk/9KaZP/SmmT/0ptl/9GYYf/Nj1P/y4lL/8qISP/KiEj/y4lK/82PU//RmGH/0ptl/9KaZP/SmmT/0ppk/9KaZP/SmmTO0ppkRtKaZADSmmQA0ppkAP///wD///8A////AP///wDSmmQA0ppkANKaZADSmmQA0ppkANKaZGzSmmTu0ppk/9KaZP/SmmT/0ppk/9KaZP/SmmT/0ppk/9KaZP/SmmT/0ppk/9KaZP/SmmT/0ppk/9KaZP/SmmTw0ppkcNKaZADSmmQA0ppkANKaZADSmmQA////AP///wD///8A////ANKaZADSmmQA0ppkANKaZADSmmQA0ppkANKaZBLSmmSQ0ppk/9KaZP/SmmT/0ppk/9KaZP/SmmT/0ppk/9KaZP/SmmT/0ppk/9KaZP/SmmT/0ppklNKaZBTSmmQA0ppkANKaZADSmmQA0ppkANKaZAD///8A////AP///wD///8A0ppkANKaZADSmmQA0ppkANKaZADSmmQA0ppkANKaZADSmmQy0ppkutKaZP/SmmT/0ppk/9KaZP/SmmT/0ppk/9KaZP/SmmT/0ppkvtKaZDbSmmQA0ppkANKaZADSmmQA0ppkANKaZADSmmQA0ppkAP///wD///8A////AP///wDSmmQA0ppkANKaZADSmmQA0ppkANKaZADSmmQA0ppkANKaZADSmmQA0ppkXNKaZODSmmT/0ppk/9KaZP/SmmT/0ppk5NKaZGDSmmQA0ppkANKaZADSmmQA0ppkANKaZADSmmQA0ppkANKaZADSmmQA////AP///wD///8A////ANKaZADSmmQA0ppkANKaZADSmmQA0ppkANKaZADSmmQA0ppkANKaZADSmmQA0ppkBtKaZIbSmmTo0ppk6tKaZIrSmmQK0ppkANKaZADSmmQA0ppkANKaZADSmmQA0ppkANKaZADSmmQA0ppkANKaZAD///8A////AP/8P///+B///+AH//+AAf//AAD//AAAP/AAAA/gAAAHwAAAA8AAAAPAAAADwAAAA8AAAAPAAAADwAAAA8AAAAPAAAADwAAAA8AAAAPAAAADwAAAA8AAAAPAAAADwAAAA+AAAAfwAAAP/AAAP/8AAP//gAH//+AH///4H////D//" rel="icon" />
  
  <!--[if lt IE 9]>
    <script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv-printshiv.min.js"></script>
  <![endif]-->
</head>
<body>
<div class="wrapper">
<header id="title-block-header">
<h1 class="title" style="text-align:center">A New Approach For Compiling
C++</h1>
<table style="border:none;float:right">
  <tr>
    <td>Document #:</td>
    <td>D1371R4</td>
  </tr>
  <tr>
    <td>Date:</td>
    <td>2023-09-19</td>
  </tr>
  <tr>
    <td style="vertical-align:top">Project:</td>
    <td>Programming Language C++</td>
  </tr>
  <tr>
    <td style="vertical-align:top">Audience:</td>
    <td>
      SG15<br>
    </td>
  </tr>
  <tr>
    <td style="vertical-align:top">Reply-to:</td>
    <td>
      HassanSajjad<br>&lt;<a href="mailto:hassan.sajjad069@gmail.com" class="email">hassan.sajjad069@gmail.com</a>&gt;<br>
    </td>
  </tr>
</table>
</header>
<div style="clear:both">
<div id="TOC" role="doc-toc">
<h1 id="toctitle">Contents</h1>
<ul>
<li><a href="#abstract" id="toc-abstract"><span class="toc-section-number">1</span> Abstract<span></span></a></li>
<li><a href="#changes" id="toc-changes"><span class="toc-section-number">2</span> Changes<span></span></a>
<ul>
<li><a href="#r0-initial" id="toc-r0-initial"><span class="toc-section-number">2.1</span> R0 (Initial)<span></span></a></li>
</ul></li>
<li><a href="#introduction" id="toc-introduction"><span class="toc-section-number">3</span> Introduction<span></span></a></li>
<li><a href="#motivation-and-scope" id="toc-motivation-and-scope"><span class="toc-section-number">4</span> Motivation and
Scope<span></span></a>
<ul>
<li><a href="#why-is-this-faster" id="toc-why-is-this-faster"><span class="toc-section-number">4.1</span> Why is this
faster<span></span></a></li>
<li><a href="#how-much-faster-this-could-be" id="toc-how-much-faster-this-could-be"><span class="toc-section-number">4.2</span> How much faster this could
be?<span></span></a></li>
</ul></li>
<li><a href="#impact-on-the-standard" id="toc-impact-on-the-standard"><span class="toc-section-number">5</span> Impact On the
Standard<span></span></a></li>
<li><a href="#design-decisions" id="toc-design-decisions"><span class="toc-section-number">6</span> Design Decisions<span></span></a>
<ul>
<li><a href="#section" id="toc-section"><span class="toc-section-number">6.0.1</span> <span></span></a></li>
<li><a href="#what-are-the-tradeoffs" id="toc-what-are-the-tradeoffs"><span class="toc-section-number">6.1</span> What are the
tradeoffs?<span></span></a></li>
<li><a href="#consequences-of-this-choice-for-the-current-build-systems" id="toc-consequences-of-this-choice-for-the-current-build-systems"><span class="toc-section-number">6.2</span> Consequences of this choice for
the current build systems<span></span></a></li>
</ul></li>
<li><a href="#technical-specifications" id="toc-technical-specifications"><span class="toc-section-number">7</span> Technical
Specifications<span></span></a></li>
<li><a href="#acknowledgements" id="toc-acknowledgements"><span class="toc-section-number">8</span>
Acknowledgements<span></span></a></li>
<li><a href="#references" id="toc-references"><span class="toc-section-number">9</span> References<span></span></a></li>
<li><a href="#motivation" id="toc-motivation"><span class="toc-section-number">10</span> Motivation<span></span></a></li>
<li><a href="#history" id="toc-history"><span class="toc-section-number">11</span> History<span></span></a></li>
<li><a href="#comparison-tables" id="toc-comparison-tables"><span class="toc-section-number">12</span> Comparison Tables<span></span></a>
<ul>
<li><a href="#matching-integrals" id="toc-matching-integrals"><span class="toc-section-number">12.1</span> Matching
Integrals<span></span></a></li>
<li><a href="#matching-strings" id="toc-matching-strings"><span class="toc-section-number">12.2</span> Matching
Strings<span></span></a></li>
<li><a href="#matching-tuples" id="toc-matching-tuples"><span class="toc-section-number">12.3</span> Matching
Tuples<span></span></a></li>
<li><a href="#matching-variants" id="toc-matching-variants"><span class="toc-section-number">12.4</span> Matching
Variants<span></span></a></li>
<li><a href="#matching-polymorphic-types" id="toc-matching-polymorphic-types"><span class="toc-section-number">12.5</span> Matching Polymorphic
Types<span></span></a></li>
<li><a href="#evaluating-expression-trees" id="toc-evaluating-expression-trees"><span class="toc-section-number">12.6</span> Evaluating Expression
Trees<span></span></a></li>
<li><a href="#nested-structured-bindings" id="toc-nested-structured-bindings"><span class="toc-section-number">12.7</span> Nested Structured
Bindings<span></span></a></li>
<li><a href="#pattern-matching-in-declarations" id="toc-pattern-matching-in-declarations"><span class="toc-section-number">12.8</span> Pattern Matching in
Declarations<span></span></a></li>
</ul></li>
<li><a href="#design-overview" id="toc-design-overview"><span class="toc-section-number">13</span> Design Overview<span></span></a>
<ul>
<li><a href="#basic-syntax" id="toc-basic-syntax"><span class="toc-section-number">13.1</span> Basic
Syntax<span></span></a></li>
<li><a href="#basic-model" id="toc-basic-model"><span class="toc-section-number">13.2</span> Basic Model<span></span></a></li>
<li><a href="#types-of-patterns" id="toc-types-of-patterns"><span class="toc-section-number">13.3</span> Types of
Patterns<span></span></a>
<ul>
<li><a href="#primary-patterns" id="toc-primary-patterns"><span class="toc-section-number">13.3.1</span> Primary
Patterns<span></span></a></li>
<li><a href="#compound-patterns" id="toc-compound-patterns"><span class="toc-section-number">13.3.2</span> Compound
Patterns<span></span></a></li>
</ul></li>
<li><a href="#pattern-guard" id="toc-pattern-guard"><span class="toc-section-number">13.4</span> Pattern
Guard<span></span></a></li>
<li><a href="#match-constexpr" id="toc-match-constexpr"><span class="toc-section-number">13.5</span>
<code class="sourceCode default">match constexpr</code><span></span></a></li>
<li><a href="#exhaustiveness-and-usefulness" id="toc-exhaustiveness-and-usefulness"><span class="toc-section-number">13.6</span> Exhaustiveness and
Usefulness<span></span></a></li>
<li><a href="#refutability" id="toc-refutability"><span class="toc-section-number">13.7</span>
Refutability<span></span></a></li>
</ul></li>
<li><a href="#proposed-wording" id="toc-proposed-wording"><span class="toc-section-number">14</span> Proposed
Wording<span></span></a></li>
<li><a href="#design-decisions-1" id="toc-design-decisions-1"><span class="toc-section-number">15</span> Design Decisions<span></span></a>
<ul>
<li><a href="#wildcard-pattern-1" id="toc-wildcard-pattern-1"><span class="toc-section-number">15.1</span> Wildcard
Pattern<span></span></a></li>
<li><a href="#extending-structured-bindings-declaration" id="toc-extending-structured-bindings-declaration"><span class="toc-section-number">15.2</span> Extending Structured Bindings
Declaration<span></span></a></li>
<li><a href="#inspect-rather-than-switch" id="toc-inspect-rather-than-switch"><span class="toc-section-number">15.3</span>
<code class="sourceCode default">inspect</code> rather than
<code class="sourceCode default">switch</code><span></span></a></li>
<li><a href="#first-match-rather-than-best-match" id="toc-first-match-rather-than-best-match"><span class="toc-section-number">15.4</span> First Match rather than Best
Match<span></span></a></li>
<li><a href="#unrestricted-side-effects" id="toc-unrestricted-side-effects"><span class="toc-section-number">15.5</span> Unrestricted Side
Effects<span></span></a></li>
<li><a href="#language-rather-than-library" id="toc-language-rather-than-library"><span class="toc-section-number">15.6</span> Language rather than
Library<span></span></a></li>
<li><a href="#matchers-and-extractors" id="toc-matchers-and-extractors"><span class="toc-section-number">15.7</span> Matchers and
Extractors<span></span></a></li>
<li><a href="#expression-vs-pattern-disambiguation" id="toc-expression-vs-pattern-disambiguation"><span class="toc-section-number">15.8</span> Expression vs Pattern
Disambiguation<span></span></a></li>
<li><a href="#forbid-break-inside-inspect-expression" id="toc-forbid-break-inside-inspect-expression"><span class="toc-section-number">15.9</span> Forbid
<code class="sourceCode default">break</code> inside
<code class="sourceCode default">inspect</code>
expression<span></span></a></li>
</ul></li>
<li><a href="#runtime-performance" id="toc-runtime-performance"><span class="toc-section-number">16</span> Runtime
Performance<span></span></a>
<ul>
<li><a href="#structured-binding-patterns" id="toc-structured-binding-patterns"><span class="toc-section-number">16.1</span> Structured Binding
Patterns<span></span></a></li>
<li><a href="#alternative-patterns" id="toc-alternative-patterns"><span class="toc-section-number">16.2</span> Alternative
Patterns<span></span></a></li>
<li><a href="#open-class-hierarchy" id="toc-open-class-hierarchy"><span class="toc-section-number">16.3</span> Open Class
Hierarchy<span></span></a></li>
</ul></li>
<li><a href="#examples" id="toc-examples"><span class="toc-section-number">17</span> Examples<span></span></a>
<ul>
<li><a href="#predicate-based-discriminator" id="toc-predicate-based-discriminator"><span class="toc-section-number">17.1</span> Predicate-based
Discriminator<span></span></a></li>
<li><a href="#closed-class-hierarchy" id="toc-closed-class-hierarchy"><span class="toc-section-number">17.2</span> “Closed” Class
Hierarchy<span></span></a></li>
<li><a href="#matcher-any_of" id="toc-matcher-any_of"><span class="toc-section-number">17.3</span> Matcher:
<code class="sourceCode default">any_of</code><span></span></a></li>
<li><a href="#matcher-within" id="toc-matcher-within"><span class="toc-section-number">17.4</span> Matcher:
<code class="sourceCode default">within</code><span></span></a></li>
<li><a href="#extractor-both" id="toc-extractor-both"><span class="toc-section-number">17.5</span> Extractor:
<code class="sourceCode default">both</code><span></span></a></li>
<li><a href="#extractor-at" id="toc-extractor-at"><span class="toc-section-number">17.6</span> Extractor:
<code class="sourceCode default">at</code><span></span></a></li>
<li><a href="#red-black-tree-rebalancing" id="toc-red-black-tree-rebalancing"><span class="toc-section-number">17.7</span> Red-black Tree
Rebalancing<span></span></a></li>
</ul></li>
<li><a href="#future-work" id="toc-future-work"><span class="toc-section-number">18</span> Future Work<span></span></a>
<ul>
<li><a href="#language-support-for-variant" id="toc-language-support-for-variant"><span class="toc-section-number">18.1</span> Language Support for
Variant<span></span></a></li>
<li><a href="#note-on-ranges" id="toc-note-on-ranges"><span class="toc-section-number">18.2</span> Note on
Ranges<span></span></a></li>
</ul></li>
<li><a href="#acknowledgements-1" id="toc-acknowledgements-1"><span class="toc-section-number">19</span>
Acknowledgements<span></span></a></li>
<li><a href="#bibliography" id="toc-bibliography"><span class="toc-section-number">20</span> References<span></span></a></li>
</ul>
</div>
<h1 data-number="1" id="abstract"><span class="header-section-number">1</span> Abstract<a href="#abstract" class="self-link"></a></h1>
<p>This paper specifies the API for the interaction between the build
system and the compiler where the compiler is available as a shared
library. This results in better compilation speed.</p>
<h1 data-number="2" id="changes"><span class="header-section-number">2</span> Changes<a href="#changes" class="self-link"></a></h1>
<h2 data-number="2.1" id="r0-initial"><span class="header-section-number">2.1</span> R0 (Initial)<a href="#r0-initial" class="self-link"></a></h2>
<h1 data-number="3" id="introduction"><span class="header-section-number">3</span> Introduction<a href="#introduction" class="self-link"></a></h1>
<p>A very brief high level view of your proposal, understandable by C++
committee members who are not necessarily experts in whatever domain you
are addressing.</p>
<p>Today, almost all compilation happens by user or build system
invoking the compiler executable. This paper proposes for the
availability of the compiler as a shared library. Both the compiler
executable and the compiler shared library can co-exist. The build tool
can then interact with the shared library with the API specified in this
paper. Compared to the current approach, this will result in faster
compilation speed, close to 25 - 40 % in some cases.</p>
<h1 data-number="4" id="motivation-and-scope"><span class="header-section-number">4</span> Motivation and Scope<a href="#motivation-and-scope" class="self-link"></a></h1>
<p>Why is this important? What kinds of problems does it address? What
is the intended user community? What level of programmers (novice,
experienced, expert) is it intended to support? What existing practice
is it based on? How widespread is its use? How long has it been in use?
Is there a reference implementation and test suite available for
inspection?</p>
<p>Most operating systems today support dynamic loading of the shared
library. By making compiler a shared library, we can achieve faster
build speeds.</p>
<h2 data-number="4.1" id="why-is-this-faster"><span class="header-section-number">4.1</span> Why is this faster<a href="#why-is-this-faster" class="self-link"></a></h2>
<ol type="i">
<li><p>API allows the build system to intercept the files read by the
compiler. So, the compilation of multiple compilation units can use the
same cached file.</p></li>
<li><p>Module files need to be scanned to determine the dependencies of
the file. Only after that the files could be compiled in order. In this
approach, the scanning is not needed.</p></li>
</ol>
<h2 data-number="4.2" id="how-much-faster-this-could-be"><span class="header-section-number">4.2</span> How much faster this could
be?<a href="#how-much-faster-this-could-be" class="self-link"></a></h2>
<p>Tests conducted imitating real world scenarios revealed that it could
be <code class="sourceCode default">25 - 40 %</code> faster <a href="https://github.com/HassanSajjad-302/solution5">https://github.com/HassanSajjad-302/solution5</a>.</p>
<p>Tests were performed with C++20 MSVC compiler on Windows 11 operating
system on modern hardware at the time of writing. Repositories used
include SFML and LLVM.</p>
<p>The highlights include.</p>
<ol type="i">
<li><p>Estimated scanning time percent of the total compilation time
(scanning time + compilation time) per compilation unit for LLVM is
<code class="sourceCode default">8.46%</code>.</p></li>
<li><p>SFML was compiled with C++20 header units. Because compilation
became faster, the scanning time took a larger proportion of the total
time. Scanning took <code class="sourceCode default">25.72%</code> of
the total compilation time. For few files scanning was actually slower
than compilation.</p></li>
<li><p>Estimated average scanning time for the project LLVM was
<code class="sourceCode default">217.9ms</code>. For some files it was
more than <code class="sourceCode default">400ms</code>.</p></li>
<li><p>On average the LLVM source file includes
<code class="sourceCode default">400</code> header files.
<code class="sourceCode default">3598</code> unique header files are
read from the disk while compiling
<code class="sourceCode default">2854</code> source files. If LLVM is
built with C++20 modules, there will be
<code class="sourceCode default">2854 + 3598</code> process launches
instead of <code class="sourceCode default">2854</code>. Few compilers
use <code class="sourceCode default">two phase</code> model instead of
<code class="sourceCode default">one phase</code>. Described here <a href="https://gitlab.kitware.com/cmake/cmake/-/issues/18355#note_1329192">https://gitlab.kitware.com/cmake/cmake/-/issues/18355#note_1329192</a>.
In such a case, there will be
<code class="sourceCode default">2854 + (2 * 3598)</code> process
launches instead of <code class="sourceCode default">2854</code>. By
avoiding these costs of process setup and file reads should result in
<code class="sourceCode default">1 - 2 %</code> compilation speed-up in
a clean build in the project size of LLVM.</p></li>
</ol>
<h1 data-number="5" id="impact-on-the-standard"><span class="header-section-number">5</span> Impact On the Standard<a href="#impact-on-the-standard" class="self-link"></a></h1>
<p>What other library components does does it depend on, and what
depends on it? Is it a pure extension, or does it require changes to
standard components? Can it be implemented using current C++ compilers
and libraries, or does it require language or library features that are
not part of C++ today?</p>
<h1 data-number="6" id="design-decisions"><span class="header-section-number">6</span> Design Decisions<a href="#design-decisions" class="self-link"></a></h1>
<h3 data-number="6.0.1" id="section"><span class="header-section-number">6.0.1</span> <a href="#section" class="self-link"></a></h3>
<p>Why did you choose the specific design that you did? What
alternatives did you consider, and what are the tradeoffs? What are the
consequences of your choice, for users and implementers? What decisions
are left up to implementers? If there are any similar libraries in use,
how do their design decisions compare to yours?</p>
<h2 data-number="6.1" id="what-are-the-tradeoffs"><span class="header-section-number">6.1</span> What are the tradeoffs?<a href="#what-are-the-tradeoffs" class="self-link"></a></h2>
<p>Memory consumption of such an approach could be higher than the
current approach. That is because more
<code class="sourceCode default">compilerState</code> and the cached
files need to be kept in the memory.</p>
<p>However, this can be alleviated by the following:</p>
<p>Few build systems generally group files together in a
<code class="sourceCode default">target</code>. A
<code class="sourceCode default">target</code> can depend on one or more
other <code class="sourceCode default">target</code>. Such build systems
can alleviate the higher memory consumption by ordering the compilation
of files of the dependency before the dependent target. This way only
the <code class="sourceCode default">compileState</code> of the files of
the dependency target need to be kept in the memory.
<code class="sourceCode default">compilerState</code> of the files of
the dependent target only come in the picture once the dependent target
files are compiled. ifcfile of a
<code class="sourceCode default">target</code> are kept in the memory
until there is no file of any dependent target left to be compiled. At
which point, this is cleared from the memory.</p>
<p>In case the similar file is being read by multiple compilations, the
memory consumption could be a little less than the current approach.
Because all such compilations can use one cached read instead of reading
themselves.</p>
<h2 data-number="6.2" id="consequences-of-this-choice-for-the-current-build-systems"><span class="header-section-number">6.2</span> Consequences of this choice for
the current build systems<a href="#consequences-of-this-choice-for-the-current-build-systems" class="self-link"></a></h2>
<p>This proposal does not impact the current build systems in any way.
Few build systems, however, might need non-trivial changes to support
this. Plans for supporting this in the build system HMake are described
here: <a href="https://lists.isocpp.org/sg15/att-2033/Analysis.pdf">https://lists.isocpp.org/sg15/att-2033/Analysis.pdf</a></p>
<h1 data-number="7" id="technical-specifications"><span class="header-section-number">7</span> Technical Specifications<a href="#technical-specifications" class="self-link"></a></h1>
<p>The committee needs technical specifications to be able to fully
evaluate your proposal. Eventually these technical specifications will
have to be in the form of full text for the standard or technical
report, often known as “Standardese”, but for an initial proposal there
are several possibilities:</p>
<p>Provide some limited technical documentation. This might be OK for a
very simple proposal such as a single function, but for anything beyond
that the committee will likely ask for more detail. Provide technical
documentation that is complete enough to fully evaluate your proposal.
This documentation can be in the proposal itself or you can provide a
link to documentation available on the web. If the committee likes your
proposal, they will ask for a revised proposal with formal standardese
wording. The committee recognizes that writing the formal ISO
specification for a library component can be daunting and will make
additional information and help available to get you started. Provide
full “Standardese.” A standard is a contract between implementers and
users, to make it possible for users to write portable code with
specified semantics. It says what implementers are permitted to do, what
they are required to do, and what users can and can’t count on. The
“standardese” should match the general style of exposition of the
standard, and the specific rules set out in the Specification Style
Guidelines, but it does not have to match the exact margins or fonts or
section numbering; those things will all be changed anyway if the
proposal gets accepted into the working draft for the next C++
standard.</p>
<p>Instead of an executable, the compiler could be a shared-library. Or
there could be a separate driver supporting the functionality described
here. Compilation pause and resume capability needs to be built into the
compiler. HMake loads this driver dll or the compiler dll. Now it calls
the following symbols <code class="sourceCode default">newCompile</code>
and <code class="sourceCode default">resumeCompile</code>.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="kw">struct</span> String</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> <span class="dt">char</span> <span class="op">*</span>ptr;</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">unsigned</span> <span class="dt">long</span> size;</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="op">}</span>;</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="co">// Those char pointers that are pointing to the path are platform dependent i.e. whcar_t* in-case of Windows</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="kw">struct</span> CompileOutput</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>    <span class="co">// if (!completed &amp;&amp; !errorOccurred), then pointer to the compiler state to be preserved by the build-system, else</span></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>    <span class="co">// nullptr</span></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>    <span class="dt">void</span> <span class="op">*</span>compilerState;</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>    <span class="co">// if (completed || errorOccurred), then compiler output and errorOutput, else nullptr</span></span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>    String stdout;</span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a>    String stderr;</span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a>    <span class="co">// if (!completed &amp;&amp; !errorOccurred), then the header-unit path the compiler is waiting on if any,</span></span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a>    <span class="co">// else if(completed &amp;&amp; !errorOccurred), then the pointer to the returned ifcFile if any, else</span></span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a>    <span class="co">// nullptr</span></span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a>    String ifcFileOrHeaderUnitPath;</span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a>    <span class="co">// if (!completed &amp;&amp; !errorOccurred), then the name of the module the compiler is waiting on if any,</span></span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a>    <span class="co">// else if(completed &amp;&amp; !errorOccurred), then the pointer to the returned objectFile if any, else</span></span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a>    <span class="co">// nullptr</span></span>
<span id="cb1-26"><a href="#cb1-26" aria-hidden="true" tabindex="-1"></a>    String objectFileOrModuleName;</span>
<span id="cb1-27"><a href="#cb1-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-28"><a href="#cb1-28" aria-hidden="true" tabindex="-1"></a>    <span class="co">// if completed == true, then the logicalName of exported module if any.</span></span>
<span id="cb1-29"><a href="#cb1-29" aria-hidden="true" tabindex="-1"></a>    String logicalName;</span>
<span id="cb1-30"><a href="#cb1-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-31"><a href="#cb1-31" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Following is the array size, next is the array of header-includes.</span></span>
<span id="cb1-32"><a href="#cb1-32" aria-hidden="true" tabindex="-1"></a>    <span class="dt">unsigned</span> <span class="dt">long</span> headerIncludesCount;</span>
<span id="cb1-33"><a href="#cb1-33" aria-hidden="true" tabindex="-1"></a>    String <span class="op">*</span>headerIncludes;</span>
<span id="cb1-34"><a href="#cb1-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-35"><a href="#cb1-35" aria-hidden="true" tabindex="-1"></a>    <span class="co">// true if compilation succeeded, false otherwise</span></span>
<span id="cb1-36"><a href="#cb1-36" aria-hidden="true" tabindex="-1"></a>    <span class="dt">bool</span> completed;</span>
<span id="cb1-37"><a href="#cb1-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-38"><a href="#cb1-38" aria-hidden="true" tabindex="-1"></a>    <span class="co">// true if an error occurred</span></span>
<span id="cb1-39"><a href="#cb1-39" aria-hidden="true" tabindex="-1"></a>    <span class="dt">bool</span> errorOccurred;</span>
<span id="cb1-40"><a href="#cb1-40" aria-hidden="true" tabindex="-1"></a><span class="op">}</span>;</span>
<span id="cb1-41"><a href="#cb1-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-42"><a href="#cb1-42" aria-hidden="true" tabindex="-1"></a>CompileOutput newCompile<span class="op">(</span>String compileCommand,</span>
<span id="cb1-43"><a href="#cb1-43" aria-hidden="true" tabindex="-1"></a>                         String <span class="op">(*</span>getFileContents<span class="op">)(</span>String filePath<span class="op">))</span>;</span>
<span id="cb1-44"><a href="#cb1-44" aria-hidden="true" tabindex="-1"></a>CompileOutput resumeCompile<span class="op">(</span><span class="dt">void</span> <span class="op">*</span>compilerState, String ifcFile<span class="op">)</span>;</span>
<span id="cb1-45"><a href="#cb1-45" aria-hidden="true" tabindex="-1"></a>String getObjectFile<span class="op">(</span>String ifcFile<span class="op">)</span>;</span></code></pre></div>
<p>The compiler calls <code class="sourceCode default">newCompile</code>
function passing it the compile-command for the module file. The compile
command, however, does not include any dependencies. If the compiler
sees an import of a module, it sets the
<code class="sourceCode default">objectFileOrModuleName</code> String of
the <code class="sourceCode default">CompileOutput</code> return value.
Same is the case for header-units but as mentioned in declaration,
ifcFileOrHeaderUnitPath is used. The build-system now will preserve the
<code class="sourceCode default">compilerState</code> and will check if
the required file is already built, or it needs to be built, or it is
being built. Only after the file is available, the build-system will
call <code class="sourceCode default">resumeCompile</code> function
passing it the ifcFile.
<code class="sourceCode default">resumeCompile</code> is called until
file has no dependency not provided and the compilation succeeds. If
only the ifcFile is returned and no objectFile on compilation
completion, the build-system assumes that the compiler is using 2-phase
model. In this case, on a different thread it will call
<code class="sourceCode default">getObjectFile</code> to get objectFile.
Distinction between the two models is discussed here: <a href="https://gitlab.kitware.com/cmake/cmake/-/issues/18355#note_1329192">https://gitlab.kitware.com/cmake/cmake/-/issues/18355#note_1329192</a>.
The argument <code class="sourceCode default">getFileContents</code> is
used by the compiler to get file contents of any file instead of reading
itself. This means that a file does not get read twice for different
compilations. As compilation completes, build-system will write ifc and
object files to the memory as-well.</p>
<p>This solution does not have the drawbacks of the above solution with
the added advantages that:</p>
<ol type="1">
<li>Files are directly compiled instead of being scanned first before
compilation.</li>
<li>Build-system keeps the files in the cache. As build-systems spend a
lot of time reading from disk, an often used technique to improve speed
is to launch more threads than supported by hardware. But this might not
be an effective solution anymore as building modules is not
embarrassingly parallel.</li>
</ol>
<h1 data-number="8" id="acknowledgements"><span class="header-section-number">8</span> Acknowledgements<a href="#acknowledgements" class="self-link"></a></h1>
<h1 data-number="9" id="references"><span class="header-section-number">9</span> References<a href="#references" class="self-link"></a></h1>
<p>The template above is based on the one in N3370 Call for Library
Proposals, which also has some other tips for writing a good library
proposal. Please note that the “Submission procedures” section in that
document are outdated and should not be used. The start of this page
describes the new procedures.</p>
<h1 data-number="10" id="motivation"><span class="header-section-number">10</span> Motivation<a href="#motivation" class="self-link"></a></h1>
<p>One of the most contentious and difficult design problem to solve in
introducing pattern matching has been the issue of dealing with
identifiers. Specifically, whether an identifier in a pattern introduces
a new name or refers to an existing name. This paper aims to address
this concern by making names refer to existing names by default, and use
<code class="sourceCode default">let</code> as the introducer for new
names.</p>
<p>Another key goal that Herb Sutter aims for in <span class="citation" data-cites="P2392R0">[<a href="#ref-P2392R0" role="doc-biblioref">P2392R0</a>]</span> is the ability for pattern
syntax to be used outside of
<code class="sourceCode default">inspect</code>. More specifically, the
goal is to be able to perform pattern matching easily in
boolean-expecting contexts such as
<code class="sourceCode default">if</code> and
<code class="sourceCode default">requires</code>. This paper aims to
address this concern with the <em>expr</em>
<code class="sourceCode default">match</code> <em>pattern</em>
expression.</p>
<h1 data-number="11" id="history"><span class="header-section-number">11</span> History<a href="#history" class="self-link"></a></h1>
<p><span class="citation" data-cites="P1371R0">[<a href="#ref-P1371R0" role="doc-biblioref">P1371R0</a>]</span> proposed
<code class="sourceCode default">id</code> to introduce a new name, and
for <code class="sourceCode default">^id</code> to refer to an existing
name. <span class="citation" data-cites="P1371R1">[<a href="#ref-P1371R1" role="doc-biblioref">P1371R1</a>]</span> removed the
<code class="sourceCode default">^</code> due to feedback about it being
a Microsoft C++ extension for smart pointers, as well as its effect on
code performing simple enumeration matching.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="kw">enum</span> Color <span class="op">{</span> Red, Green, Blue <span class="op">}</span>;</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>inspect <span class="op">(</span>e<span class="op">)</span> <span class="op">{</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>  <span class="op">^</span>Red   <span class="op">=&gt;</span> <span class="co">// I&#39;m just trying to</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>  <span class="op">^</span>Green <span class="op">=&gt;</span> <span class="co">// match simple enums...</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>  <span class="op">^</span>Blue  <span class="op">=&gt;</span> <span class="co">// What&#39;s with these carets?</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p><span class="citation" data-cites="P1371R1">[<a href="#ref-P1371R1" role="doc-biblioref">P1371R1</a>]</span> and <span class="citation" data-cites="P1371R2">[<a href="#ref-P1371R2" role="doc-biblioref">P1371R2</a>]</span> kept
<code class="sourceCode default">id</code> introducing a new name, but
replaced <code class="sourceCode default">^id</code> with
<code class="sourceCode default">case id</code> to refer to an existing
name and <code class="sourceCode default">let id</code> to explicitly
introduce a new name.</p>
<p>One of the motivations for this was to make simple code such as
enumeration matching familiar again:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="kw">enum</span> Color <span class="op">{</span> Red, Green, Blue <span class="op">}</span>;</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>inspect <span class="op">(</span>e<span class="op">)</span> <span class="op">{</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>  <span class="cf">case</span> Red   <span class="op">=&gt;</span> <span class="co">// Huh, just looks like `switch` now.</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>  <span class="cf">case</span> Green <span class="op">=&gt;</span> <span class="co">// ...</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>  <span class="cf">case</span> Blue  <span class="op">=&gt;</span> <span class="co">// ...</span></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>The <code class="sourceCode default">case</code> and
<code class="sourceCode default">let</code> applied recursively to
identifiers to allow patterns such as
<code class="sourceCode default">case [a, b]</code> to match against
existing <code class="sourceCode default">a</code> and
<code class="sourceCode default">b</code>, and
<code class="sourceCode default">let [x, y]</code> to introduce new
names <code class="sourceCode default">x</code> and
<code class="sourceCode default">y</code>. This recursive behavior
received positive feedback from EWG in Cologne 2019:</p>
<p>“We support the authors’ direction of
<code class="sourceCode default">let</code> and
<code class="sourceCode default">case</code> modes applying to
subpatterns.”: SF: 7, F: 7, N: 5, A: 4, SA: 0</p>
<p>The problem with this approach appeared to be due to the overriding
behavior of the <code class="sourceCode default">case</code> and
<code class="sourceCode default">let</code>. For example, constructs
such as <code class="sourceCode default">case [a, b, let x]</code> were
allowed to match against existing
<code class="sourceCode default">a</code> and
<code class="sourceCode default">b</code> for the first two elements and
bind <code class="sourceCode default">x</code> to the third.</p>
<p>In more complex examples however, it becomes more difficult to parse
through which names are new and which refer to existing.</p>
<p>For example in
<code class="sourceCode default">let [a, case [let b, c, d], [e]]</code>,
<code class="sourceCode default">a</code>,
<code class="sourceCode default">b</code>,
<code class="sourceCode default">e</code> are new names,
<code class="sourceCode default">c</code>,
<code class="sourceCode default">d</code> refer to an existing
names.</p>
<p>In response, <span class="citation" data-cites="P1371R3">[<a href="#ref-P1371R3" role="doc-biblioref">P1371R3</a>]</span> chose to
keep <code class="sourceCode default">case</code> and drop
<code class="sourceCode default">let</code>. Because the top-level
already had <code class="sourceCode default">let</code> behavior in that
it introduced new names, we already effectively had “recursive
<code class="sourceCode default">let</code>”. We really only needed to
provide a way to specify an existing name. This led to
<code class="sourceCode default">case</code> becoming non-recursive.</p>
<p>At this point, there were several push backs:</p>
<ul>
<li><p>“We shouldn’t to bifurcate expressions like this.”</p>
<p>Some expressions didn’t need
<code class="sourceCode default">case</code>
(e.g. <code class="sourceCode default">0</code>), but some did
(e.g. <code class="sourceCode default">id</code>). If
<code class="sourceCode default">case expr</code> is pattern matching
syntax for expressions, that would at least be consistent.</p>
<p>This paper aims to address this concern by not requiring
<code class="sourceCode default">case</code> for expressions at
all.</p></li>
<li><p>“Declarations of new names should have an introducer like most
other places.”</p>
<p>The comment is in regard to code like this:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode default"><code class="sourceCode default"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>inspect (e) {</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>  x =&gt; ...</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>Some people found it surprising that that would introduce a new name,
as most identifiers are introduced with an introducer. Notable
exceptions being lambda captures and structured bindings. Even then,
<code class="sourceCode default">[x, y]() {}</code> doesn’t introduce
<code class="sourceCode default">x</code> and
<code class="sourceCode default">y</code> out of thin-air, it captures
existing <code class="sourceCode default">x</code> and
<code class="sourceCode default">y</code> at the same time. Structured
bindings at least has the <code class="sourceCode default">auto</code>
in front, like: <code class="sourceCode default">auto [x, y]</code>
which doesn’t apply to the <code class="sourceCode default">x</code> and
<code class="sourceCode default">y</code> at all, but does indicate that
we’re in a declaration context.</p>
<p>This paper aims to address this concern by introducing a recursive
<code class="sourceCode default">let</code> introducer for new
names.</p></li>
</ul>
<h1 data-number="12" id="comparison-tables"><span class="header-section-number">12</span> Comparison Tables<a href="#comparison-tables" class="self-link"></a></h1>
<h2 data-number="12.1" id="matching-integrals"><span class="header-section-number">12.1</span> Matching Integrals<a href="#matching-integrals" class="self-link"></a></h2>
<table>
<thead>
<tr class="header">
<th><div style="text-align:center">
<strong>C++20</strong>
</div></th>
<th><div style="text-align:center">
<strong>R3</strong>
</div></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><div>

<div class="sourceCode" id="cb5"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="cf">switch</span> <span class="op">(</span>x<span class="op">)</span> <span class="op">{</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">case</span> <span class="dv">0</span><span class="op">:</span> std<span class="op">::</span>cout <span class="op">&lt;&lt;</span> <span class="st">&quot;got zero&quot;</span>; <span class="cf">break</span>;</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>  <span class="cf">case</span> <span class="dv">1</span><span class="op">:</span> std<span class="op">::</span>cout <span class="op">&lt;&lt;</span> <span class="st">&quot;got one&quot;</span>; <span class="cf">break</span>;</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>  <span class="cf">default</span><span class="op">:</span> std<span class="op">::</span>cout <span class="op">&lt;&lt;</span> <span class="st">&quot;don&#39;t care&quot;</span>;</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>

</div></td>
<td><div>

<div class="sourceCode" id="cb6"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>inspect <span class="op">(</span>x<span class="op">)</span> <span class="op">{</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>  <span class="dv">0</span> <span class="op">=&gt;</span> <span class="op">{</span> std<span class="op">::</span>cout <span class="op">&lt;&lt;</span> <span class="st">&quot;got zero&quot;</span>; <span class="op">}</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>  <span class="dv">1</span> <span class="op">=&gt;</span> <span class="op">{</span> std<span class="op">::</span>cout <span class="op">&lt;&lt;</span> <span class="st">&quot;got one&quot;</span>; <span class="op">}</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>  __ <span class="op">=&gt;</span> <span class="op">{</span> std<span class="op">::</span>cout <span class="op">&lt;&lt;</span> <span class="st">&quot;don&#39;t care&quot;</span>; <span class="op">}</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a><span class="op">}</span>;</span></code></pre></div>

</div></td>
</tr>
</tbody>
</table>
<table>
<thead>
<tr class="header">
<th><div style="text-align:center">
<strong>R4</strong>
</div></th>
<th><div style="text-align:center">
<strong>P2392R0</strong>
</div></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><div>

<div class="sourceCode" id="cb7"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>x match <span class="op">{</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>  <span class="dv">0</span> <span class="op">=&gt;</span> <span class="op">{</span> std<span class="op">::</span>cout <span class="op">&lt;&lt;</span> <span class="st">&quot;got zero&quot;</span>; <span class="op">}</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>  <span class="dv">1</span> <span class="op">=&gt;</span> <span class="op">{</span> std<span class="op">::</span>cout <span class="op">&lt;&lt;</span> <span class="st">&quot;got one&quot;</span>; <span class="op">}</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>  _ <span class="op">=&gt;</span> <span class="op">{</span> std<span class="op">::</span>cout <span class="op">&lt;&lt;</span> <span class="st">&quot;don&#39;t care&quot;</span>; <span class="op">}</span></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a><span class="op">}</span>;</span></code></pre></div>

</div></td>
<td><div>

<div class="sourceCode" id="cb8"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>inspect <span class="op">(</span>x<span class="op">)</span> <span class="op">{</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>  is <span class="dv">0</span> <span class="op">=&gt;</span> <span class="op">{</span> std<span class="op">::</span>cout <span class="op">&lt;&lt;</span> <span class="st">&quot;got zero&quot;</span>; <span class="op">}</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>  is <span class="dv">1</span> <span class="op">=&gt;</span> <span class="op">{</span> std<span class="op">::</span>cout <span class="op">&lt;&lt;</span> <span class="st">&quot;got one&quot;</span>; <span class="op">}</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>  is _ <span class="op">=&gt;</span> <span class="op">{</span> std<span class="op">::</span>cout <span class="op">&lt;&lt;</span> <span class="st">&quot;don&#39;t care&quot;</span>; <span class="op">}</span></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a><span class="op">}</span>;</span></code></pre></div>

</div></td>
</tr>
</tbody>
</table>
<h2 data-number="12.2" id="matching-strings"><span class="header-section-number">12.2</span> Matching Strings<a href="#matching-strings" class="self-link"></a></h2>
<table>
<thead>
<tr class="header">
<th><div style="text-align:center">
<strong>C++20</strong>
</div></th>
<th><div style="text-align:center">
<strong>R3</strong>
</div></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><div>

<div class="sourceCode" id="cb9"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="op">(</span>s <span class="op">==</span> <span class="st">&quot;foo&quot;</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>  std<span class="op">::</span>cout <span class="op">&lt;&lt;</span> <span class="st">&quot;got foo&quot;</span>;</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> <span class="cf">else</span> <span class="cf">if</span> <span class="op">(</span>s <span class="op">==</span> <span class="st">&quot;bar&quot;</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>  std<span class="op">::</span>cout <span class="op">&lt;&lt;</span> <span class="st">&quot;got bar&quot;</span>;</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>  std<span class="op">::</span>cout <span class="op">&lt;&lt;</span> <span class="st">&quot;don&#39;t care&quot;</span>;</span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>

</div></td>
<td><div>

<div class="sourceCode" id="cb10"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>inspect <span class="op">(</span>s<span class="op">)</span> <span class="op">{</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;foo&quot;</span> <span class="op">=&gt;</span> <span class="op">{</span> std<span class="op">::</span>cout <span class="op">&lt;&lt;</span> <span class="st">&quot;got foo&quot;</span>; <span class="op">}</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;bar&quot;</span> <span class="op">=&gt;</span> <span class="op">{</span> std<span class="op">::</span>cout <span class="op">&lt;&lt;</span> <span class="st">&quot;got bar&quot;</span>; <span class="op">}</span></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>  __ <span class="op">=&gt;</span> <span class="op">{</span> std<span class="op">::</span>cout <span class="op">&lt;&lt;</span> <span class="st">&quot;don&#39;t care&quot;</span>; <span class="op">}</span></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a><span class="op">}</span>;</span></code></pre></div>

</div></td>
</tr>
</tbody>
</table>
<table>
<thead>
<tr class="header">
<th><div style="text-align:center">
<strong>R4</strong>
</div></th>
<th><div style="text-align:center">
<strong>P2392</strong>
</div></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><div>

<div class="sourceCode" id="cb11"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>c match <span class="op">{</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;foo&quot;</span> <span class="op">=&gt;</span> <span class="op">{</span> std<span class="op">::</span>cout <span class="op">&lt;&lt;</span> <span class="st">&quot;got foo&quot;</span>; <span class="op">}</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;bar&quot;</span> <span class="op">=&gt;</span> <span class="op">{</span> std<span class="op">::</span>cout <span class="op">&lt;&lt;</span> <span class="st">&quot;got bar&quot;</span>; <span class="op">}</span></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>  _ <span class="op">=&gt;</span> <span class="op">{</span> std<span class="op">::</span>cout <span class="op">&lt;&lt;</span> <span class="st">&quot;don&#39;t care&quot;</span>; <span class="op">}</span></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a><span class="op">}</span>;</span></code></pre></div>

</div></td>
<td><div>

<div class="sourceCode" id="cb12"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>inspect <span class="op">(</span>s<span class="op">)</span> <span class="op">{</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>  is <span class="st">&quot;foo&quot;</span> <span class="op">=&gt;</span> <span class="op">{</span> std<span class="op">::</span>cout <span class="op">&lt;&lt;</span> <span class="st">&quot;got foo&quot;</span>; <span class="op">}</span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>  is <span class="st">&quot;bar&quot;</span> <span class="op">=&gt;</span> <span class="op">{</span> std<span class="op">::</span>cout <span class="op">&lt;&lt;</span> <span class="st">&quot;got bar&quot;</span>; <span class="op">}</span></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>  is _ <span class="op">=&gt;</span> <span class="op">{</span> std<span class="op">::</span>cout <span class="op">&lt;&lt;</span> <span class="st">&quot;don&#39;t care&quot;</span>; <span class="op">}</span></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a><span class="op">}</span>;</span></code></pre></div>

</div></td>
</tr>
</tbody>
</table>
<h2 data-number="12.3" id="matching-tuples"><span class="header-section-number">12.3</span> Matching Tuples<a href="#matching-tuples" class="self-link"></a></h2>
<table>
<thead>
<tr class="header">
<th><div style="text-align:center">
<strong>C++20</strong>
</div></th>
<th><div style="text-align:center">
<strong>R3</strong>
</div></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><div>

<div class="sourceCode" id="cb13"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="kw">auto</span><span class="op">&amp;&amp;</span> <span class="op">[</span>x, y<span class="op">]</span> <span class="op">=</span> p;</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="op">(</span>x <span class="op">==</span> <span class="dv">0</span> <span class="op">&amp;&amp;</span> y <span class="op">==</span> <span class="dv">0</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>  std<span class="op">::</span>cout <span class="op">&lt;&lt;</span> <span class="st">&quot;on origin&quot;</span>;</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> <span class="cf">else</span> <span class="cf">if</span> <span class="op">(</span>x <span class="op">==</span> <span class="dv">0</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>  std<span class="op">::</span>cout <span class="op">&lt;&lt;</span> <span class="st">&quot;on y-axis&quot;</span>;</span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> <span class="cf">else</span> <span class="cf">if</span> <span class="op">(</span>y <span class="op">==</span> <span class="dv">0</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>  std<span class="op">::</span>cout <span class="op">&lt;&lt;</span> <span class="st">&quot;on x-axis&quot;</span>;</span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a>  std<span class="op">::</span>cout <span class="op">&lt;&lt;</span> x <span class="op">&lt;&lt;</span> <span class="ch">&#39;,&#39;</span> <span class="op">&lt;&lt;</span> y;</span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>

</div></td>
<td><div>

<div class="sourceCode" id="cb14"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>inspect <span class="op">(</span>p<span class="op">)</span> <span class="op">{</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>  <span class="op">[</span><span class="dv">0</span>, <span class="dv">0</span><span class="op">]</span> <span class="op">=&gt;</span> <span class="op">{</span></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>    std<span class="op">::</span>cout <span class="op">&lt;&lt;</span> <span class="st">&quot;on origin&quot;</span>;</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>  <span class="op">[</span><span class="dv">0</span>, y<span class="op">]</span> <span class="op">=&gt;</span> <span class="op">{</span></span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>    std<span class="op">::</span>cout <span class="op">&lt;&lt;</span> <span class="st">&quot;on y-axis at &quot;</span> <span class="op">&lt;&lt;</span> y;</span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>  <span class="op">[</span>x, <span class="dv">0</span><span class="op">]</span> <span class="op">=&gt;</span> <span class="op">{</span></span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a>    std<span class="op">::</span>cout <span class="op">&lt;&lt;</span> <span class="st">&quot;on x-axis at &quot;</span> <span class="op">&lt;&lt;</span> x;</span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a>  <span class="op">[</span>x, y<span class="op">]</span> <span class="op">=&gt;</span> <span class="op">{</span></span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a>    std<span class="op">::</span>cout <span class="op">&lt;&lt;</span> x <span class="op">&lt;&lt;</span> <span class="ch">&#39;,&#39;</span> <span class="op">&lt;&lt;</span> y;</span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a><span class="op">}</span>;</span></code></pre></div>

</div></td>
</tr>
</tbody>
</table>
<table>
<thead>
<tr class="header">
<th><div style="text-align:center">
<strong>R4</strong>
</div></th>
<th><div style="text-align:center">
<strong>P2392</strong>
</div></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><div>

<div class="sourceCode" id="cb15"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>p match <span class="op">{</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>  <span class="op">[</span><span class="dv">0</span>, <span class="dv">0</span><span class="op">]</span> <span class="op">=&gt;</span> <span class="op">{</span></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>    std<span class="op">::</span>cout <span class="op">&lt;&lt;</span> <span class="st">&quot;on origin&quot;</span>;</span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>  <span class="op">[</span><span class="dv">0</span>, let y<span class="op">]</span> <span class="op">=&gt;</span> <span class="op">{</span></span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>    std<span class="op">::</span>cout <span class="op">&lt;&lt;</span> <span class="st">&quot;on y-axis at &quot;</span> <span class="op">&lt;&lt;</span> y;</span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a>  <span class="op">[</span>let x, <span class="dv">0</span><span class="op">]</span> <span class="op">=&gt;</span> <span class="op">{</span></span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a>    std<span class="op">::</span>cout <span class="op">&lt;&lt;</span> <span class="st">&quot;on x-axis at &quot;</span> <span class="op">&lt;&lt;</span> x;</span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a>  let <span class="op">[</span>x, y<span class="op">]</span> <span class="op">=&gt;</span> <span class="op">{</span></span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a>    std<span class="op">::</span>cout <span class="op">&lt;&lt;</span> x <span class="op">&lt;&lt;</span> <span class="ch">&#39;,&#39;</span> <span class="op">&lt;&lt;</span> y;</span>
<span id="cb15-13"><a href="#cb15-13" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb15-14"><a href="#cb15-14" aria-hidden="true" tabindex="-1"></a><span class="op">}</span>;</span></code></pre></div>

</div></td>
<td><div>

<div class="sourceCode" id="cb16"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>inspect <span class="op">(</span>p<span class="op">)</span> <span class="op">{</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>  is <span class="op">[</span><span class="dv">0</span>, <span class="dv">0</span><span class="op">]</span> <span class="op">=&gt;</span> <span class="op">{</span></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>    std<span class="op">::</span>cout <span class="op">&lt;&lt;</span> <span class="st">&quot;on origin&quot;</span>;</span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>  <span class="op">[</span>_, y<span class="op">]</span> is <span class="op">[</span><span class="dv">0</span>, _<span class="op">]</span> <span class="op">=&gt;</span> <span class="op">{</span></span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>    std<span class="op">::</span>cout <span class="op">&lt;&lt;</span> <span class="st">&quot;on y-axis at &quot;</span> <span class="op">&lt;&lt;</span> y;</span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a>  <span class="op">[</span>x, _<span class="op">]</span> is <span class="op">[</span>_, <span class="dv">0</span><span class="op">]</span> <span class="op">=&gt;</span> <span class="op">{</span></span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a>    std<span class="op">::</span>cout <span class="op">&lt;&lt;</span> <span class="st">&quot;on x-axis at &quot;</span> <span class="op">&lt;&lt;</span> x;</span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a>  <span class="op">[</span>x, y<span class="op">]</span> is _ <span class="op">=&gt;</span> <span class="op">{</span></span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a>    std<span class="op">::</span>cout <span class="op">&lt;&lt;</span> x <span class="op">&lt;&lt;</span> <span class="ch">&#39;,&#39;</span> <span class="op">&lt;&lt;</span> y;</span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb16-14"><a href="#cb16-14" aria-hidden="true" tabindex="-1"></a><span class="op">}</span>;</span></code></pre></div>

</div></td>
</tr>
</tbody>
</table>
<h2 data-number="12.4" id="matching-variants"><span class="header-section-number">12.4</span> Matching Variants<a href="#matching-variants" class="self-link"></a></h2>
<table>
<thead>
<tr class="header">
<th><div style="text-align:center">
<strong>C++20</strong>
</div></th>
<th><div style="text-align:center">
<strong>R3</strong>
</div></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><div>

<div class="sourceCode" id="cb17"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="kw">struct</span> visitor <span class="op">{</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">void</span> <span class="kw">operator</span><span class="op">()(</span><span class="dt">int</span> i<span class="op">)</span> <span class="kw">const</span> <span class="op">{</span></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>    os <span class="op">&lt;&lt;</span> <span class="st">&quot;got int: &quot;</span> <span class="op">&lt;&lt;</span> i;</span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>  <span class="dt">void</span> <span class="kw">operator</span><span class="op">()(</span><span class="dt">float</span> f<span class="op">)</span> <span class="kw">const</span> <span class="op">{</span></span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>    os <span class="op">&lt;&lt;</span> <span class="st">&quot;got float: &quot;</span> <span class="op">&lt;&lt;</span> f;</span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a>  std<span class="op">::</span>ostream<span class="op">&amp;</span> os;</span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a><span class="op">}</span>;</span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a>std<span class="op">::</span>visit<span class="op">(</span>visitor<span class="op">{</span>strm<span class="op">}</span>, v<span class="op">)</span>;</span></code></pre></div>

</div></td>
<td><div>

<div class="sourceCode" id="cb18"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>inspect <span class="op">(</span>v<span class="op">)</span> <span class="op">{</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>  <span class="op">&lt;</span><span class="dt">int</span><span class="op">&gt;</span> i <span class="op">=&gt;</span> <span class="op">{</span></span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>    strm <span class="op">&lt;&lt;</span> <span class="st">&quot;got int: &quot;</span> <span class="op">&lt;&lt;</span> i;</span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>  <span class="op">&lt;</span><span class="dt">float</span><span class="op">&gt;</span> f <span class="op">=&gt;</span> <span class="op">{</span></span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a>    strm <span class="op">&lt;&lt;</span> <span class="st">&quot;got float: &quot;</span> <span class="op">&lt;&lt;</span> f;</span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a><span class="op">}</span>;</span></code></pre></div>

</div></td>
</tr>
</tbody>
</table>
<table>
<thead>
<tr class="header">
<th><div style="text-align:center">
<strong>R4</strong>
</div></th>
<th><div style="text-align:center">
<strong>P2392</strong>
</div></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><div>

<div class="sourceCode" id="cb19"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>v match <span class="op">{</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span><span class="op">:</span> let i <span class="op">=&gt;</span> <span class="op">{</span></span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>    strm <span class="op">&lt;&lt;</span> <span class="st">&quot;got int: &quot;</span> <span class="op">&lt;&lt;</span> i;</span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>  <span class="dt">float</span><span class="op">:</span> let f <span class="op">=&gt;</span> <span class="op">{</span></span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>    strm <span class="op">&lt;&lt;</span> <span class="st">&quot;got float: &quot;</span> <span class="op">&lt;&lt;</span> f;</span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a><span class="op">}</span>;</span></code></pre></div>

</div></td>
<td><div>

<div class="sourceCode" id="cb20"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>inspect <span class="op">(</span>v<span class="op">)</span> <span class="op">{</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>  i as <span class="dt">int</span> <span class="op">=&gt;</span> <span class="op">{</span></span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>    strm <span class="op">&lt;&lt;</span> <span class="st">&quot;got int: &quot;</span> <span class="op">&lt;&lt;</span> i;</span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>  f as <span class="dt">float</span> <span class="op">=&gt;</span> <span class="op">{</span></span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a>    strm <span class="op">&lt;&lt;</span> <span class="st">&quot;got float: &quot;</span> <span class="op">&lt;&lt;</span> f;</span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a><span class="op">}</span>;</span></code></pre></div>

</div></td>
</tr>
</tbody>
</table>
<h2 data-number="12.5" id="matching-polymorphic-types"><span class="header-section-number">12.5</span> Matching Polymorphic Types<a href="#matching-polymorphic-types" class="self-link"></a></h2>
<div class="sourceCode" id="cb21"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="kw">struct</span> Shape <span class="op">{</span> <span class="kw">virtual</span> <span class="op">~</span>Shape<span class="op">()</span> <span class="op">=</span> <span class="cf">default</span>; <span class="op">}</span>;</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a><span class="kw">struct</span> Circle <span class="op">:</span> Shape <span class="op">{</span> <span class="dt">int</span> radius; <span class="op">}</span>;</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a><span class="kw">struct</span> Rectangle <span class="op">:</span> Shape <span class="op">{</span> <span class="dt">int</span> width, height; <span class="op">}</span>;</span></code></pre></div>
<table>
<thead>
<tr class="header">
<th><div style="text-align:center">
<strong>C++20</strong>
</div></th>
<th><div style="text-align:center">
<strong>R3</strong>
</div></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><div>

<div class="sourceCode" id="cb22"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="kw">virtual</span> <span class="dt">int</span> Shape<span class="op">::</span>get_area<span class="op">()</span> <span class="kw">const</span> <span class="op">=</span> <span class="dv">0</span>;</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> Circle<span class="op">::</span>get_area<span class="op">()</span> <span class="kw">const</span> <span class="kw">override</span> <span class="op">{</span></span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> <span class="fl">3.14</span> <span class="op">*</span> radius <span class="op">*</span> radius;</span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> Rectangle<span class="op">::</span>get_area<span class="op">()</span> <span class="kw">const</span> <span class="kw">override</span> <span class="op">{</span></span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> width <span class="op">*</span> height;</span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>

</div></td>
<td><div>

<div class="sourceCode" id="cb23"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> get_area<span class="op">(</span><span class="kw">const</span> Shape<span class="op">&amp;</span> shape<span class="op">)</span> <span class="op">{</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> inspect <span class="op">(</span>shape<span class="op">)</span> <span class="op">{</span></span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>    <span class="op">&lt;</span>Circle<span class="op">&gt;</span>    <span class="op">[</span>r<span class="op">]</span>    <span class="op">=&gt;</span> <span class="fl">3.14</span> <span class="op">*</span> r <span class="op">*</span> r;</span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>    <span class="op">&lt;</span>Rectangle<span class="op">&gt;</span> <span class="op">[</span>w, h<span class="op">]</span> <span class="op">=&gt;</span> w <span class="op">*</span> h;</span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span>;</span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>

</div></td>
</tr>
</tbody>
</table>
<table>
<thead>
<tr class="header">
<th><div style="text-align:center">
<strong>R4</strong>
</div></th>
<th><div style="text-align:center">
<strong>P2392</strong>
</div></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><div>

<div class="sourceCode" id="cb24"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> get_area<span class="op">(</span><span class="kw">const</span> Shape<span class="op">&amp;</span> shape<span class="op">)</span> <span class="op">{</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> shape match <span class="op">{</span></span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>    Circle<span class="op">:</span>    let <span class="op">[</span>r<span class="op">]</span>    <span class="op">=&gt;</span> <span class="fl">3.14</span> <span class="op">*</span> r <span class="op">*</span> r;</span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a>    Rectangle<span class="op">:</span> let <span class="op">[</span>w, h<span class="op">]</span> <span class="op">=&gt;</span> w <span class="op">*</span> h;</span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span>;</span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>

</div></td>
<td><div>

<div class="sourceCode" id="cb25"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> get_area<span class="op">(</span><span class="kw">const</span> Shape<span class="op">&amp;</span> shape<span class="op">)</span> <span class="op">{</span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> inspect <span class="op">(</span>shape<span class="op">)</span> <span class="op">{</span></span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span>r<span class="op">]</span>    as Circle    <span class="op">=&gt;</span> <span class="fl">3.14</span> <span class="op">*</span> r <span class="op">*</span> r;</span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span>w, h<span class="op">]</span> as Rectangle <span class="op">=&gt;</span> w <span class="op">*</span> h;</span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span>;</span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>

</div></td>
</tr>
</tbody>
</table>
<h2 data-number="12.6" id="evaluating-expression-trees"><span class="header-section-number">12.6</span> Evaluating Expression Trees<a href="#evaluating-expression-trees" class="self-link"></a></h2>
<div class="sourceCode" id="cb26"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="kw">struct</span> Expr;</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a><span class="kw">struct</span> Neg <span class="op">{</span></span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>  std<span class="op">::</span>shared_ptr<span class="op">&lt;</span>Expr<span class="op">&gt;</span> expr;</span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a><span class="op">}</span>;</span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a><span class="kw">struct</span> Add <span class="op">{</span></span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a>  std<span class="op">::</span>shared_ptr<span class="op">&lt;</span>Expr<span class="op">&gt;</span> lhs, rhs;</span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true" tabindex="-1"></a><span class="op">}</span>;</span>
<span id="cb26-10"><a href="#cb26-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-11"><a href="#cb26-11" aria-hidden="true" tabindex="-1"></a><span class="kw">struct</span> Mul <span class="op">{</span></span>
<span id="cb26-12"><a href="#cb26-12" aria-hidden="true" tabindex="-1"></a>  std<span class="op">::</span>shared_ptr<span class="op">&lt;</span>Expr<span class="op">&gt;</span> lhs, rhs;</span>
<span id="cb26-13"><a href="#cb26-13" aria-hidden="true" tabindex="-1"></a><span class="op">}</span>;</span>
<span id="cb26-14"><a href="#cb26-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-15"><a href="#cb26-15" aria-hidden="true" tabindex="-1"></a><span class="kw">struct</span> Expr <span class="op">:</span> std<span class="op">::</span>variant<span class="op">&lt;</span><span class="dt">int</span>, Neg, Add, Mul<span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb26-16"><a href="#cb26-16" aria-hidden="true" tabindex="-1"></a>  <span class="kw">using</span> variant<span class="op">::</span>variant;</span>
<span id="cb26-17"><a href="#cb26-17" aria-hidden="true" tabindex="-1"></a><span class="op">}</span>;</span>
<span id="cb26-18"><a href="#cb26-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-19"><a href="#cb26-19" aria-hidden="true" tabindex="-1"></a><span class="kw">namespace</span> std <span class="op">{</span></span>
<span id="cb26-20"><a href="#cb26-20" aria-hidden="true" tabindex="-1"></a>  <span class="kw">template</span> <span class="op">&lt;&gt;</span></span>
<span id="cb26-21"><a href="#cb26-21" aria-hidden="true" tabindex="-1"></a>  <span class="kw">struct</span> variant_size<span class="op">&lt;</span>Expr<span class="op">&gt;</span> <span class="op">:</span> variant_size<span class="op">&lt;</span>Expr<span class="op">::</span>variant<span class="op">&gt;</span> <span class="op">{}</span>;</span>
<span id="cb26-22"><a href="#cb26-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-23"><a href="#cb26-23" aria-hidden="true" tabindex="-1"></a>  <span class="kw">template</span> <span class="op">&lt;</span>std<span class="op">::</span><span class="dt">size_t</span> I<span class="op">&gt;</span></span>
<span id="cb26-24"><a href="#cb26-24" aria-hidden="true" tabindex="-1"></a>  <span class="kw">struct</span> variant_alternative<span class="op">&lt;</span>I, Expr<span class="op">&gt;</span> <span class="op">:</span> variant_alternative<span class="op">&lt;</span>I, Expr<span class="op">::</span>variant<span class="op">&gt;</span> <span class="op">{}</span>;</span>
<span id="cb26-25"><a href="#cb26-25" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<table>
<thead>
<tr class="header">
<th><div style="text-align:center">
<strong>Before</strong>
</div></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><div>

<div class="sourceCode" id="cb27"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> eval<span class="op">(</span><span class="kw">const</span> Expr<span class="op">&amp;</span> expr<span class="op">)</span> <span class="op">{</span></span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">struct</span> visitor <span class="op">{</span></span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> <span class="kw">operator</span><span class="op">()(</span><span class="dt">int</span> i<span class="op">)</span> <span class="kw">const</span> <span class="op">{</span></span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>      <span class="cf">return</span> i;</span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> <span class="kw">operator</span><span class="op">()(</span><span class="kw">const</span> Neg<span class="op">&amp;</span> n<span class="op">)</span> <span class="kw">const</span> <span class="op">{</span></span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a>      <span class="cf">return</span> <span class="op">-</span>eval<span class="op">(*</span>n<span class="op">.</span>expr<span class="op">)</span>;</span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb27-9"><a href="#cb27-9" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> <span class="kw">operator</span><span class="op">()(</span><span class="kw">const</span> Add<span class="op">&amp;</span> a<span class="op">)</span> <span class="kw">const</span> <span class="op">{</span></span>
<span id="cb27-10"><a href="#cb27-10" aria-hidden="true" tabindex="-1"></a>      <span class="cf">return</span> eval<span class="op">(*</span>a<span class="op">.</span>lhs<span class="op">)</span> <span class="op">+</span> eval<span class="op">(*</span>a<span class="op">.</span>rhs<span class="op">)</span>;</span>
<span id="cb27-11"><a href="#cb27-11" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb27-12"><a href="#cb27-12" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> <span class="kw">operator</span><span class="op">()(</span><span class="kw">const</span> Mul<span class="op">&amp;</span> m<span class="op">)</span> <span class="kw">const</span> <span class="op">{</span></span>
<span id="cb27-13"><a href="#cb27-13" aria-hidden="true" tabindex="-1"></a>      <span class="co">// Optimize multiplication by 0.</span></span>
<span id="cb27-14"><a href="#cb27-14" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> <span class="op">(</span><span class="dt">int</span><span class="op">*</span> i <span class="op">=</span> std<span class="op">::</span>get_if<span class="op">&lt;</span><span class="dt">int</span><span class="op">&gt;(</span>m<span class="op">.</span>lhs<span class="op">.</span>get<span class="op">())</span>; i <span class="op">&amp;&amp;</span> <span class="op">*</span>i <span class="op">==</span> <span class="dv">0</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb27-15"><a href="#cb27-15" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="dv">0</span>;</span>
<span id="cb27-16"><a href="#cb27-16" aria-hidden="true" tabindex="-1"></a>      <span class="op">}</span></span>
<span id="cb27-17"><a href="#cb27-17" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> <span class="op">(</span><span class="dt">int</span><span class="op">*</span> i <span class="op">=</span> std<span class="op">::</span>get_if<span class="op">&lt;</span><span class="dt">int</span><span class="op">&gt;(</span>m<span class="op">.</span>rhs<span class="op">.</span>get<span class="op">())</span>; i <span class="op">&amp;&amp;</span> <span class="op">*</span>i <span class="op">==</span> <span class="dv">0</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb27-18"><a href="#cb27-18" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="dv">0</span>;</span>
<span id="cb27-19"><a href="#cb27-19" aria-hidden="true" tabindex="-1"></a>      <span class="op">}</span></span>
<span id="cb27-20"><a href="#cb27-20" aria-hidden="true" tabindex="-1"></a>      <span class="cf">return</span> eval<span class="op">(*</span>m<span class="op">.</span>lhs<span class="op">)</span> <span class="op">*</span> eval<span class="op">(*</span>m<span class="op">.</span>rhs<span class="op">)</span>;</span>
<span id="cb27-21"><a href="#cb27-21" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb27-22"><a href="#cb27-22" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span>;</span>
<span id="cb27-23"><a href="#cb27-23" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> std<span class="op">::</span>visit<span class="op">(</span>visitor<span class="op">{}</span>, expr<span class="op">)</span>;</span>
<span id="cb27-24"><a href="#cb27-24" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>

</div></td>
</tr>
</tbody>
</table>
<table>
<thead>
<tr class="header">
<th><div style="text-align:center">
<strong>R3</strong>
</div></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><div>

<div class="sourceCode" id="cb28"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> eval<span class="op">(</span><span class="kw">const</span> Expr<span class="op">&amp;</span> expr<span class="op">)</span> <span class="op">{</span></span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> inspect <span class="op">(</span>expr<span class="op">)</span> <span class="op">{</span></span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>    <span class="op">&lt;</span><span class="dt">int</span><span class="op">&gt;</span> i <span class="op">=&gt;</span> i;</span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a>    <span class="op">&lt;</span>Neg<span class="op">&gt;</span> <span class="op">[(*!)</span> e<span class="op">]</span> <span class="op">=&gt;</span> <span class="op">-</span>eval<span class="op">(</span>e<span class="op">)</span>;</span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a>    <span class="op">&lt;</span>Add<span class="op">&gt;</span> <span class="op">[(*!)</span> l, <span class="op">(*!)</span> r<span class="op">]</span> <span class="op">=&gt;</span> eval<span class="op">(</span>l<span class="op">)</span> <span class="op">+</span> eval<span class="op">(</span>r<span class="op">)</span>;</span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Optimize multiplication by 0.</span></span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a>    <span class="op">&lt;</span>Mul<span class="op">&gt;</span> <span class="op">[(*!)</span> <span class="op">&lt;</span><span class="dt">int</span><span class="op">&gt;</span> <span class="dv">0</span>, __<span class="op">]</span> <span class="op">=&gt;</span> <span class="dv">0</span>;</span>
<span id="cb28-8"><a href="#cb28-8" aria-hidden="true" tabindex="-1"></a>    <span class="op">&lt;</span>Mul<span class="op">&gt;</span> <span class="op">[</span>__, <span class="op">(*!)</span> <span class="op">&lt;</span><span class="dt">int</span><span class="op">&gt;</span> <span class="dv">0</span><span class="op">]</span> <span class="op">=&gt;</span> <span class="dv">0</span>;</span>
<span id="cb28-9"><a href="#cb28-9" aria-hidden="true" tabindex="-1"></a>    <span class="op">&lt;</span>Mul<span class="op">&gt;</span> <span class="op">[(*!)</span> l, <span class="op">(*!)</span> r<span class="op">]</span> <span class="op">=&gt;</span> eval<span class="op">(</span>l<span class="op">)</span> <span class="op">*</span> eval<span class="op">(</span>r<span class="op">)</span>;</span>
<span id="cb28-10"><a href="#cb28-10" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span>;</span>
<span id="cb28-11"><a href="#cb28-11" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>

</div></td>
</tr>
</tbody>
</table>
<table>
<thead>
<tr class="header">
<th><div style="text-align:center">
<strong>R4</strong>
</div></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><div>

<div class="sourceCode" id="cb29"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> eval<span class="op">(</span><span class="kw">const</span> Expr<span class="op">&amp;</span> expr<span class="op">)</span> <span class="op">{</span></span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> expr match <span class="op">{</span></span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span><span class="op">:</span> let i <span class="op">=&gt;</span> i;</span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a>    Neg<span class="op">:</span> <span class="op">[*:</span> let e<span class="op">]</span> <span class="op">=&gt;</span> <span class="op">-</span>eval<span class="op">(</span>e<span class="op">)</span>;</span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a>    Add<span class="op">:</span> let <span class="op">[*:</span> l, <span class="op">*:</span> r<span class="op">]</span> <span class="op">=&gt;</span> eval<span class="op">(</span>l<span class="op">)</span> <span class="op">+</span> eval<span class="op">(</span>r<span class="op">)</span>;</span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Optimize multiplication by 0.</span></span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a>    Mul<span class="op">:</span> <span class="op">([*:</span> <span class="dt">int</span><span class="op">:</span> <span class="dv">0</span>, _<span class="op">]</span> <span class="op">||</span> <span class="op">[</span>_, <span class="op">*:</span> <span class="dt">int</span><span class="op">:</span> <span class="dv">0</span><span class="op">])</span> <span class="op">=&gt;</span> <span class="dv">0</span>;</span>
<span id="cb29-8"><a href="#cb29-8" aria-hidden="true" tabindex="-1"></a>    Mul<span class="op">:</span> let <span class="op">[*:</span> l, <span class="op">*:</span> r<span class="op">]</span> <span class="op">=&gt;</span> eval<span class="op">(</span>l<span class="op">)</span> <span class="op">*</span> eval<span class="op">(</span>r<span class="op">)</span>;</span>
<span id="cb29-9"><a href="#cb29-9" aria-hidden="true" tabindex="-1"></a>    _ <span class="op">=&gt;</span> <span class="dv">0</span>;</span>
<span id="cb29-10"><a href="#cb29-10" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span>;</span>
<span id="cb29-11"><a href="#cb29-11" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>

</div></td>
</tr>
</tbody>
</table>
<table>
<thead>
<tr class="header">
<th><div style="text-align:center">
<strong>P2392</strong>
</div></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><div>

<div class="sourceCode" id="cb30"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> eval<span class="op">(</span><span class="kw">const</span> Expr<span class="op">&amp;</span> expr<span class="op">)</span> <span class="op">{</span></span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> inspect <span class="op">(</span>expr<span class="op">)</span> <span class="op">{</span></span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a>    i as <span class="dt">int</span> <span class="op">=&gt;</span> i;</span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a>    <span class="op">[*</span>e<span class="op">]</span> as Neg <span class="op">=&gt;</span> <span class="op">-</span>eval<span class="op">(</span>e<span class="op">)</span>;</span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a>    <span class="op">[*</span>l, <span class="op">*</span>r<span class="op">]</span> as Add <span class="op">=&gt;</span> eval<span class="op">(</span>l<span class="op">)</span> <span class="op">+</span> eval<span class="op">(</span>r<span class="op">)</span>;</span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a>    <span class="op">[*</span>l, <span class="op">*</span>r<span class="op">]</span> as Mul <span class="op">{</span></span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a>      <span class="co">// Optimize multiplication by 0.</span></span>
<span id="cb30-8"><a href="#cb30-8" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> <span class="op">(</span>l as <span class="dt">int</span> <span class="op">==</span> <span class="dv">0</span> <span class="op">||</span> r as <span class="dt">int</span> <span class="op">==</span> <span class="dv">0</span><span class="op">)</span> <span class="op">=&gt;</span> <span class="dv">0</span>;</span>
<span id="cb30-9"><a href="#cb30-9" aria-hidden="true" tabindex="-1"></a>      is _ <span class="op">=&gt;</span> eval<span class="op">(</span>l<span class="op">)</span> <span class="op">*</span> eval<span class="op">(</span>r<span class="op">)</span>;</span>
<span id="cb30-10"><a href="#cb30-10" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb30-11"><a href="#cb30-11" aria-hidden="true" tabindex="-1"></a>    is _ <span class="op">=&gt;</span> <span class="dv">0</span>; <span class="co">// default case is required</span></span>
<span id="cb30-12"><a href="#cb30-12" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span>;</span>
<span id="cb30-13"><a href="#cb30-13" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>

</div></td>
</tr>
</tbody>
</table>
<h2 data-number="12.7" id="nested-structured-bindings"><span class="header-section-number">12.7</span> Nested Structured Bindings<a href="#nested-structured-bindings" class="self-link"></a></h2>
<table>
<thead>
<tr class="header">
<th><div style="text-align:center">
<strong>Before / After</strong>
</div></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><div>

<div class="sourceCode" id="cb31"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="kw">auto</span> <span class="kw">const</span><span class="op">&amp;</span> <span class="op">[</span>topLeft, unused<span class="op">]</span> <span class="op">=</span> getBoundaryRectangle<span class="op">()</span>;</span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a><span class="kw">auto</span> <span class="kw">const</span><span class="op">&amp;</span> <span class="op">[</span>topBoundary, leftBoundary<span class="op">]</span> <span class="op">=</span> topLeft;</span></code></pre></div>

</div></td>
</tr>
<tr class="even">
<td><div>

<div class="sourceCode" id="cb32"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="kw">auto</span> <span class="kw">const</span><span class="op">&amp;</span> <span class="op">[[</span><span class="at">topBoundary</span>,<span class="at"> leftBoundary</span><span class="op">]</span>,<span class="at"> unused</span><span class="op">]</span><span class="at"> </span><span class="op">=</span><span class="at"> getBoundaryRectangle</span><span class="op">()</span><span class="at">;</span></span></code></pre></div>

</div></td>
</tr>
</tbody>
</table>
<h2 data-number="12.8" id="pattern-matching-in-declarations"><span class="header-section-number">12.8</span> Pattern Matching in
Declarations<a href="#pattern-matching-in-declarations" class="self-link"></a></h2>
<table>
<tbody>
<tr class="odd">
<td><div>

<div class="sourceCode" id="cb33"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="op">(</span><span class="kw">auto</span> p <span class="op">=</span> f<span class="op">()</span>; p<span class="op">.</span>first <span class="op">==</span> <span class="dv">0</span><span class="op">)</span> <span class="op">{</span>  <span class="co">// C++20</span></span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">auto</span><span class="op">&amp;&amp;</span> y <span class="op">=</span> p<span class="op">.</span>second;</span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a>  <span class="co">// ...</span></span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="op">(</span><span class="kw">auto</span> p match <span class="op">[</span><span class="dv">0</span>, let y<span class="op">]</span> <span class="op">=</span> f<span class="op">())</span> <span class="op">{</span>  <span class="co">// R4</span></span>
<span id="cb33-7"><a href="#cb33-7" aria-hidden="true" tabindex="-1"></a>  <span class="co">// ...</span></span>
<span id="cb33-8"><a href="#cb33-8" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb33-9"><a href="#cb33-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-10"><a href="#cb33-10" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="op">(</span><span class="kw">auto</span> <span class="op">[</span>_, y<span class="op">]</span> is <span class="op">[</span><span class="dv">0</span>, _<span class="op">]</span> <span class="op">=</span> f<span class="op">())</span> <span class="op">{</span>  <span class="co">// P2392</span></span>
<span id="cb33-11"><a href="#cb33-11" aria-hidden="true" tabindex="-1"></a>  <span class="co">// ...</span></span>
<span id="cb33-12"><a href="#cb33-12" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>

</div></td>
</tr>
</tbody>
</table>
<h1 data-number="13" id="design-overview"><span class="header-section-number">13</span> Design Overview<a href="#design-overview" class="self-link"></a></h1>
<h2 data-number="13.1" id="basic-syntax"><span class="header-section-number">13.1</span> Basic Syntax<a href="#basic-syntax" class="self-link"></a></h2>
<blockquote>
<div class="line-block"><em>expression</em>
<code class="sourceCode default">match</code> <em>pattern</em>
<em>guard<sub>opt</sub></em></div>
</blockquote>
<blockquote>
<div class="line-block"><em>expression</em>
<code class="sourceCode default">match</code>
<em>trailing-return-type<sub>opt</sub></em>
<code class="sourceCode default">{</code><br />
    <em>pattern</em> <em>guard<sub>opt</sub></em>
<code class="sourceCode default">=&gt;</code> <em>statement</em><br />
    <em>pattern</em> <em>guard<sub>opt</sub></em>
<code class="sourceCode default">=&gt;</code>
<code class="sourceCode default">!</code><em><sub>opt</sub></em>
<code class="sourceCode default">{</code> <em>statement-seq</em>
<code class="sourceCode default">}</code><br />
…<br />
<code class="sourceCode default">}</code></div>
</blockquote>
<blockquote>
<div class="line-block"><em>guard:</em><br />
    <code class="sourceCode default">if</code> <em>expression</em></div>
</blockquote>
<h2 data-number="13.2" id="basic-model"><span class="header-section-number">13.2</span> Basic Model<a href="#basic-model" class="self-link"></a></h2>
<p><code class="sourceCode default">match</code> is an expression in all
contexts. Depending on the enclosed statements it may either yield a
<code class="sourceCode default">void</code> result or a value, the type
of which will be statically deduced from the statements themselves or
specified by a trailing return type. The deduction is analogous to that
performed when determining the return type of a lambda expression. A
pattern that passes control to a compound statement yields a
<code class="sourceCode default">void</code> result. The return types of
all patterns must match. If a trailing return type is provided, all
patterns must result in an expression returning a type that is
implicitly convertible to the trailing return type.</p>
<p>If <code class="sourceCode default">!</code> prefix is used before
compound statement - the statement would not contribute to return type
deduction for <code class="sourceCode default">match</code> expression.
Such a statement is not expected to yield a value and should stop the
execution either by returning from the enclosing function, throwing an
exception or terminating the program. This allows users to express
desired no-match behaviour or to act upon broken invariant, without
affecting return type of the whole of
<code class="sourceCode default">match</code> expression. If execution
reaches end of the compound statement
<code class="sourceCode default">std::terminate</code> is called.</p>
<p>When <code class="sourceCode default">match</code> is executed, the
expression to the left is evaluated and matched in order (first match
semantics) against each pattern. If a pattern successfully matches the
value of the condition and the boolean expression in the guard evaluates
to <code class="sourceCode default">true</code> (or if there is no guard
at all), then the value of the resulting expression is yielded or
control is passed to the compound statement, depending on whether the
inspect yields a value. If the guard expression evaluates to
<code class="sourceCode default">false</code>, control flows to the
subsequent pattern.</p>
<p>If no pattern matches, none of the expressions or compound statements
specified are executed. In that case if the
<code class="sourceCode default">match</code> expression yields
<code class="sourceCode default">void</code>, control is passed to the
next statement. If the <code class="sourceCode default">match</code>
expression does not yield <code class="sourceCode default">void</code>,
<code class="sourceCode default">std::terminate</code> will be
called.</p>
<h2 data-number="13.3" id="types-of-patterns"><span class="header-section-number">13.3</span> Types of Patterns<a href="#types-of-patterns" class="self-link"></a></h2>
<h3 data-number="13.3.1" id="primary-patterns"><span class="header-section-number">13.3.1</span> Primary Patterns<a href="#primary-patterns" class="self-link"></a></h3>
<h4 data-number="13.3.1.1" id="wildcard-pattern"><span class="header-section-number">13.3.1.1</span> Wildcard Pattern<a href="#wildcard-pattern" class="self-link"></a></h4>
<p>The wildcard pattern has the form:</p>
<blockquote>
<div class="line-block"><code class="sourceCode default">_</code></div>
</blockquote>
<p>and matches any value <code class="sourceCode default">v</code>.</p>
<div class="sourceCode" id="cb34"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> v <span class="op">=</span> <span class="co">/* ... */</span>;</span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a>inspect <span class="op">(</span>v<span class="op">)</span> <span class="op">{</span></span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a>    _ <span class="op">=&gt;</span> <span class="op">{</span> std<span class="op">::</span>cout <span class="op">&lt;&lt;</span> <span class="st">&quot;ignored&quot;</span>; <span class="op">}</span></span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a><span class="co">//  ^ wildcard pattern</span></span>
<span id="cb34-6"><a href="#cb34-6" aria-hidden="true" tabindex="-1"></a><span class="op">}</span>;</span></code></pre></div>
<p>Refer to the discussion for choice of
<code class="sourceCode default">_</code> in <a href="#wildcard-pattern-1">Wildcard Pattern</a>.</p>
<h4 data-number="13.3.1.2" id="expression-pattern"><span class="header-section-number">13.3.1.2</span> Expression Pattern<a href="#expression-pattern" class="self-link"></a></h4>
<p>The expression pattern has the form:</p>
<blockquote>
<div class="line-block"><em>cast-expression</em></div>
</blockquote>
<p>An expression pattern <code class="sourceCode default">e</code>
matches value <code class="sourceCode default">v</code></p>
<ol type="1">
<li>If <code class="sourceCode default">e(v)</code> is valid,
<code class="sourceCode default">e</code> matches
<code class="sourceCode default">v</code> if
<code class="sourceCode default">e(v)</code> is contextually convertible
to <code class="sourceCode default">bool</code> and evaluates to
<code class="sourceCode default">true</code>.</li>
<li>Otherwise, if <code class="sourceCode default">e == v</code> is
valid, <code class="sourceCode default">e</code> matches
<code class="sourceCode default">v</code> if
<code class="sourceCode default">e == v</code> is contextually
convertible to <code class="sourceCode default">bool</code> and
evaluates to <code class="sourceCode default">true</code>.</li>
</ol>
<div class="sourceCode" id="cb35"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> v <span class="op">=</span> <span class="co">/* ... */</span>;</span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a>v match <span class="op">{</span></span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a>    <span class="dv">0</span> <span class="op">=&gt;</span> <span class="op">{</span> std<span class="op">::</span>cout <span class="op">&lt;&lt;</span> <span class="st">&quot;got zero&quot;</span>; <span class="op">}</span></span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a>    <span class="dv">1</span> <span class="op">=&gt;</span> <span class="op">{</span> std<span class="op">::</span>cout <span class="op">&lt;&lt;</span> <span class="st">&quot;got one&quot;</span>; <span class="op">}</span></span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a><span class="co">//  ^ expression pattern</span></span>
<span id="cb35-7"><a href="#cb35-7" aria-hidden="true" tabindex="-1"></a><span class="op">}</span>;</span></code></pre></div>
<div class="sourceCode" id="cb36"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="kw">enum</span> Color <span class="op">{</span> Red, Green, Blue <span class="op">}</span>;</span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>Color color <span class="op">=</span> <span class="co">/* ... */</span>;</span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a>color match <span class="op">{</span></span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a>    Red   <span class="op">=&gt;</span> <span class="co">// ...</span></span>
<span id="cb36-6"><a href="#cb36-6" aria-hidden="true" tabindex="-1"></a>    Green <span class="op">=&gt;</span> <span class="co">// ...</span></span>
<span id="cb36-7"><a href="#cb36-7" aria-hidden="true" tabindex="-1"></a>    Blue  <span class="op">=&gt;</span> <span class="co">// ...</span></span>
<span id="cb36-8"><a href="#cb36-8" aria-hidden="true" tabindex="-1"></a><span class="co">//  ^^^^^ expression pattern</span></span>
<span id="cb36-9"><a href="#cb36-9" aria-hidden="true" tabindex="-1"></a><span class="op">}</span>;</span></code></pre></div>
<h3 data-number="13.3.2" id="compound-patterns"><span class="header-section-number">13.3.2</span> Compound Patterns<a href="#compound-patterns" class="self-link"></a></h3>
<h4 data-number="13.3.2.1" id="let-pattern"><span class="header-section-number">13.3.2.1</span> Let Pattern<a href="#let-pattern" class="self-link"></a></h4>
<p>The let pattern has the form:</p>
<blockquote>
<div class="line-block"><code class="sourceCode default">let</code>
<em>let-pattern</em></div>
</blockquote>
<p>The <em>let-pattern</em> allows all patterns and <em>identifier</em>,
without any expressions.</p>
<p><em>identifier</em> within <em>let-pattern</em> match any value and
are bindings to the corresponding component as defined by its parent
pattern. It is in scope from the pattern guard if one exists, otherwise
from the start of the statement following the pattern label.</p>
<div class="sourceCode" id="cb37"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> v <span class="op">=</span> <span class="co">/* ... */</span>;</span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a>inspect <span class="op">(</span>v<span class="op">)</span> <span class="op">{</span></span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a>    let x<span class="op">:</span> std<span class="op">::</span>cout <span class="op">&lt;&lt;</span> x;</span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a><span class="co">//  ^^^^^ let pattern</span></span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<div class="sourceCode" id="cb38"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="kw">static</span> <span class="kw">constexpr</span> <span class="dt">int</span> zero <span class="op">=</span> <span class="dv">0</span>, one <span class="op">=</span> <span class="dv">1</span>;</span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a>std<span class="op">::</span>pair<span class="op">&lt;</span><span class="dt">int</span>, std<span class="op">::</span>pair<span class="op">&lt;</span><span class="dt">int</span>, <span class="dt">int</span><span class="op">&gt;&gt;</span> p <span class="op">=</span> <span class="co">/* ... */</span></span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a>inspect <span class="op">(</span>p<span class="op">)</span> <span class="op">{</span></span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span>zero, let <span class="op">[</span>x, y<span class="op">]]:</span> std<span class="op">::</span>cout <span class="op">&lt;&lt;</span> <span class="st">&quot;got zero&quot;</span> <span class="op">&lt;&lt;</span> <span class="ch">&#39; &#39;</span> <span class="op">&lt;&lt;</span> x <span class="op">&lt;&lt;</span> <span class="ch">&#39; &#39;</span> <span class="op">&lt;&lt;</span> y;</span>
<span id="cb38-6"><a href="#cb38-6" aria-hidden="true" tabindex="-1"></a><span class="co">//              ^  ^ identifier pattern</span></span>
<span id="cb38-7"><a href="#cb38-7" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span>one, let <span class="op">[</span>x, y<span class="op">]]:</span> std<span class="op">::</span>cout <span class="op">&lt;&lt;</span> <span class="st">&quot;got one&quot;</span> <span class="op">&lt;&lt;</span> <span class="ch">&#39; &#39;</span> <span class="op">&lt;&lt;</span> x <span class="op">&lt;&lt;</span> <span class="ch">&#39; &#39;</span> <span class="op">&lt;&lt;</span> y;</span>
<span id="cb38-8"><a href="#cb38-8" aria-hidden="true" tabindex="-1"></a><span class="co">//        ^^^^^^^^^^  binding pattern</span></span>
<span id="cb38-9"><a href="#cb38-9" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h4 data-number="13.3.2.2" id="structured-binding-pattern"><span class="header-section-number">13.3.2.2</span> Structured Binding
Pattern<a href="#structured-binding-pattern" class="self-link"></a></h4>
<p>The structured binding pattern has the following two forms:</p>
<blockquote>
<div class="line-block"><code class="sourceCode default">[</code>
<em>pattern</em><sub>0</sub> <code class="sourceCode default">,</code>
<em>pattern</em><sub>1</sub> <code class="sourceCode default">,</code> …
<code class="sourceCode default">,</code> <em>pattern</em><sub>N</sub>
<code class="sourceCode default">]</code><br />
<code class="sourceCode default">[</code>
<em>designator</em><sub>0</sub>
<code class="sourceCode default">:</code> <em>pattern</em><sub>0</sub>
<code class="sourceCode default">,</code>
<em>designator</em><sub>1</sub>
<code class="sourceCode default">:</code> <em>pattern</em><sub>1</sub>
<code class="sourceCode default">,</code> …
<code class="sourceCode default">,</code>
<em>designator</em><sub>N</sub> : <em>pattern</em>~</div>
<p>N~ <code class="sourceCode default">]</code></p>
</blockquote>
<p>The first form matches value
<code class="sourceCode default">v</code> if each
<em>pattern<sub>i</sub></em> matches the <em>i</em><sup>th</sup>
component of <code class="sourceCode default">v</code>. The components
of <code class="sourceCode default">v</code> are given by the structured
binding declaration:
<code class="sourceCode default">auto&amp;&amp; [__e</code><sub>0</sub><code class="sourceCode default">, __e</code><sub>1</sub><code class="sourceCode default">,</code>
…<code class="sourceCode default">, __e</code><sub>N</sub><code class="sourceCode default">] = v;</code>
where each
<code class="sourceCode default">__e</code><em><sub>i</sub></em> are
unique exposition-only identifiers.</p>
<div class="sourceCode" id="cb39"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a>std<span class="op">::</span>pair<span class="op">&lt;</span><span class="dt">int</span>, <span class="dt">int</span><span class="op">&gt;</span> p <span class="op">=</span> <span class="co">/* ... */</span>;</span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a>inspect <span class="op">(</span>p<span class="op">)</span> <span class="op">{</span></span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span><span class="dv">0</span>, <span class="dv">0</span><span class="op">]</span> <span class="op">=&gt;</span> <span class="op">{</span> std<span class="op">::</span>cout <span class="op">&lt;&lt;</span> <span class="st">&quot;on origin&quot;</span>; <span class="op">}</span></span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span><span class="dv">0</span>, let y<span class="op">]</span> <span class="op">=&gt;</span> <span class="op">{</span> std<span class="op">::</span>cout <span class="op">&lt;&lt;</span> <span class="st">&quot;on y-axis&quot;</span>; <span class="op">}</span></span>
<span id="cb39-6"><a href="#cb39-6" aria-hidden="true" tabindex="-1"></a><span class="co">//      ^^^^^ let pattern</span></span>
<span id="cb39-7"><a href="#cb39-7" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span>x, <span class="dv">0</span><span class="op">]</span> <span class="op">=&gt;</span> <span class="op">{</span> std<span class="op">::</span>cout <span class="op">&lt;&lt;</span> <span class="st">&quot;on x-axis&quot;</span>; <span class="op">}</span></span>
<span id="cb39-8"><a href="#cb39-8" aria-hidden="true" tabindex="-1"></a><span class="co">//      ^ expression pattern</span></span>
<span id="cb39-9"><a href="#cb39-9" aria-hidden="true" tabindex="-1"></a>    let <span class="op">[</span>x, y<span class="op">]</span> <span class="op">=&gt;</span> <span class="op">{</span> std<span class="op">::</span>cout <span class="op">&lt;&lt;</span> x <span class="op">&lt;&lt;</span> <span class="ch">&#39;,&#39;</span> <span class="op">&lt;&lt;</span> y; <span class="op">}</span></span>
<span id="cb39-10"><a href="#cb39-10" aria-hidden="true" tabindex="-1"></a><span class="co">//      ^^^^^^ structured binding pattern within let pattern</span></span>
<span id="cb39-11"><a href="#cb39-11" aria-hidden="true" tabindex="-1"></a><span class="op">}</span>;</span></code></pre></div>
<p>The second form matches value
<code class="sourceCode default">v</code> if each
<em>pattern<sub>i</sub></em> matches the direct non-static data member
of <code class="sourceCode default">v</code> named <em>identifier</em>
from each <em>designator<sub>i</sub></em>. If an <em>identifier</em>
from any <em>designator<sub>i</sub></em> does not refer to a direct
non-static data member of <code class="sourceCode default">v</code>, the
program is ill-formed.</p>
<div class="sourceCode" id="cb40"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="kw">struct</span> Player <span class="op">{</span> std<span class="op">::</span>string name; <span class="dt">int</span> hitpoints; <span class="dt">int</span> coins; <span class="op">}</span>;</span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> get_hint<span class="op">(</span><span class="kw">const</span> Player<span class="op">&amp;</span> p<span class="op">)</span> <span class="op">{</span></span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a>    inspect <span class="op">(</span>p<span class="op">)</span> <span class="op">{</span></span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true" tabindex="-1"></a>        <span class="op">[.</span>hitpoints<span class="op">:</span> <span class="dv">1</span><span class="op">]</span> <span class="op">=&gt;</span> <span class="op">{</span> std<span class="op">::</span>cout <span class="op">&lt;&lt;</span> <span class="st">&quot;You&#39;re almost destroyed. Give up!</span><span class="sc">\n</span><span class="st">&quot;</span>; <span class="op">}</span></span>
<span id="cb40-6"><a href="#cb40-6" aria-hidden="true" tabindex="-1"></a>        <span class="op">[.</span>hitpoints<span class="op">:</span> <span class="dv">10</span>, <span class="op">.</span>coins<span class="op">:</span> <span class="dv">10</span><span class="op">]</span> <span class="op">=&gt;</span> <span class="op">{</span> std<span class="op">::</span>cout <span class="op">&lt;&lt;</span> <span class="st">&quot;I need the hints from you!</span><span class="sc">\n</span><span class="st">&quot;</span>; <span class="op">}</span></span>
<span id="cb40-7"><a href="#cb40-7" aria-hidden="true" tabindex="-1"></a>        <span class="op">[.</span>coins<span class="op">:</span> <span class="dv">10</span><span class="op">]</span> <span class="op">=&gt;</span> <span class="op">{</span> std<span class="op">::</span>cout <span class="op">&lt;&lt;</span> <span class="st">&quot;Get more hitpoints!</span><span class="sc">\n</span><span class="st">&quot;</span>; <span class="op">}</span></span>
<span id="cb40-8"><a href="#cb40-8" aria-hidden="true" tabindex="-1"></a>        <span class="op">[.</span>hitpoints<span class="op">:</span> <span class="dv">10</span><span class="op">]</span> <span class="op">=&gt;</span> <span class="op">{</span> std<span class="op">::</span>cout <span class="op">&lt;&lt;</span> <span class="st">&quot;Get more ammo!</span><span class="sc">\n</span><span class="st">&quot;</span>; <span class="op">}</span></span>
<span id="cb40-9"><a href="#cb40-9" aria-hidden="true" tabindex="-1"></a>        <span class="op">[.</span>name<span class="op">:</span> let n<span class="op">]</span> <span class="op">=&gt;</span> <span class="op">{</span></span>
<span id="cb40-10"><a href="#cb40-10" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="op">(</span>n <span class="op">!=</span> <span class="st">&quot;The Bruce Dickenson&quot;</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb40-11"><a href="#cb40-11" aria-hidden="true" tabindex="-1"></a>                std<span class="op">::</span>cout <span class="op">&lt;&lt;</span> <span class="st">&quot;Get more hitpoints and ammo!</span><span class="sc">\n</span><span class="st">&quot;</span>;</span>
<span id="cb40-12"><a href="#cb40-12" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb40-13"><a href="#cb40-13" aria-hidden="true" tabindex="-1"></a>                std<span class="op">::</span>cout <span class="op">&lt;&lt;</span> <span class="st">&quot;More cowbell!</span><span class="sc">\n</span><span class="st">&quot;</span>;</span>
<span id="cb40-14"><a href="#cb40-14" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb40-15"><a href="#cb40-15" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb40-16"><a href="#cb40-16" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span>;</span>
<span id="cb40-17"><a href="#cb40-17" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p><span class="note"><span>[ <em>Note:</em> </span>Unlike designated
initializers, the order of the designators need not be the same as the
declaration order of the members of the class.<span> — <em>end note</em>
]</span></span></p>
<h4 data-number="13.3.2.3" id="alternative-pattern"><span class="header-section-number">13.3.2.3</span> Alternative Pattern<a href="#alternative-pattern" class="self-link"></a></h4>
<p>// TODO: Think through this further…</p>
<p>The alternative pattern has the following forms:</p>
<blockquote>
<div class="line-block"><code class="sourceCode default">auto :</code>
<em>pattern</em><br />
<em>concept</em> <code class="sourceCode default">:</code>
<em>pattern</em><br />
<em>type</em> <code class="sourceCode default">:</code>
<em>pattern</em><br />
<em>cast-expression</em> <code class="sourceCode default">:</code>
<em>pattern</em></div>
</blockquote>
<div class="sourceCode" id="cb41"><pre class="sourceCode default"><code class="sourceCode default"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a>*: let foo</span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a></span></code></pre></div>
<div class="sourceCode" id="cb42"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a>e match <span class="op">{</span></span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a>  std<span class="op">::</span>integral <span class="op">=&gt;</span> <span class="op">...</span></span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span> <span class="op">=&gt;</span> <span class="op">...</span></span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span><span class="op">:</span> let i <span class="op">=&gt;</span> <span class="op">...</span></span>
<span id="cb42-5"><a href="#cb42-5" aria-hidden="true" tabindex="-1"></a>  std<span class="op">::</span>integral<span class="op">:</span> let i <span class="op">=&gt;</span> <span class="op">...</span></span>
<span id="cb42-6"><a href="#cb42-6" aria-hidden="true" tabindex="-1"></a><span class="op">}</span>;</span></code></pre></div>
<div class="sourceCode" id="cb43"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a>s match <span class="op">{</span></span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a>  ctre<span class="op">::</span>match<span class="op">&lt;</span><span class="st">&quot;[a-z]+([0-9]+)&quot;</span><span class="op">&gt;</span> <span class="op">=&gt;</span> <span class="co">// ...</span></span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a>  ctre<span class="op">::</span>match<span class="op">&lt;</span><span class="st">&quot;[a-z]+([0-9]+)&quot;</span><span class="op">&gt;:</span> let <span class="op">[</span>m, n<span class="op">]</span> <span class="op">=&gt;</span> <span class="op">...</span></span>
<span id="cb43-5"><a href="#cb43-5" aria-hidden="true" tabindex="-1"></a><span class="op">}</span>;</span></code></pre></div>
<blockquote>
<div class="line-block"><code class="sourceCode default">&lt; auto &gt;</code>
<em>pattern</em><br />
<code class="sourceCode default">&lt;</code> <em>concept</em>
<code class="sourceCode default">&gt;</code> <em>pattern</em><br />
<code class="sourceCode default">&lt;</code> <em>type</em>
<code class="sourceCode default">&gt;</code> <em>pattern</em><br />
<code class="sourceCode default">&lt;</code>
<em>constant-expression</em>
<code class="sourceCode default">&gt;</code> <em>pattern</em></div>
</blockquote>
<p>Let <code class="sourceCode default">v</code> be the value being
matched and <code class="sourceCode default">V</code> be <code class="sourceCode default">std::remove_cvref_t&lt;decltype(v)&gt;</code>.
Let <code class="sourceCode default">Alt</code> be the entity inside the
angle brackets.</p>
<p><strong>Case 1:
<code class="sourceCode default">std::variant</code>-like</strong></p>
<p>If
<code class="sourceCode default">std::variant_size_v&lt;V&gt;</code> is
well-formed and evaluates to an integral, the alternative pattern
matches <code class="sourceCode default">v</code> if
<code class="sourceCode default">Alt</code> is compatible with the
current index of <code class="sourceCode default">v</code> and
<em>pattern</em> matches the active alternative of
<code class="sourceCode default">v</code>.</p>
<p>Let <code class="sourceCode default">I</code> be the current index of
<code class="sourceCode default">v</code> given by a member
<code class="sourceCode default">v.index()</code> or else a non-member
ADL-only <code class="sourceCode default">index(v)</code>. The active
alternative of <code class="sourceCode default">v</code> is given by
<code class="sourceCode default">std::variant_alternative_t&lt;I, V&gt;&amp;</code>
initialized by a member
<code class="sourceCode default">v.get&lt;I&gt;()</code> or else a
non-member ADL-only
<code class="sourceCode default">get&lt;I&gt;(v)</code>.</p>
<p><code class="sourceCode default">Alt</code> is compatible with
<code class="sourceCode default">I</code> if one of the following four
cases is true:</p>
<ul>
<li><code class="sourceCode default">Alt</code> is
<code class="sourceCode default">auto</code></li>
<li><code class="sourceCode default">Alt</code> is a <em>concept</em>
and <code class="sourceCode default">std::variant_alternative_t&lt;I, V&gt;</code>
satisfies the <em>concept</em>.</li>
<li><code class="sourceCode default">Alt</code> is a <em>type</em> and
<code class="sourceCode default">std::is_same_v&lt;Alt, std::variant_alternative_t&lt;I, V&gt;&gt;</code>
is <code class="sourceCode default">true</code></li>
<li><code class="sourceCode default">Alt</code> is a
<em>constant-expression</em> that can be used in a
<code class="sourceCode default">switch</code> and is the same value as
<code class="sourceCode default">I</code>.</li>
</ul>
<table>
<colgroup>
<col style="width: 53%" />
<col style="width: 47%" />
</colgroup>
<thead>
<tr class="header">
<th><div style="text-align:center">
<strong>Before</strong>
</div></th>
<th><div style="text-align:center">
<strong>After</strong>
</div></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><div>

<div class="sourceCode" id="cb44"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a>std<span class="op">::</span>visit<span class="op">(</span></span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a>  <span class="op">[&amp;](</span><span class="kw">auto</span><span class="op">&amp;&amp;</span> x<span class="op">)</span> <span class="op">{</span></span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a>    strm <span class="op">&lt;&lt;</span> <span class="st">&quot;got auto: &quot;</span> <span class="op">&lt;&lt;</span> x;</span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span>,</span>
<span id="cb44-5"><a href="#cb44-5" aria-hidden="true" tabindex="-1"></a>  v<span class="op">)</span>;</span></code></pre></div>

</div></td>
<td><div>

<div class="sourceCode" id="cb45"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a>inspect <span class="op">(</span>v<span class="op">)</span> <span class="op">{</span></span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a>  <span class="op">&lt;</span><span class="kw">auto</span><span class="op">&gt;</span> x <span class="op">=&gt;</span> <span class="op">{</span></span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a>    strm <span class="op">&lt;&lt;</span> <span class="st">&quot;got auto: &quot;</span> <span class="op">&lt;&lt;</span> x;</span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb45-5"><a href="#cb45-5" aria-hidden="true" tabindex="-1"></a><span class="op">}</span>;</span></code></pre></div>

</div></td>
</tr>
<tr class="even">
<td><div>

<div class="sourceCode" id="cb46"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a>std<span class="op">::</span>visit<span class="op">([&amp;](</span><span class="kw">auto</span><span class="op">&amp;&amp;</span> x<span class="op">)</span> <span class="op">{</span></span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">using</span> X <span class="op">=</span> std<span class="op">::</span>remove_cvref_t<span class="op">&lt;</span><span class="kw">decltype</span><span class="op">(</span>x<span class="op">)&gt;</span>;</span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> <span class="kw">constexpr</span> <span class="op">(</span>C1<span class="op">&lt;</span>X<span class="op">&gt;())</span> <span class="op">{</span></span>
<span id="cb46-4"><a href="#cb46-4" aria-hidden="true" tabindex="-1"></a>    strm <span class="op">&lt;&lt;</span> <span class="st">&quot;got C1: &quot;</span> <span class="op">&lt;&lt;</span> x;</span>
<span id="cb46-5"><a href="#cb46-5" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span> <span class="cf">else</span> <span class="cf">if</span> <span class="kw">constexpr</span> <span class="op">(</span>C2<span class="op">&lt;</span>X<span class="op">&gt;())</span> <span class="op">{</span></span>
<span id="cb46-6"><a href="#cb46-6" aria-hidden="true" tabindex="-1"></a>    strm <span class="op">&lt;&lt;</span> <span class="st">&quot;got C2: &quot;</span> <span class="op">&lt;&lt;</span> x;</span>
<span id="cb46-7"><a href="#cb46-7" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb46-8"><a href="#cb46-8" aria-hidden="true" tabindex="-1"></a><span class="op">}</span>, v<span class="op">)</span>;</span></code></pre></div>

</div></td>
<td><div>

<div class="sourceCode" id="cb47"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a>inspect <span class="op">(</span>v<span class="op">)</span> <span class="op">{</span></span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a>  <span class="op">&lt;</span>C1<span class="op">&gt;</span> c1 <span class="op">=&gt;</span> <span class="op">{</span></span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a>    strm <span class="op">&lt;&lt;</span> <span class="st">&quot;got C1: &quot;</span> <span class="op">&lt;&lt;</span> c1;</span>
<span id="cb47-4"><a href="#cb47-4" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb47-5"><a href="#cb47-5" aria-hidden="true" tabindex="-1"></a>  <span class="op">&lt;</span>C2<span class="op">&gt;</span> c2 <span class="op">=&gt;</span> <span class="op">{</span></span>
<span id="cb47-6"><a href="#cb47-6" aria-hidden="true" tabindex="-1"></a>    strm <span class="op">&lt;&lt;</span> <span class="st">&quot;got C2: &quot;</span> <span class="op">&lt;&lt;</span> c2;</span>
<span id="cb47-7"><a href="#cb47-7" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb47-8"><a href="#cb47-8" aria-hidden="true" tabindex="-1"></a><span class="op">}</span>;</span></code></pre></div>

</div></td>
</tr>
<tr class="odd">
<td><div>

<div class="sourceCode" id="cb48"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a>std<span class="op">::</span>visit<span class="op">([&amp;](</span><span class="kw">auto</span><span class="op">&amp;&amp;</span> x<span class="op">)</span> <span class="op">{</span></span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">using</span> X <span class="op">=</span> std<span class="op">::</span>remove_cvref_t<span class="op">&lt;</span><span class="kw">decltype</span><span class="op">(</span>x<span class="op">)&gt;</span>;</span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> <span class="kw">constexpr</span> <span class="op">(</span>std<span class="op">::</span>is_same_v<span class="op">&lt;</span><span class="dt">int</span>, X<span class="op">&gt;)</span> <span class="op">{</span></span>
<span id="cb48-4"><a href="#cb48-4" aria-hidden="true" tabindex="-1"></a>    strm <span class="op">&lt;&lt;</span> <span class="st">&quot;got int: &quot;</span> <span class="op">&lt;&lt;</span> x;</span>
<span id="cb48-5"><a href="#cb48-5" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span> <span class="cf">else</span> <span class="cf">if</span> <span class="kw">constexpr</span> <span class="op">(</span></span>
<span id="cb48-6"><a href="#cb48-6" aria-hidden="true" tabindex="-1"></a>      std<span class="op">::</span>is_same_v<span class="op">&lt;</span><span class="dt">float</span>, X<span class="op">&gt;)</span> <span class="op">{</span></span>
<span id="cb48-7"><a href="#cb48-7" aria-hidden="true" tabindex="-1"></a>    strm <span class="op">&lt;&lt;</span> <span class="st">&quot;got float: &quot;</span> <span class="op">&lt;&lt;</span> x;</span>
<span id="cb48-8"><a href="#cb48-8" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb48-9"><a href="#cb48-9" aria-hidden="true" tabindex="-1"></a><span class="op">}</span>, v<span class="op">)</span>;</span></code></pre></div>

</div></td>
<td><div>

<div class="sourceCode" id="cb49"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a>inspect <span class="op">(</span>v<span class="op">)</span> <span class="op">{</span></span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a>  <span class="op">&lt;</span><span class="dt">int</span><span class="op">&gt;</span> i <span class="op">=&gt;</span> <span class="op">{</span></span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a>    strm <span class="op">&lt;&lt;</span> <span class="st">&quot;got int: &quot;</span> <span class="op">&lt;&lt;</span> i;</span>
<span id="cb49-4"><a href="#cb49-4" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb49-5"><a href="#cb49-5" aria-hidden="true" tabindex="-1"></a>  <span class="op">&lt;</span><span class="dt">float</span><span class="op">&gt;</span> f <span class="op">=&gt;</span> <span class="op">{</span></span>
<span id="cb49-6"><a href="#cb49-6" aria-hidden="true" tabindex="-1"></a>    strm <span class="op">&lt;&lt;</span> <span class="st">&quot;got float: &quot;</span> <span class="op">&lt;&lt;</span> f;</span>
<span id="cb49-7"><a href="#cb49-7" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb49-8"><a href="#cb49-8" aria-hidden="true" tabindex="-1"></a><span class="op">}</span>;</span></code></pre></div>

</div></td>
</tr>
<tr class="even">
<td><div>

<div class="sourceCode" id="cb50"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a>std<span class="op">::</span>variant<span class="op">&lt;</span><span class="dt">int</span>, <span class="dt">int</span><span class="op">&gt;</span> v <span class="op">=</span> <span class="co">/* ... */</span>;</span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-3"><a href="#cb50-3" aria-hidden="true" tabindex="-1"></a>std<span class="op">::</span>visit<span class="op">(</span></span>
<span id="cb50-4"><a href="#cb50-4" aria-hidden="true" tabindex="-1"></a>  <span class="op">[&amp;](</span><span class="dt">int</span> x<span class="op">)</span> <span class="op">{</span></span>
<span id="cb50-5"><a href="#cb50-5" aria-hidden="true" tabindex="-1"></a>    strm <span class="op">&lt;&lt;</span> <span class="st">&quot;got int: &quot;</span> <span class="op">&lt;&lt;</span> x;</span>
<span id="cb50-6"><a href="#cb50-6" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span>,</span>
<span id="cb50-7"><a href="#cb50-7" aria-hidden="true" tabindex="-1"></a>  v<span class="op">)</span>;</span></code></pre></div>

</div></td>
<td><div>

<div class="sourceCode" id="cb51"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a>std<span class="op">::</span>variant<span class="op">&lt;</span><span class="dt">int</span>, <span class="dt">int</span><span class="op">&gt;</span> v <span class="op">=</span> <span class="co">/* ... */</span>;</span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-3"><a href="#cb51-3" aria-hidden="true" tabindex="-1"></a>inspect <span class="op">(</span>v<span class="op">)</span> <span class="op">{</span></span>
<span id="cb51-4"><a href="#cb51-4" aria-hidden="true" tabindex="-1"></a>  <span class="op">&lt;</span><span class="dt">int</span><span class="op">&gt;</span> x <span class="op">=&gt;</span> <span class="op">{</span></span>
<span id="cb51-5"><a href="#cb51-5" aria-hidden="true" tabindex="-1"></a>    strm <span class="op">&lt;&lt;</span> <span class="st">&quot;got int: &quot;</span> <span class="op">&lt;&lt;</span> x;</span>
<span id="cb51-6"><a href="#cb51-6" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb51-7"><a href="#cb51-7" aria-hidden="true" tabindex="-1"></a><span class="op">}</span>;</span></code></pre></div>

</div></td>
</tr>
<tr class="odd">
<td><div>

<div class="sourceCode" id="cb52"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a>std<span class="op">::</span>variant<span class="op">&lt;</span><span class="dt">int</span>, <span class="dt">int</span><span class="op">&gt;</span> v <span class="op">=</span> <span class="co">/* ... */</span>;</span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-3"><a href="#cb52-3" aria-hidden="true" tabindex="-1"></a>std<span class="op">::</span>visit<span class="op">([&amp;](</span><span class="kw">auto</span><span class="op">&amp;&amp;</span> x<span class="op">)</span> <span class="op">{</span></span>
<span id="cb52-4"><a href="#cb52-4" aria-hidden="true" tabindex="-1"></a>  <span class="cf">switch</span> <span class="op">(</span>v<span class="op">.</span>index<span class="op">())</span> <span class="op">{</span></span>
<span id="cb52-5"><a href="#cb52-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> <span class="dv">0</span><span class="op">:</span> <span class="op">{</span></span>
<span id="cb52-6"><a href="#cb52-6" aria-hidden="true" tabindex="-1"></a>      strm <span class="op">&lt;&lt;</span> <span class="st">&quot;got first: &quot;</span> <span class="op">&lt;&lt;</span> x; <span class="cf">break</span>;</span>
<span id="cb52-7"><a href="#cb52-7" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb52-8"><a href="#cb52-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> <span class="dv">1</span><span class="op">:</span> <span class="op">{</span></span>
<span id="cb52-9"><a href="#cb52-9" aria-hidden="true" tabindex="-1"></a>      strm <span class="op">&lt;&lt;</span> <span class="st">&quot;got second: &quot;</span> <span class="op">&lt;&lt;</span> x; <span class="cf">break</span>;</span>
<span id="cb52-10"><a href="#cb52-10" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb52-11"><a href="#cb52-11" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb52-12"><a href="#cb52-12" aria-hidden="true" tabindex="-1"></a><span class="op">}</span>, v<span class="op">)</span>;</span></code></pre></div>

</div></td>
<td><div>

<div class="sourceCode" id="cb53"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a>std<span class="op">::</span>variant<span class="op">&lt;</span><span class="dt">int</span>, <span class="dt">int</span><span class="op">&gt;</span> v <span class="op">=</span> <span class="co">/* ... */</span>;</span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-3"><a href="#cb53-3" aria-hidden="true" tabindex="-1"></a>inspect <span class="op">(</span>v<span class="op">)</span> <span class="op">{</span></span>
<span id="cb53-4"><a href="#cb53-4" aria-hidden="true" tabindex="-1"></a>  <span class="op">&lt;</span><span class="dv">0</span><span class="op">&gt;</span> x <span class="op">=&gt;</span> <span class="op">{</span></span>
<span id="cb53-5"><a href="#cb53-5" aria-hidden="true" tabindex="-1"></a>    strm <span class="op">&lt;&lt;</span> <span class="st">&quot;got first: &quot;</span> <span class="op">&lt;&lt;</span> x;</span>
<span id="cb53-6"><a href="#cb53-6" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb53-7"><a href="#cb53-7" aria-hidden="true" tabindex="-1"></a>  <span class="op">&lt;</span><span class="dv">1</span><span class="op">&gt;</span> x <span class="op">=&gt;</span> <span class="op">{</span></span>
<span id="cb53-8"><a href="#cb53-8" aria-hidden="true" tabindex="-1"></a>    strm <span class="op">&lt;&lt;</span> <span class="st">&quot;got second: &quot;</span> <span class="op">&lt;&lt;</span> x;</span>
<span id="cb53-9"><a href="#cb53-9" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb53-10"><a href="#cb53-10" aria-hidden="true" tabindex="-1"></a><span class="op">}</span>;</span></code></pre></div>

</div></td>
</tr>
</tbody>
</table>
<p><strong>Case 2:
<code class="sourceCode default">std::any</code>-like</strong></p>
<blockquote>
<div class="line-block"><code class="sourceCode default">&lt;</code>
<em>type</em> <code class="sourceCode default">&gt;</code>
<em>pattern</em></div>
</blockquote>
<p>If <code class="sourceCode default">Alt</code> is a <em>type</em> and
there exists a valid non-member ADL-only
<code class="sourceCode default">any_cast&lt;Alt&gt;(&amp;v)</code>, let
<code class="sourceCode default">p</code> be its result. The alternative
pattern matches if <code class="sourceCode default">p</code>
contextually converted to <code class="sourceCode default">bool</code>
evaluates to <code class="sourceCode default">true</code>, and
<em>pattern</em> matches <code class="sourceCode default">*p</code>.</p>
<table>
<colgroup>
<col style="width: 52%" />
<col style="width: 53%" />
</colgroup>
<thead>
<tr class="header">
<th><div style="text-align:center">
<strong>Before</strong>
</div></th>
<th><div style="text-align:center">
<strong>After</strong>
</div></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><div>

<div class="sourceCode" id="cb54"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a>std<span class="op">::</span>any a <span class="op">=</span> <span class="dv">42</span>;</span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-3"><a href="#cb54-3" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="op">(</span><span class="dt">int</span><span class="op">*</span> i <span class="op">=</span> any_cast<span class="op">&lt;</span><span class="dt">int</span><span class="op">&gt;(&amp;</span>a<span class="op">))</span> <span class="op">{</span></span>
<span id="cb54-4"><a href="#cb54-4" aria-hidden="true" tabindex="-1"></a>  std<span class="op">::</span>cout <span class="op">&lt;&lt;</span> <span class="st">&quot;got int: &quot;</span> <span class="op">&lt;&lt;</span> <span class="op">*</span>i;</span>
<span id="cb54-5"><a href="#cb54-5" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> <span class="cf">else</span> <span class="cf">if</span> <span class="op">(</span><span class="dt">float</span><span class="op">*</span> f <span class="op">=</span> any_cast<span class="op">&lt;</span><span class="dt">float</span><span class="op">&gt;(&amp;</span>a<span class="op">))</span> <span class="op">{</span></span>
<span id="cb54-6"><a href="#cb54-6" aria-hidden="true" tabindex="-1"></a>  std<span class="op">::</span>cout <span class="op">&lt;&lt;</span> <span class="st">&quot;got float: &quot;</span> <span class="op">&lt;&lt;</span> <span class="op">*</span>f;</span>
<span id="cb54-7"><a href="#cb54-7" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>

</div></td>
<td><div>

<div class="sourceCode" id="cb55"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a>std<span class="op">::</span>any a <span class="op">=</span> <span class="dv">42</span>;</span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-3"><a href="#cb55-3" aria-hidden="true" tabindex="-1"></a>inspect <span class="op">(</span>a<span class="op">)</span> <span class="op">{</span></span>
<span id="cb55-4"><a href="#cb55-4" aria-hidden="true" tabindex="-1"></a>  <span class="op">&lt;</span><span class="dt">int</span><span class="op">&gt;</span> i <span class="op">=&gt;</span> <span class="op">{</span></span>
<span id="cb55-5"><a href="#cb55-5" aria-hidden="true" tabindex="-1"></a>    std<span class="op">::</span>cout <span class="op">&lt;&lt;</span> <span class="st">&quot;got int: &quot;</span> <span class="op">&lt;&lt;</span> i;</span>
<span id="cb55-6"><a href="#cb55-6" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb55-7"><a href="#cb55-7" aria-hidden="true" tabindex="-1"></a>  <span class="op">&lt;</span><span class="dt">float</span><span class="op">&gt;</span> f <span class="op">=&gt;</span> <span class="op">{</span></span>
<span id="cb55-8"><a href="#cb55-8" aria-hidden="true" tabindex="-1"></a>    std<span class="op">::</span>cout <span class="op">&lt;&lt;</span> <span class="st">&quot;got float: &quot;</span> <span class="op">&lt;&lt;</span> f;</span>
<span id="cb55-9"><a href="#cb55-9" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb55-10"><a href="#cb55-10" aria-hidden="true" tabindex="-1"></a><span class="op">}</span>;</span></code></pre></div>

</div></td>
</tr>
</tbody>
</table>
<p><strong>Case 3: Polymorphic Types</strong></p>
<blockquote>
<div class="line-block"><code class="sourceCode default">&lt;</code>
<em>type</em> <code class="sourceCode default">&gt;</code>
<em>pattern</em></div>
</blockquote>
<p>If <code class="sourceCode default">Alt</code> is a <em>type</em> and
<code class="sourceCode default">std::is_polymorphic_v&lt;V&gt;</code>
is <code class="sourceCode default">true</code>, let
<code class="sourceCode default">p</code> be <code class="sourceCode default">dynamic_cast&lt;Alt&#39;*&gt;(&amp;v)</code>
where <code class="sourceCode default">Alt&#39;</code> has the same
<em>cv</em>-qualifications as
<code class="sourceCode default">decltype(&amp;v)</code>. The
alternative pattern matches if <code class="sourceCode default">p</code>
contextually converted to <code class="sourceCode default">bool</code>
evaluates to <code class="sourceCode default">true</code>, and
<em>pattern</em> matches <code class="sourceCode default">*p</code>.</p>
<p>While the <strong>semantics</strong> of the pattern is specified in
terms of <code class="sourceCode default">dynamic_cast</code>, <span class="citation" data-cites="N3449">[<a href="#ref-N3449" role="doc-biblioref">N3449</a>]</span> describes techniques involving
vtable pointer caching and hash conflict minimization that are
implemented in the <span class="citation" data-cites="Mach7">[<a href="#ref-Mach7" role="doc-biblioref">Mach7</a>]</span> library, as
well as mentions of further opportunities available for a compiler
intrinsic.</p>
<p>Given the following definition of a
<code class="sourceCode default">Shape</code> class hierarchy:</p>
<div class="sourceCode" id="cb56"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a><span class="kw">struct</span> Shape <span class="op">{</span> <span class="kw">virtual</span> <span class="op">~</span>Shape<span class="op">()</span> <span class="op">=</span> <span class="cf">default</span>; <span class="op">}</span>;</span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-3"><a href="#cb56-3" aria-hidden="true" tabindex="-1"></a><span class="kw">struct</span> Circle <span class="op">:</span> Shape <span class="op">{</span> <span class="dt">int</span> radius; <span class="op">}</span>;</span>
<span id="cb56-4"><a href="#cb56-4" aria-hidden="true" tabindex="-1"></a><span class="kw">struct</span> Rectangle <span class="op">:</span> Shape <span class="op">{</span> <span class="dt">int</span> width, height; <span class="op">}</span>;</span></code></pre></div>
<table>
<thead>
<tr class="header">
<th><div style="text-align:center">
<strong>C++20</strong>
</div></th>
<th><div style="text-align:center">
<strong>R3</strong>
</div></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><div>

<div class="sourceCode" id="cb57"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a><span class="kw">virtual</span> <span class="dt">int</span> Shape<span class="op">::</span>get_area<span class="op">()</span> <span class="kw">const</span> <span class="op">=</span> <span class="dv">0</span>;</span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-3"><a href="#cb57-3" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> Circle<span class="op">::</span>get_area<span class="op">()</span> <span class="kw">const</span> <span class="kw">override</span> <span class="op">{</span></span>
<span id="cb57-4"><a href="#cb57-4" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> <span class="fl">3.14</span> <span class="op">*</span> radius <span class="op">*</span> radius;</span>
<span id="cb57-5"><a href="#cb57-5" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb57-6"><a href="#cb57-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-7"><a href="#cb57-7" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> Rectangle<span class="op">::</span>get_area<span class="op">()</span> <span class="kw">const</span> <span class="kw">override</span> <span class="op">{</span></span>
<span id="cb57-8"><a href="#cb57-8" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> width <span class="op">*</span> height;</span>
<span id="cb57-9"><a href="#cb57-9" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>

</div></td>
<td><div>

<div class="sourceCode" id="cb58"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> get_area<span class="op">(</span><span class="kw">const</span> Shape<span class="op">&amp;</span> shape<span class="op">)</span> <span class="op">{</span></span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> inspect <span class="op">(</span>shape<span class="op">)</span> <span class="op">{</span></span>
<span id="cb58-3"><a href="#cb58-3" aria-hidden="true" tabindex="-1"></a>    <span class="op">&lt;</span>Circle<span class="op">&gt;</span> <span class="op">[</span>r<span class="op">]</span> <span class="op">=&gt;</span> <span class="fl">3.14</span> <span class="op">*</span> r <span class="op">*</span> r;</span>
<span id="cb58-4"><a href="#cb58-4" aria-hidden="true" tabindex="-1"></a>    <span class="op">&lt;</span>Rectangle<span class="op">&gt;</span> <span class="op">[</span>w, h<span class="op">]</span> <span class="op">=&gt;</span> w <span class="op">*</span> h;</span>
<span id="cb58-5"><a href="#cb58-5" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span>;</span>
<span id="cb58-6"><a href="#cb58-6" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>

</div></td>
</tr>
</tbody>
</table>
<table>
<thead>
<tr class="header">
<th><div style="text-align:center">
<strong>R4</strong>
</div></th>
<th><div style="text-align:center">
<strong>P2392</strong>
</div></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><div>

<div class="sourceCode" id="cb59"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> get_area<span class="op">(</span><span class="kw">const</span> Shape<span class="op">&amp;</span> shape<span class="op">)</span> <span class="op">{</span></span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> shape match <span class="op">{</span></span>
<span id="cb59-3"><a href="#cb59-3" aria-hidden="true" tabindex="-1"></a>    Circle<span class="op">:</span>    let <span class="op">[</span>r<span class="op">]</span> <span class="op">=&gt;</span> <span class="fl">3.14</span> <span class="op">*</span> r <span class="op">*</span> r;</span>
<span id="cb59-4"><a href="#cb59-4" aria-hidden="true" tabindex="-1"></a>    Rectangle<span class="op">:</span> let <span class="op">[</span>w, h<span class="op">]</span> <span class="op">=&gt;</span> w <span class="op">*</span> h;</span>
<span id="cb59-5"><a href="#cb59-5" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span>;</span>
<span id="cb59-6"><a href="#cb59-6" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>

</div></td>
<td><div>

<div class="sourceCode" id="cb60"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> get_area<span class="op">(</span><span class="kw">const</span> Shape<span class="op">&amp;</span> shape<span class="op">)</span> <span class="op">{</span></span>
<span id="cb60-2"><a href="#cb60-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> inspect <span class="op">(</span>shape<span class="op">)</span> <span class="op">{</span></span>
<span id="cb60-3"><a href="#cb60-3" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span>r<span class="op">]</span> as Circle <span class="op">=&gt;</span> <span class="fl">3.14</span> <span class="op">*</span> r <span class="op">*</span> r;</span>
<span id="cb60-4"><a href="#cb60-4" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span>w, h<span class="op">]</span> as Rectangle <span class="op">=&gt;</span> w <span class="op">*</span> h;</span>
<span id="cb60-5"><a href="#cb60-5" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span>;</span>
<span id="cb60-6"><a href="#cb60-6" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>

</div></td>
</tr>
</tbody>
</table>
<h4 data-number="13.3.2.4" id="parenthesized-pattern"><span class="header-section-number">13.3.2.4</span> Parenthesized Pattern<a href="#parenthesized-pattern" class="self-link"></a></h4>
<p>The parenthesized pattern has the form:</p>
<blockquote>
<div class="line-block"><code class="sourceCode default">(</code>
<em>pattern</em> <code class="sourceCode default">)</code></div>
</blockquote>
<p>and matches value <code class="sourceCode default">v</code> if
<em>pattern</em> matches <code class="sourceCode default">v</code>.</p>
<div class="sourceCode" id="cb61"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a>std<span class="op">::</span>variant<span class="op">&lt;</span>Point, <span class="co">/* ... */</span><span class="op">&gt;</span> v <span class="op">=</span> <span class="co">/* ... */</span>;</span>
<span id="cb61-2"><a href="#cb61-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-3"><a href="#cb61-3" aria-hidden="true" tabindex="-1"></a>inspect <span class="op">(</span>v<span class="op">)</span> <span class="op">{</span></span>
<span id="cb61-4"><a href="#cb61-4" aria-hidden="true" tabindex="-1"></a>    Point<span class="op">:</span> <span class="op">([</span>let x, <span class="dv">0</span><span class="op">]</span> <span class="op">|</span> <span class="op">[</span><span class="dv">0</span>, let x<span class="op">])</span> <span class="op">=&gt;</span> <span class="co">// ...</span></span>
<span id="cb61-5"><a href="#cb61-5" aria-hidden="true" tabindex="-1"></a><span class="co">//         ^^^^^^^^^^^^^^^^^^^^^^^^^ parenthesized pattern</span></span>
<span id="cb61-6"><a href="#cb61-6" aria-hidden="true" tabindex="-1"></a><span class="op">}</span>;</span></code></pre></div>
<h4 data-number="13.3.2.5" id="dereference-pattern"><span class="header-section-number">13.3.2.5</span> Dereference Pattern<a href="#dereference-pattern" class="self-link"></a></h4>
<p>The dereference pattern has the form:</p>
<blockquote>
<div class="line-block"><code class="sourceCode default">* :</code>
<em>pattern</em></div>
</blockquote>
<p>and matches value <code class="sourceCode default">v</code> if
<code class="sourceCode default">v</code> is contextually convertible to
<code class="sourceCode default">bool</code>, evaluates to
<code class="sourceCode default">true</code>, and <em>pattern</em>
matches <code class="sourceCode default">*v</code>.</p>
<div class="sourceCode" id="cb62"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a><span class="kw">struct</span> Node <span class="op">{</span></span>
<span id="cb62-2"><a href="#cb62-2" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> value;</span>
<span id="cb62-3"><a href="#cb62-3" aria-hidden="true" tabindex="-1"></a>    std<span class="op">::</span>unique_ptr<span class="op">&lt;</span>Node<span class="op">&gt;</span> lhs, rhs;</span>
<span id="cb62-4"><a href="#cb62-4" aria-hidden="true" tabindex="-1"></a><span class="op">}</span>;</span>
<span id="cb62-5"><a href="#cb62-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-6"><a href="#cb62-6" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> print_leftmost<span class="op">(</span><span class="kw">const</span> Node<span class="op">&amp;</span> node<span class="op">)</span> <span class="op">{</span></span>
<span id="cb62-7"><a href="#cb62-7" aria-hidden="true" tabindex="-1"></a>    inspect <span class="op">(</span>node<span class="op">)</span> <span class="op">{</span></span>
<span id="cb62-8"><a href="#cb62-8" aria-hidden="true" tabindex="-1"></a>        <span class="op">[.</span>value<span class="op">:</span> v, <span class="op">.</span>lhs<span class="op">:</span> <span class="kw">nullptr</span><span class="op">]</span> <span class="op">=&gt;</span> <span class="op">{</span> std<span class="op">::</span>cout <span class="op">&lt;&lt;</span> v <span class="op">&lt;&lt;</span> <span class="ch">&#39;</span><span class="sc">\n</span><span class="ch">&#39;</span>; <span class="op">}</span></span>
<span id="cb62-9"><a href="#cb62-9" aria-hidden="true" tabindex="-1"></a>        <span class="op">[.</span>lhs<span class="op">:</span> <span class="op">*:</span> l<span class="op">]</span> <span class="op">=&gt;</span> <span class="op">{</span> print_leftmost<span class="op">(</span>l<span class="op">)</span>; <span class="op">}</span></span>
<span id="cb62-10"><a href="#cb62-10" aria-hidden="true" tabindex="-1"></a><span class="co">//             ^^^^ dereference pattern</span></span>
<span id="cb62-11"><a href="#cb62-11" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span>;</span>
<span id="cb62-12"><a href="#cb62-12" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p><span class="note"><span>[ <em>Note:</em> </span>Refer to <a href="#red-black-tree-rebalancing">Red-black Tree Rebalancing</a> for a
more complex example.<span> — <em>end note</em> ]</span></span></p>
<h4 data-number="13.3.2.6" id="extractor-pattern"><span class="header-section-number">13.3.2.6</span> Extractor Pattern<a href="#extractor-pattern" class="self-link"></a></h4>
<p>The extractor pattern has the following two forms:</p>
<blockquote>
<div class="line-block"><em>cast-expression</em> :
<em>pattern</em></div>
</blockquote>
<p>Let <code class="sourceCode default">c</code> be the
<em>cast-expression</em> and <code class="sourceCode default">e</code>
be the result of <code class="sourceCode default">c(v)</code>. The
extractor pattern matches value
<code class="sourceCode default">v</code> if
<code class="sourceCode default">e</code> is contextually convertible to
<code class="sourceCode default">bool</code>, evaluates to
<code class="sourceCode default">true</code> and <em>pattern</em>
matches <code class="sourceCode default">*e</code>.</p>
<div class="sourceCode" id="cb63"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a>std<span class="op">::</span>optional<span class="op">&lt;</span>std<span class="op">::</span>array<span class="op">&lt;</span>std<span class="op">::</span>string_view, <span class="dv">2</span><span class="op">&gt;&gt;</span> email<span class="op">(</span>std<span class="op">::</span>string_view sv<span class="op">)</span>;</span>
<span id="cb63-2"><a href="#cb63-2" aria-hidden="true" tabindex="-1"></a>std<span class="op">::</span>optional<span class="op">&lt;</span>std<span class="op">::</span>array<span class="op">&lt;</span>std<span class="op">::</span>string_view, <span class="dv">3</span><span class="op">&gt;&gt;</span> phone_number<span class="op">(</span>std<span class="op">::</span>string_view sv<span class="op">)</span>;</span>
<span id="cb63-3"><a href="#cb63-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-4"><a href="#cb63-4" aria-hidden="true" tabindex="-1"></a>s match <span class="op">{</span></span>
<span id="cb63-5"><a href="#cb63-5" aria-hidden="true" tabindex="-1"></a>    email<span class="op">:</span> let <span class="op">[</span>address, domain<span class="op">]</span> <span class="op">=&gt;</span> <span class="op">{</span> std<span class="op">::</span>cout <span class="op">&lt;&lt;</span> <span class="st">&quot;got an email&quot;</span>; <span class="op">}</span></span>
<span id="cb63-6"><a href="#cb63-6" aria-hidden="true" tabindex="-1"></a>    phone_number<span class="op">:</span> <span class="op">[</span><span class="st">&quot;415&quot;</span>, _, _<span class="op">]</span>  <span class="op">=&gt;</span> <span class="op">{</span> std<span class="op">::</span>cout <span class="op">&lt;&lt;</span> <span class="st">&quot;got a San Francisco phone number&quot;</span>; <span class="op">}</span></span>
<span id="cb63-7"><a href="#cb63-7" aria-hidden="true" tabindex="-1"></a><span class="co">//  ^^^^^^^^^^^^^^^^^^^^^^^^^^^^ extractor pattern</span></span>
<span id="cb63-8"><a href="#cb63-8" aria-hidden="true" tabindex="-1"></a><span class="op">}</span>;</span></code></pre></div>
<h2 data-number="13.4" id="pattern-guard"><span class="header-section-number">13.4</span> Pattern Guard<a href="#pattern-guard" class="self-link"></a></h2>
<p>The pattern guard has the form:</p>
<blockquote>
<div class="line-block"><code class="sourceCode default">if</code>
<em>expression</em></div>
</blockquote>
<p>Let <code class="sourceCode default">e</code> be the result of
<em>expression</em> contextually converted to
<code class="sourceCode default">bool</code>. If
<code class="sourceCode default">e</code> is
<code class="sourceCode default">true</code>, control is passed to the
corresponding statement. Otherwise, control flows to the subsequent
pattern.</p>
<p>The pattern guard allows to perform complex tests that cannot be
performed within the <em>pattern</em>. For example, performing tests
across multiple bindings:</p>
<div class="sourceCode" id="cb64"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a>p match <span class="op">{</span></span>
<span id="cb64-2"><a href="#cb64-2" aria-hidden="true" tabindex="-1"></a>    let <span class="op">[</span>x, y<span class="op">]</span> <span class="cf">if</span> test<span class="op">(</span>x, y<span class="op">)</span> <span class="op">=&gt;</span> <span class="op">{</span> std<span class="op">::</span>cout <span class="op">&lt;&lt;</span> x <span class="op">&lt;&lt;</span> <span class="ch">&#39;,&#39;</span> <span class="op">&lt;&lt;</span> y <span class="op">&lt;&lt;</span> <span class="st">&quot; passed&quot;</span>; <span class="op">}</span></span>
<span id="cb64-3"><a href="#cb64-3" aria-hidden="true" tabindex="-1"></a><span class="co">//             ^^^^^^^^^^^^^ pattern guard</span></span>
<span id="cb64-4"><a href="#cb64-4" aria-hidden="true" tabindex="-1"></a><span class="op">}</span>;</span></code></pre></div>
<p>This also diminishes the desire for fall-through semantics within the
statements, an unpopular feature even in
<code class="sourceCode default">switch</code> statements.</p>
<h2 data-number="13.5" id="match-constexpr"><span class="header-section-number">13.5</span>
<code class="sourceCode default">match constexpr</code><a href="#match-constexpr" class="self-link"></a></h2>
<p>// TODO: check if this actually does what we want…</p>
<p>Every <em>pattern</em> is able to determine whether it matches value
<code class="sourceCode default">v</code> as a boolean expression in
isolation. Ignoring any potential optimization opportunities, we’re able
to perform the following transformation:</p>
<table>
<colgroup>
<col style="width: 40%" />
<col style="width: 60%" />
</colgroup>
<thead>
<tr class="header">
<th><div style="text-align:center">
<strong><code class="sourceCode default">match</code></strong>
</div></th>
<th><div style="text-align:center">
<strong><code class="sourceCode default">if</code></strong>
</div></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><div>

<div class="sourceCode" id="cb65"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a>v match <span class="op">{</span></span>
<span id="cb65-2"><a href="#cb65-2" aria-hidden="true" tabindex="-1"></a>  pattern1 <span class="cf">if</span> <span class="op">(</span>cond1<span class="op">)</span> <span class="op">=&gt;</span> <span class="op">{</span> stmt1 <span class="op">}</span></span>
<span id="cb65-3"><a href="#cb65-3" aria-hidden="true" tabindex="-1"></a>  pattern2 <span class="op">=&gt;</span> <span class="op">{</span> stmt2 <span class="op">}</span></span>
<span id="cb65-4"><a href="#cb65-4" aria-hidden="true" tabindex="-1"></a>  <span class="co">// ...</span></span>
<span id="cb65-5"><a href="#cb65-5" aria-hidden="true" tabindex="-1"></a><span class="op">}</span>;</span></code></pre></div>

</div></td>
<td><div>

<div class="sourceCode" id="cb66"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="op">(</span>v match pattern1 <span class="op">&amp;&amp;</span> cond1<span class="op">)</span> stmt1</span>
<span id="cb66-2"><a href="#cb66-2" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span> <span class="cf">if</span> <span class="op">(</span>v match pattern2<span class="op">)</span> stmt2</span>
<span id="cb66-3"><a href="#cb66-3" aria-hidden="true" tabindex="-1"></a><span class="co">// ...</span></span></code></pre></div>

</div></td>
</tr>
</tbody>
</table>
<p><code class="sourceCode default">match constexpr</code> is then
formulated by applying <code class="sourceCode default">constexpr</code>
to every <code class="sourceCode default">if</code> branch.</p>
<table>
<colgroup>
<col style="width: 40%" />
<col style="width: 60%" />
</colgroup>
<thead>
<tr class="header">
<th><div style="text-align:center">
<strong><code class="sourceCode default">match constexpr</code></strong>
</div></th>
<th><div style="text-align:center">
<strong><code class="sourceCode default">if constexpr</code></strong>
</div></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><div>

<div class="sourceCode" id="cb67"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a>v match <span class="kw">constexpr</span> <span class="op">{</span></span>
<span id="cb67-2"><a href="#cb67-2" aria-hidden="true" tabindex="-1"></a>  pattern1 <span class="cf">if</span> <span class="op">(</span>cond1<span class="op">)</span> <span class="op">=&gt;</span> <span class="op">{</span> stmt1 <span class="op">}</span></span>
<span id="cb67-3"><a href="#cb67-3" aria-hidden="true" tabindex="-1"></a>  pattern2 <span class="op">=&gt;</span> <span class="op">{</span> stmt2 <span class="op">}</span></span>
<span id="cb67-4"><a href="#cb67-4" aria-hidden="true" tabindex="-1"></a>  <span class="co">// ...</span></span>
<span id="cb67-5"><a href="#cb67-5" aria-hidden="true" tabindex="-1"></a><span class="op">}</span>;</span></code></pre></div>

</div></td>
<td><div>

<div class="sourceCode" id="cb68"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="kw">constexpr</span> <span class="op">(</span>v match pattern1 <span class="op">&amp;&amp;</span> cond1<span class="op">)</span> stmt1</span>
<span id="cb68-2"><a href="#cb68-2" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span> <span class="cf">if</span> <span class="kw">constexpr</span> <span class="op">(</span>v match pattern2<span class="op">)</span> stmt2</span>
<span id="cb68-3"><a href="#cb68-3" aria-hidden="true" tabindex="-1"></a><span class="co">// ...</span></span></code></pre></div>

</div></td>
</tr>
</tbody>
</table>
<h2 data-number="13.6" id="exhaustiveness-and-usefulness"><span class="header-section-number">13.6</span> Exhaustiveness and
Usefulness<a href="#exhaustiveness-and-usefulness" class="self-link"></a></h2>
<p><code class="sourceCode default">inspect</code> can be declared
<code class="sourceCode default">[[strict]]</code> for
implementation-defined exhaustiveness and usefulness checking.</p>
<p><strong>Exhaustiveness</strong> means that all values of the type of
the value being matched is handled by at least one of the cases. For
example, having a <code class="sourceCode default">__:</code> case makes
any <code class="sourceCode default">inspect</code> statement
exhaustive.</p>
<p><strong>Usefulness</strong> means that every case handles at least
one value of the type of the value being matched. For example, any case
that comes after a <code class="sourceCode default">__:</code> case
would be useless.</p>
<p>Warnings for pattern matching <span class="citation" data-cites="Warnings">[<a href="#ref-Warnings" role="doc-biblioref">Warnings</a>]</span> discusses and outlines an
algorithm for exhaustiveness and usefulness for OCaml, and is the
algorithm used by Rust.</p>
<h2 data-number="13.7" id="refutability"><span class="header-section-number">13.7</span> Refutability<a href="#refutability" class="self-link"></a></h2>
<p>Patterns that cannot fail to match are said to be
<em>irrefutable</em> in contrast to <em>refutable</em> patterns which
can fail to match. For example, the identifier pattern is
<em>irrefutable</em> whereas the expression pattern is
<em>refutable</em>.</p>
<p>The distinction is useful in reasoning about which patterns should be
allowed in which contexts. For example, the structured bindings
declaration is conceptually a restricted form of pattern matching. With
the introduction of expression pattern in this paper, some may question
whether structured bindings declaration should be extended for examples
such as <code class="sourceCode default">auto [0, x] = f();</code>.</p>
<p>This is ultimately a question of whether structured bindings
declaration supports <em>refutable</em> patterns or if it is restricted
to <em>irrefutable</em> patterns.</p>
<h1 data-number="14" id="proposed-wording"><span class="header-section-number">14</span> Proposed Wording<a href="#proposed-wording" class="self-link"></a></h1>
<p>The following is the beginning of an attempt at a syntactic
structure.</p>
<p>Add to <strong>§8.4 [stmt.select]</strong> of …</p>
<p>Selection statements choose one of several flows of control.</p>
<blockquote>
<div class="line-block"><em>selection-statement:</em><br />
    <code class="sourceCode default">if constexpr</code><em><sub>opt</sub></em>
<code class="sourceCode default">(</code>
<em>init-statement<sub>opt</sub></em> <em>condition</em>
<code class="sourceCode default">)</code> <em>statement</em><br />
    <code class="sourceCode default">if constexpr</code><em><sub>opt</sub></em>
<code class="sourceCode default">(</code>
<em>init-statement<sub>opt</sub></em> <em>condition</em>
<code class="sourceCode default">)</code> <em>statement</em>
<code class="sourceCode default">else</code> <em>statement</em><br />
    <code class="sourceCode default">switch (</code>
<em>init-statement<sub>opt</sub></em> <em>condition</em>
<code class="sourceCode default">)</code> <em>statement</em><br />
    [<code class="sourceCode default">inspect constexpr</code><em><sub>opt</sub></em>
<code class="sourceCode default">(</code>
<em>init-statement<sub>opt</sub></em> <em>condition</em>
<code class="sourceCode default">)</code>
<em>trailing-return-type<sub>opt</sub></em>
<code class="sourceCode default">{</code></div>
<p><em>inspect-case-seq</em>
<code class="sourceCode default">}</code>]{.add}</p>
</blockquote>
<blockquote>
<div class="add" style="color: #006e28">

<div class="line-block"><em>inspect-case-seq:</em><br />
    <em>inspect-statement-case-seq</em><br />
    <em>inspect-expression-case-seq</em></div>
<div class="line-block"><em>inspect-statement-case-seq:</em><br />
    <em>inspect-statement-case</em><br />
    <em>inspect-statement-case-seq</em>
<em>inspect-statement-case</em></div>
<div class="line-block"><em>inspect-expression-case-seq:</em><br />
    <em>inspect-expression-case</em><br />
    <em>inspect-expression-case-seq</em>
<code class="sourceCode default">,</code>
<em>inspect-expression-case</em></div>
<div class="line-block"><em>inspect-statement-case:</em><br />
    <em>inspect-pattern</em> <em>inspect-guard<sub>opt</sub></em>
<code class="sourceCode default">=&gt;</code> <em>statement</em></div>
<div class="line-block"><em>inspect-expression-case:</em><br />
    <em>inspect-pattern</em> <em>inspect-guard<sub>opt</sub></em>
<code class="sourceCode default">=&gt;</code>
<em>assignment-expression</em></div>
<div class="line-block"><em>inspect-pattern:</em><br />
    <em>alternative-pattern</em><br />
    <em>case-pattern</em><br />
    <em>dereference-pattern</em><br />
    <em>expression-pattern</em><br />
    <em>extractor-pattern</em><br />
    <em>identifier-pattern</em><br />
    <em>structured-binding-pattern</em><br />
    <em>wildcard-pattern</em></div>
<div class="line-block"><em>inspect-guard:</em><br />
    <code class="sourceCode default">if (</code> <em>expression</em>
<code class="sourceCode default">)</code></div>

</div>
</blockquote>
<p>Change <strong>§9.1 [dcl.dcl]</strong></p>
<blockquote>
<div class="line-block"><em>simple-declaration:</em><br />
    <em>decl-specifier-seq</em>
<em>init-declarator-list<sub>opt</sub></em>
<code class="sourceCode default">;</code><br />
    <em>attribute-specifier-seq</em> <em>decl-specifier-seq</em>
<em>init-declarator-list</em>
<code class="sourceCode default">;</code><br />
    [<em>attribute-specifier-seq<sub>opt</sub></em>
<em>decl-specifier-seq</em> <em>ref-qualifier<sub>opt</sub></em>
<code class="sourceCode default">[</code> <em>identifier-list</em>
<code class="sourceCode default">]</code></div>
<p><em>initializer</em> <code class="sourceCode default">;</code>]{.rm}
| <span class="add" style="color: #006e28"><ins><em>attribute-specifier-seq<sub>opt</sub></em>
<em>decl-specifier-seq</em> <em>ref-qualifier<sub>opt</sub></em>
<em>structured-binding-pattern</em> <em>initializer</em>
<span><code class="sourceCode default">;</code></span></ins></span></p>
</blockquote>
<h1 data-number="15" id="design-decisions-1"><span class="header-section-number">15</span> Design Decisions<a href="#design-decisions-1" class="self-link"></a></h1>
<h2 data-number="15.1" id="wildcard-pattern-1"><span class="header-section-number">15.1</span> Wildcard Pattern<a href="#wildcard-pattern-1" class="self-link"></a></h2>
<p>This paper proposes that <code class="sourceCode default">_</code> be
used as the wildcard pattern.</p>
<p>// TODO</p>
<h2 data-number="15.2" id="extending-structured-bindings-declaration"><span class="header-section-number">15.2</span> Extending Structured Bindings
Declaration<a href="#extending-structured-bindings-declaration" class="self-link"></a></h2>
<p>The design is intended to be consistent and to naturally extend the
notions introduced by structured bindings. That is, The subobjects are
<strong>referred</strong> to rather than being assigned into new
variables.</p>
<p>We propose any <strong>irrefutable</strong> pattern to be
<strong>allowed</strong> in structured binding declaration, as it does
not introduce any new behaviour. A separate paper will explore
possibility of allowing <strong>refutable</strong> patterns to be used
in declarations.</p>
<h2 data-number="15.3" id="inspect-rather-than-switch"><span class="header-section-number">15.3</span>
<code class="sourceCode default">inspect</code> rather than
<code class="sourceCode default">switch</code><a href="#inspect-rather-than-switch" class="self-link"></a></h2>
<p>This proposal introduces a new
<code class="sourceCode default">inspect</code> statement rather than
trying to extend the <code class="sourceCode default">switch</code>
statement. <span class="citation" data-cites="P0095R0">[<a href="#ref-P0095R0" role="doc-biblioref">P0095R0</a>]</span> had
proposed extending <code class="sourceCode default">switch</code> and
received feedback to “leave
<code class="sourceCode default">switch</code> alone” in Kona 2015.</p>
<p>The following are some of the reasons considered:</p>
<ul>
<li><code class="sourceCode default">switch</code> allows the
<code class="sourceCode default">case</code> labels to appear
<strong>anywhere</strong>, which hinders the goal of pattern matching in
providing <strong>structured</strong> inspection.</li>
<li>The fall-through semantics of
<code class="sourceCode default">switch</code> generally results in
<code class="sourceCode default">break</code> being attached to every
case, and is known to be error-prone.</li>
<li><code class="sourceCode default">switch</code> is purposely
restricted to integrals for <strong>guaranteed</strong> efficiency. The
primary goal of pattern matching in this paper is expressiveness while
being at least as efficient as the naively hand-written code.</li>
</ul>
<h2 data-number="15.4" id="first-match-rather-than-best-match"><span class="header-section-number">15.4</span> First Match rather than Best
Match<a href="#first-match-rather-than-best-match" class="self-link"></a></h2>
<p>The proposed matching algorithm has first match semantics. The choice
of first match is mainly due to complexity. Our overload resolution
rules for function declarations are extremely complex and is often a
mystery.</p>
<p>Best match via overload resolution for function declarations are
absolutely necessary due to the non-local and unordered nature of
declarations. That is, function declarations live in different files and
get pulled in via mechanisms such as
<code class="sourceCode default">#include</code> and
<code class="sourceCode default">using</code> declarations, and there is
no defined order of declarations like Haskell does, for example. If
function dispatching depended on the order of
<code class="sourceCode default">#include</code> and/or
<code class="sourceCode default">using</code> declarations being pulled
in from hundreds of files, it would be a complete disaster.</p>
<p>Pattern matching on the other hand do not have this problem because
the construct is local and ordered in nature. That is, all of the
candidate patterns appear locally within
<code class="sourceCode default">inspect (x) { /* ... */ }</code> which
cannot span across multiple files, and appear in a specified order. This
is consistent with
<code class="sourceCode default">try</code>/<code class="sourceCode default">catch</code>
for the same reasons: locality and order.</p>
<p>Consider also the amount of limitations we face in overload
resolution due to the opacity of user-defined types.
<code class="sourceCode default">T*</code> is related to
<code class="sourceCode default">unique_ptr&lt;T&gt;</code> as it is to
<code class="sourceCode default">vector&lt;T&gt;</code> as far as the
type system is concerned. This limitation will likely be even bigger in
a pattern matching context with the amount of customization points
available for user-defined behavior.</p>
<h2 data-number="15.5" id="unrestricted-side-effects"><span class="header-section-number">15.5</span> Unrestricted Side Effects<a href="#unrestricted-side-effects" class="self-link"></a></h2>
<p>We considered the possibility of restricting side-effects within
patterns. Specifically whether modifying the value currently being
matched in the middle of evaluation should have defined behavior.</p>
<p>The consideration was due to potential optimization
opportunities.</p>
<div class="sourceCode" id="cb69"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a><span class="dt">bool</span> f<span class="op">(</span><span class="dt">int</span> <span class="op">&amp;)</span>;  <span class="co">// defined in a different translation unit.</span></span>
<span id="cb69-2"><a href="#cb69-2" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> x <span class="op">=</span> <span class="dv">1</span>;</span>
<span id="cb69-3"><a href="#cb69-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-4"><a href="#cb69-4" aria-hidden="true" tabindex="-1"></a>inspect <span class="op">(</span>x<span class="op">)</span> <span class="op">{</span></span>
<span id="cb69-5"><a href="#cb69-5" aria-hidden="true" tabindex="-1"></a>  <span class="dv">0</span> <span class="op">=&gt;</span> <span class="op">{</span> std<span class="op">::</span>cout <span class="op">&lt;&lt;</span> <span class="dv">0</span>; <span class="op">}</span></span>
<span id="cb69-6"><a href="#cb69-6" aria-hidden="true" tabindex="-1"></a>  <span class="dv">1</span> <span class="cf">if</span> <span class="op">(</span>f<span class="op">(</span>x<span class="op">))</span> <span class="op">=&gt;</span> <span class="op">{</span> std<span class="op">::</span>cout <span class="op">&lt;&lt;</span> <span class="dv">1</span>; <span class="op">}</span></span>
<span id="cb69-7"><a href="#cb69-7" aria-hidden="true" tabindex="-1"></a>  <span class="dv">2</span> <span class="op">=&gt;</span> <span class="op">{</span> std<span class="op">::</span>cout <span class="op">&lt;&lt;</span> <span class="dv">2</span>; <span class="op">}</span></span>
<span id="cb69-8"><a href="#cb69-8" aria-hidden="true" tabindex="-1"></a><span class="op">}</span>;</span></code></pre></div>
<p>If modifying the value currently being matched has undefined
behavior, a compiler can assume that
<code class="sourceCode default">f</code> (defined in a different
translation unit) will not change the value of
<code class="sourceCode default">x</code>. This means that the compiler
can generate code that uses a jump table to determine which of the
patterns match.</p>
<p>If on the other hand <code class="sourceCode default">f</code> may
change the value of <code class="sourceCode default">x</code>, the
compiler would be forced to generated code checks the patterns in
sequence, since a subsequent pattern may match the updated value of
<code class="sourceCode default">x</code>.</p>
<p>The following are <strong>illustrations</strong> of the two
approaches written in C++:</p>
<table>
<colgroup>
<col style="width: 55%" />
<col style="width: 48%" />
</colgroup>
<thead>
<tr class="header">
<th><div style="text-align:center">
<strong>Not allowed to modify</strong>
</div></th>
<th><div style="text-align:center">
<strong>Allowed to modify</strong>
</div></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><div>

<div class="sourceCode" id="cb70"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a><span class="dt">bool</span> f<span class="op">(</span><span class="dt">int</span> <span class="op">&amp;)</span>;</span>
<span id="cb70-2"><a href="#cb70-2" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> x <span class="op">=</span> <span class="dv">1</span>;</span>
<span id="cb70-3"><a href="#cb70-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-4"><a href="#cb70-4" aria-hidden="true" tabindex="-1"></a><span class="cf">switch</span> <span class="op">(</span>x<span class="op">)</span> <span class="op">{</span></span>
<span id="cb70-5"><a href="#cb70-5" aria-hidden="true" tabindex="-1"></a>  <span class="cf">case</span> <span class="dv">0</span><span class="op">:</span> std<span class="op">::</span>cout <span class="op">&lt;&lt;</span> <span class="dv">0</span>; <span class="cf">break</span>;</span>
<span id="cb70-6"><a href="#cb70-6" aria-hidden="true" tabindex="-1"></a>  <span class="cf">case</span> <span class="dv">1</span><span class="op">:</span> <span class="cf">if</span> <span class="op">(</span>f<span class="op">(</span>x<span class="op">))</span> <span class="op">{</span> std<span class="op">::</span>cout <span class="op">&lt;&lt;</span> <span class="dv">1</span>; <span class="op">}</span> <span class="cf">break</span>;</span>
<span id="cb70-7"><a href="#cb70-7" aria-hidden="true" tabindex="-1"></a>  <span class="cf">case</span> <span class="dv">2</span><span class="op">:</span> std<span class="op">::</span>cout <span class="op">&lt;&lt;</span> <span class="dv">2</span>; <span class="cf">break</span>;</span>
<span id="cb70-8"><a href="#cb70-8" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>

</div></td>
<td><div>

<div class="sourceCode" id="cb71"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a><span class="dt">bool</span> f<span class="op">(</span><span class="dt">int</span> <span class="op">&amp;)</span>;</span>
<span id="cb71-2"><a href="#cb71-2" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> x <span class="op">=</span> <span class="dv">1</span>;</span>
<span id="cb71-3"><a href="#cb71-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-4"><a href="#cb71-4" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="op">(</span>x <span class="op">==</span> <span class="dv">0</span><span class="op">)</span> std<span class="op">::</span>cout <span class="op">&lt;&lt;</span> <span class="dv">0</span>;</span>
<span id="cb71-5"><a href="#cb71-5" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span> <span class="cf">if</span> <span class="op">(</span>x <span class="op">==</span> <span class="dv">1</span> <span class="op">&amp;&amp;</span> f<span class="op">(</span>x<span class="op">))</span> std<span class="op">::</span>cout <span class="op">&lt;&lt;</span> <span class="dv">1</span>;</span>
<span id="cb71-6"><a href="#cb71-6" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span> <span class="cf">if</span> <span class="op">(</span>x <span class="op">==</span> <span class="dv">2</span><span class="op">)</span> std<span class="op">::</span>cout <span class="op">&lt;&lt;</span> <span class="dv">2</span>;</span></code></pre></div>

</div></td>
</tr>
</tbody>
</table>
<p>However, we consider this opportunity too niche. Suppose we have a
slightly more complex case:
<code class="sourceCode default">struct S { int x; };</code> and <code class="sourceCode default">bool operator==(const S&amp;, const S&amp;);</code>.
Even if modifying the value being matched has undefined behavior, if the
<code class="sourceCode default">operator==</code> is defined in a
different translation unit, a compiler cannot do much more than generate
code that checks the patterns in sequence anyway.</p>
<h2 data-number="15.6" id="language-rather-than-library"><span class="header-section-number">15.6</span> Language rather than Library<a href="#language-rather-than-library" class="self-link"></a></h2>
<p>There are three popular pattern matching libraries for C++ today:
<span class="citation" data-cites="Mach7">[<a href="#ref-Mach7" role="doc-biblioref">Mach7</a>]</span>, <span class="citation" data-cites="Patterns">[<a href="#ref-Patterns" role="doc-biblioref">Patterns</a>]</span>, and <span class="citation" data-cites="SimpleMatch">[<a href="#ref-SimpleMatch" role="doc-biblioref">SimpleMatch</a>]</span>.</p>
<p>While the libraries have been useful for gaining experience with
interfaces and implementation, the issue of introducing identifiers,
syntactic overhead of the patterns, and the reduced optimization
opportunities justify support as a language feature from a usability
standpoint.</p>
<h2 data-number="15.7" id="matchers-and-extractors"><span class="header-section-number">15.7</span> Matchers and Extractors<a href="#matchers-and-extractors" class="self-link"></a></h2>
<p>Many languages provide a wide array of patterns through various
syntactic forms. While this is a potential direction for C++, it would
mean that every new type of matching requires new syntax to be added to
the language. This would result in a narrow set of types being supported
through limited customization points.</p>
<p>Matchers and extractors are supported in order to minimize the number
of patterns with special syntax. The following are example matchers and
extractors that commonly have special syntax in other languages.</p>
<table style="width:71%;">
<colgroup>
<col style="width: 40%" />
<col style="width: 30%" />
</colgroup>
<thead>
<tr class="header">
<th><div style="text-align:center">
<strong><strong>Matchers / Extractors</strong></strong>
</div></th>
<th><div style="text-align:center">
<strong><strong>Other Languages</strong></strong>
</div></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code class="sourceCode default">any_of{1, 2, 3}</code></td>
<td><code class="sourceCode default">1 | 2 | 3</code></td>
</tr>
<tr class="even">
<td><code class="sourceCode default">within{1, 10}</code></td>
<td><code class="sourceCode default">1..10</code></td>
</tr>
<tr class="odd">
<td><code class="sourceCode default">(both!) [[x, 0], [0, y]]</code></td>
<td><code class="sourceCode default">[x, 0] &amp; [0, y]</code></td>
</tr>
<tr class="even">
<td><code class="sourceCode default">(at!) [p, [x, y]]</code></td>
<td><code class="sourceCode default">p @ [x, y]</code></td>
</tr>
</tbody>
</table>
<p>Each of the matchers and extractors can be found in the <a href="#examples">Examples</a> section. The example extractors and
matchers are not proposed for standardisation in this paper, and
presented just for demonstration.</p>
<h2 data-number="15.8" id="expression-vs-pattern-disambiguation"><span class="header-section-number">15.8</span> Expression vs Pattern
Disambiguation<a href="#expression-vs-pattern-disambiguation" class="self-link"></a></h2>
<p><span class="citation" data-cites="P1371R0">[<a href="#ref-P1371R0" role="doc-biblioref">P1371R0</a>]</span> had proposed a unary
<code class="sourceCode default">^</code> as an “expression introducer”.
The main motivation was to leave the design space open for patterns that
look like expressions. For example, many languages spell the alternation
pattern with <code class="sourceCode default">|</code>, resulting in a
pattern such as <code class="sourceCode default">1 | 2</code> which
means “match <code class="sourceCode default">1</code> or
<code class="sourceCode default">2</code>”. However, to allow such a
pattern a disambiguation mechanism would be required since
<code class="sourceCode default">1 | 2</code> is already a valid
expression today.</p>
<p>That paper also included what is called a dereference pattern with
the syntax of <code class="sourceCode default">*</code>
<em>pattern</em>. There was clear guidance from EWG to change the syntax
of this pattern due to confusion with the existing dereference operator.
As such, the design direction proposed in this paper is to allow
expressions in patterns without an introducer, and to require that new
patterns be syntactically unambiguous with an expression in general.</p>
<p>The following is a flow graph of decisions that need to be made:</p>
<h2 data-number="15.9" id="forbid-break-inside-inspect-expression"><span class="header-section-number">15.9</span> Forbid
<code class="sourceCode default">break</code> inside
<code class="sourceCode default">inspect</code> expression<a href="#forbid-break-inside-inspect-expression" class="self-link"></a></h2>
<p>Since <code class="sourceCode default">inspect</code> is always an
expression we decided to forbid using
<code class="sourceCode default">break</code> keyword inside
<code class="sourceCode default">inspect</code> expressions.</p>
<p>The problem lies with two possible use cases where
<code class="sourceCode default">inspect</code> would be used.</p>
<div class="sourceCode" id="cb72"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb72-1"><a href="#cb72-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> <span class="op">(</span><span class="kw">const</span> <span class="kw">auto</span><span class="op">&amp;</span> el<span class="op">:</span> some_vec<span class="op">)</span> <span class="op">{</span></span>
<span id="cb72-2"><a href="#cb72-2" aria-hidden="true" tabindex="-1"></a>  <span class="co">// If-else-if chain</span></span>
<span id="cb72-3"><a href="#cb72-3" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(</span>el<span class="op">.</span>type<span class="op">()</span> <span class="op">==</span> <span class="st">&quot;NotInteresting&quot;</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb72-4"><a href="#cb72-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">break</span>;</span>
<span id="cb72-5"><a href="#cb72-5" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span> <span class="cf">else</span> <span class="cf">if</span> <span class="op">(</span>el<span class="op">.</span>type<span class="op">()</span> <span class="op">==</span> <span class="st">&quot;SomeOther&quot;</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb72-6"><a href="#cb72-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">break</span>;</span>
<span id="cb72-7"><a href="#cb72-7" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb72-8"><a href="#cb72-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-9"><a href="#cb72-9" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Switch statement</span></span>
<span id="cb72-10"><a href="#cb72-10" aria-hidden="true" tabindex="-1"></a>  <span class="cf">switch</span> <span class="op">(</span>el<span class="op">.</span>value<span class="op">())</span> <span class="op">{</span></span>
<span id="cb72-11"><a href="#cb72-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> <span class="dv">1</span><span class="op">:</span> <span class="co">/* ... */</span></span>
<span id="cb72-12"><a href="#cb72-12" aria-hidden="true" tabindex="-1"></a>      <span class="cf">break</span>; <span class="co">// no fallthrough</span></span>
<span id="cb72-13"><a href="#cb72-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> <span class="dv">2</span><span class="op">:</span> <span class="co">/* ... */</span></span>
<span id="cb72-14"><a href="#cb72-14" aria-hidden="true" tabindex="-1"></a>      <span class="cf">break</span>; <span class="co">// no fallthrough</span></span>
<span id="cb72-15"><a href="#cb72-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">default</span><span class="op">:</span></span>
<span id="cb72-16"><a href="#cb72-16" aria-hidden="true" tabindex="-1"></a>      <span class="co">/* ... */</span></span>
<span id="cb72-17"><a href="#cb72-17" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb72-18"><a href="#cb72-18" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>In the example above, if we’re replacing existing
<code class="sourceCode default">switch</code> statement,
<code class="sourceCode default">break</code> is used to terminate
current statement sequence and jump to first statement after the
<code class="sourceCode default">switch</code>. In particular it is
required to prevent fallthrough.</p>
<p>If the code being replaced is a sequence of if-else branches,
<code class="sourceCode default">break</code> there would indicate
iteration stop for the enclosing loop.</p>
<p>Both use cases are interesting and valid for
<code class="sourceCode default">inspect</code>, but resulting
<code class="sourceCode default">break</code> behaviour differs. If we
were to adopt one, the other use case would be prone to error. So for
now we decided to forbid using
<code class="sourceCode default">break</code> statements inside
<code class="sourceCode default">inspect</code> expression branches.</p>
<p>Note, it is generally desirable to be able to yield from
<code class="sourceCode default">inspect</code> expression branch early,
but currently there is no syntax that would allow specifying yield value
with <code class="sourceCode default">break</code> statement
(i.e. <code class="sourceCode default">break 2;</code>). We think this
behaviour is valuable, but not crucial for this proposal.</p>
<h1 data-number="16" id="runtime-performance"><span class="header-section-number">16</span> Runtime Performance<a href="#runtime-performance" class="self-link"></a></h1>
<p>The following are few of the optimizations that are worth noting.</p>
<h2 data-number="16.1" id="structured-binding-patterns"><span class="header-section-number">16.1</span> Structured Binding Patterns<a href="#structured-binding-patterns" class="self-link"></a></h2>
<p>Structured binding patterns can be optimized by performing
<code class="sourceCode default">switch</code> over the columns with the
duplicates removed, rather than the naive approach of performing a
comparison per element. This removes unnecessary duplicate comparisons
that would be performed otherwise. This would likely require some
wording around “comparison elision” in order to enable such
optimizations.</p>
<h2 data-number="16.2" id="alternative-patterns"><span class="header-section-number">16.2</span> Alternative Patterns<a href="#alternative-patterns" class="self-link"></a></h2>
<p>The sequence of alternative patterns can be executed in a
<code class="sourceCode default">switch</code>.</p>
<h2 data-number="16.3" id="open-class-hierarchy"><span class="header-section-number">16.3</span> Open Class Hierarchy<a href="#open-class-hierarchy" class="self-link"></a></h2>
<p><span class="citation" data-cites="N3449">[<a href="#ref-N3449" role="doc-biblioref">N3449</a>]</span> describes techniques involving
vtable pointer caching and hash conflict minimization that are
implemented in the <span class="citation" data-cites="Mach7">[<a href="#ref-Mach7" role="doc-biblioref">Mach7</a>]</span> library, but
also mentions further opportunities available for a compiler
solution.</p>
<h1 data-number="17" id="examples"><span class="header-section-number">17</span> Examples<a href="#examples" class="self-link"></a></h1>
<h2 data-number="17.1" id="predicate-based-discriminator"><span class="header-section-number">17.1</span> Predicate-based
Discriminator<a href="#predicate-based-discriminator" class="self-link"></a></h2>
<p>Short-string optimization using a <strong>predicate</strong> as a
discriminator rather than an explicitly stored <strong>value</strong>.
Adapted from Bjarne Stroustrup’s pattern matching presentation at
Urbana-Champaign 2014 <span class="citation" data-cites="PatMatPres">[<a href="#ref-PatMatPres" role="doc-biblioref">PatMatPres</a>]</span>.</p>
<div class="sourceCode" id="cb73"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true" tabindex="-1"></a><span class="kw">struct</span> String <span class="op">{</span></span>
<span id="cb73-2"><a href="#cb73-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">enum</span> Storage <span class="op">{</span> Local, Remote <span class="op">}</span>;</span>
<span id="cb73-3"><a href="#cb73-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-4"><a href="#cb73-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span> size;</span>
<span id="cb73-5"><a href="#cb73-5" aria-hidden="true" tabindex="-1"></a>  <span class="kw">union</span> <span class="op">{</span></span>
<span id="cb73-6"><a href="#cb73-6" aria-hidden="true" tabindex="-1"></a>    <span class="dt">char</span> local<span class="op">[</span><span class="dv">32</span><span class="op">]</span>;</span>
<span id="cb73-7"><a href="#cb73-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">struct</span> <span class="op">{</span> <span class="dt">char</span> <span class="op">*</span>ptr; <span class="dt">int</span> unused_allocated_space; <span class="op">}</span> remote;</span>
<span id="cb73-8"><a href="#cb73-8" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span>;</span>
<span id="cb73-9"><a href="#cb73-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-10"><a href="#cb73-10" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Predicate-based discriminator derived from `size`.</span></span>
<span id="cb73-11"><a href="#cb73-11" aria-hidden="true" tabindex="-1"></a>  Storage index<span class="op">()</span> <span class="kw">const</span> <span class="op">{</span> <span class="cf">return</span> size <span class="op">&gt;</span> <span class="kw">sizeof</span><span class="op">(</span>local<span class="op">)</span> <span class="op">?</span> Remote <span class="op">:</span> Local; <span class="op">}</span></span>
<span id="cb73-12"><a href="#cb73-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-13"><a href="#cb73-13" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Opt into Variant-Like protocol.</span></span>
<span id="cb73-14"><a href="#cb73-14" aria-hidden="true" tabindex="-1"></a>  <span class="kw">template</span> <span class="op">&lt;</span>Storage S<span class="op">&gt;</span></span>
<span id="cb73-15"><a href="#cb73-15" aria-hidden="true" tabindex="-1"></a>  <span class="kw">auto</span> <span class="op">&amp;&amp;</span>get<span class="op">()</span> <span class="op">{</span></span>
<span id="cb73-16"><a href="#cb73-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">constexpr</span> <span class="op">(</span>S <span class="op">==</span> Local<span class="op">)</span> <span class="cf">return</span> local;</span>
<span id="cb73-17"><a href="#cb73-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span> <span class="cf">if</span> <span class="kw">constexpr</span> <span class="op">(</span>S <span class="op">==</span> Remote<span class="op">)</span> <span class="cf">return</span> remote;</span>
<span id="cb73-18"><a href="#cb73-18" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb73-19"><a href="#cb73-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-20"><a href="#cb73-20" aria-hidden="true" tabindex="-1"></a>  <span class="dt">char</span> <span class="op">*</span>data<span class="op">()</span>;</span>
<span id="cb73-21"><a href="#cb73-21" aria-hidden="true" tabindex="-1"></a><span class="op">}</span>;</span>
<span id="cb73-22"><a href="#cb73-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-23"><a href="#cb73-23" aria-hidden="true" tabindex="-1"></a><span class="kw">namespace</span> std <span class="op">{</span></span>
<span id="cb73-24"><a href="#cb73-24" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Opt into Variant-Like protocol.</span></span>
<span id="cb73-25"><a href="#cb73-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-26"><a href="#cb73-26" aria-hidden="true" tabindex="-1"></a>  <span class="kw">template</span> <span class="op">&lt;&gt;</span></span>
<span id="cb73-27"><a href="#cb73-27" aria-hidden="true" tabindex="-1"></a>  <span class="kw">struct</span> variant_size<span class="op">&lt;</span>String<span class="op">&gt;</span> <span class="op">:</span> std<span class="op">::</span>integral_constant<span class="op">&lt;</span>std<span class="op">::</span><span class="dt">size_t</span>, <span class="dv">2</span><span class="op">&gt;</span> <span class="op">{}</span>;</span>
<span id="cb73-28"><a href="#cb73-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-29"><a href="#cb73-29" aria-hidden="true" tabindex="-1"></a>  <span class="kw">template</span> <span class="op">&lt;&gt;</span></span>
<span id="cb73-30"><a href="#cb73-30" aria-hidden="true" tabindex="-1"></a>  <span class="kw">struct</span> variant_alternative<span class="op">&lt;</span>String<span class="op">::</span>Local, String<span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb73-31"><a href="#cb73-31" aria-hidden="true" tabindex="-1"></a>    <span class="kw">using</span> type <span class="op">=</span> <span class="kw">decltype</span><span class="op">(</span>String<span class="op">::</span>local<span class="op">)</span>;</span>
<span id="cb73-32"><a href="#cb73-32" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span>;</span>
<span id="cb73-33"><a href="#cb73-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-34"><a href="#cb73-34" aria-hidden="true" tabindex="-1"></a>  <span class="kw">template</span> <span class="op">&lt;&gt;</span></span>
<span id="cb73-35"><a href="#cb73-35" aria-hidden="true" tabindex="-1"></a>  <span class="kw">struct</span> variant_alternative<span class="op">&lt;</span>String<span class="op">::</span>Remote, String<span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb73-36"><a href="#cb73-36" aria-hidden="true" tabindex="-1"></a>    <span class="kw">using</span> type <span class="op">=</span> <span class="kw">decltype</span><span class="op">(</span>String<span class="op">::</span>remote<span class="op">)</span>;</span>
<span id="cb73-37"><a href="#cb73-37" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span>;</span>
<span id="cb73-38"><a href="#cb73-38" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb73-39"><a href="#cb73-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-40"><a href="#cb73-40" aria-hidden="true" tabindex="-1"></a><span class="dt">char</span><span class="op">*</span> String<span class="op">::</span>data<span class="op">()</span> <span class="op">{</span></span>
<span id="cb73-41"><a href="#cb73-41" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> inspect <span class="op">(*</span><span class="kw">this</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb73-42"><a href="#cb73-42" aria-hidden="true" tabindex="-1"></a>    <span class="op">&lt;</span>Local<span class="op">&gt;</span> l <span class="op">=&gt;</span> l;</span>
<span id="cb73-43"><a href="#cb73-43" aria-hidden="true" tabindex="-1"></a>    <span class="op">&lt;</span>Remote<span class="op">&gt;</span> r <span class="op">=&gt;</span> r<span class="op">.</span>ptr;</span>
<span id="cb73-44"><a href="#cb73-44" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span>;</span>
<span id="cb73-45"><a href="#cb73-45" aria-hidden="true" tabindex="-1"></a>  <span class="co">// switch (index()) {</span></span>
<span id="cb73-46"><a href="#cb73-46" aria-hidden="true" tabindex="-1"></a>  <span class="co">//   case Local: {</span></span>
<span id="cb73-47"><a href="#cb73-47" aria-hidden="true" tabindex="-1"></a>  <span class="co">//     std::variant_alternative_t&lt;Local, String&gt;&amp; l = get&lt;Local&gt;();</span></span>
<span id="cb73-48"><a href="#cb73-48" aria-hidden="true" tabindex="-1"></a>  <span class="co">//     return l;</span></span>
<span id="cb73-49"><a href="#cb73-49" aria-hidden="true" tabindex="-1"></a>  <span class="co">//   }</span></span>
<span id="cb73-50"><a href="#cb73-50" aria-hidden="true" tabindex="-1"></a>  <span class="co">//   case Remote: {</span></span>
<span id="cb73-51"><a href="#cb73-51" aria-hidden="true" tabindex="-1"></a>  <span class="co">//     std::variant_alternative_t&lt;Remote, String&gt;&amp; r = get&lt;Remote&gt;();</span></span>
<span id="cb73-52"><a href="#cb73-52" aria-hidden="true" tabindex="-1"></a>  <span class="co">//     return r.ptr;</span></span>
<span id="cb73-53"><a href="#cb73-53" aria-hidden="true" tabindex="-1"></a>  <span class="co">//   }</span></span>
<span id="cb73-54"><a href="#cb73-54" aria-hidden="true" tabindex="-1"></a>  <span class="co">// }</span></span>
<span id="cb73-55"><a href="#cb73-55" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h2 data-number="17.2" id="closed-class-hierarchy"><span class="header-section-number">17.2</span> “Closed” Class Hierarchy<a href="#closed-class-hierarchy" class="self-link"></a></h2>
<p>A class hierarchy can effectively be closed with an
<code class="sourceCode default">enum</code> that maintains the list of
its members, and provide efficient dispatching by opting into the
Variant-Like protocol.</p>
<p>A generalized mechanism of pattern is used extensively in LLVM;
<code class="sourceCode default">llvm/Support/YAMLParser.h</code> <span class="citation" data-cites="YAMLParser">[<a href="#ref-YAMLParser" role="doc-biblioref">YAMLParser</a>]</span> is an example.</p>
<div class="sourceCode" id="cb74"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb74-1"><a href="#cb74-1" aria-hidden="true" tabindex="-1"></a><span class="kw">struct</span> Shape <span class="op">{</span> <span class="kw">enum</span> Kind <span class="op">{</span> Circle, Rectangle <span class="op">}</span> kind; <span class="op">}</span>;</span>
<span id="cb74-2"><a href="#cb74-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-3"><a href="#cb74-3" aria-hidden="true" tabindex="-1"></a><span class="kw">struct</span> Circle <span class="op">:</span> Shape <span class="op">{</span></span>
<span id="cb74-4"><a href="#cb74-4" aria-hidden="true" tabindex="-1"></a>  Circle<span class="op">(</span><span class="dt">int</span> radius<span class="op">)</span> <span class="op">:</span> Shape<span class="op">{</span>Shape<span class="op">::</span>Kind<span class="op">::</span>Circle<span class="op">}</span>, radius<span class="op">(</span>radius<span class="op">)</span> <span class="op">{}</span></span>
<span id="cb74-5"><a href="#cb74-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-6"><a href="#cb74-6" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span> radius;</span>
<span id="cb74-7"><a href="#cb74-7" aria-hidden="true" tabindex="-1"></a><span class="op">}</span>;</span>
<span id="cb74-8"><a href="#cb74-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-9"><a href="#cb74-9" aria-hidden="true" tabindex="-1"></a><span class="kw">struct</span> Rectangle <span class="op">:</span> Shape <span class="op">{</span></span>
<span id="cb74-10"><a href="#cb74-10" aria-hidden="true" tabindex="-1"></a>  Rectangle<span class="op">(</span><span class="dt">int</span> width, <span class="dt">int</span> height<span class="op">)</span></span>
<span id="cb74-11"><a href="#cb74-11" aria-hidden="true" tabindex="-1"></a>    <span class="op">:</span> Shape<span class="op">{</span>Shape<span class="op">::</span>Kind<span class="op">::</span>Rectangle<span class="op">}</span>, width<span class="op">(</span>width<span class="op">)</span>, height<span class="op">(</span>height<span class="op">)</span> <span class="op">{}</span></span>
<span id="cb74-12"><a href="#cb74-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-13"><a href="#cb74-13" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span> width, height;</span>
<span id="cb74-14"><a href="#cb74-14" aria-hidden="true" tabindex="-1"></a><span class="op">}</span>;</span>
<span id="cb74-15"><a href="#cb74-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-16"><a href="#cb74-16" aria-hidden="true" tabindex="-1"></a><span class="kw">namespace</span> std <span class="op">{</span></span>
<span id="cb74-17"><a href="#cb74-17" aria-hidden="true" tabindex="-1"></a>  <span class="kw">template</span> <span class="op">&lt;&gt;</span></span>
<span id="cb74-18"><a href="#cb74-18" aria-hidden="true" tabindex="-1"></a>  <span class="kw">struct</span> variant_size<span class="op">&lt;</span>Shape<span class="op">&gt;</span> <span class="op">:</span> std<span class="op">::</span>integral_constant<span class="op">&lt;</span>std<span class="op">::</span><span class="dt">size_t</span>, <span class="dv">2</span><span class="op">&gt;</span> <span class="op">{}</span>;</span>
<span id="cb74-19"><a href="#cb74-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-20"><a href="#cb74-20" aria-hidden="true" tabindex="-1"></a>  <span class="kw">template</span> <span class="op">&lt;&gt;</span></span>
<span id="cb74-21"><a href="#cb74-21" aria-hidden="true" tabindex="-1"></a>  <span class="kw">struct</span> variant_alternative<span class="op">&lt;</span>Shape<span class="op">::</span>Circle, Shape<span class="op">&gt;</span> <span class="op">{</span> <span class="kw">using</span> type <span class="op">=</span> Circle; <span class="op">}</span>;</span>
<span id="cb74-22"><a href="#cb74-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-23"><a href="#cb74-23" aria-hidden="true" tabindex="-1"></a>  <span class="kw">template</span> <span class="op">&lt;&gt;</span></span>
<span id="cb74-24"><a href="#cb74-24" aria-hidden="true" tabindex="-1"></a>  <span class="kw">struct</span> variant_alternative<span class="op">&lt;</span>Shape<span class="op">::</span>Rectangle, Shape<span class="op">&gt;</span> <span class="op">{</span> <span class="kw">using</span> type <span class="op">=</span> Rectangle; <span class="op">}</span>;</span>
<span id="cb74-25"><a href="#cb74-25" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb74-26"><a href="#cb74-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-27"><a href="#cb74-27" aria-hidden="true" tabindex="-1"></a>Shape<span class="op">::</span>Kind index<span class="op">(</span><span class="kw">const</span> Shape<span class="op">&amp;</span> shape<span class="op">)</span> <span class="op">{</span> <span class="cf">return</span> shape<span class="op">.</span>kind; <span class="op">}</span></span>
<span id="cb74-28"><a href="#cb74-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-29"><a href="#cb74-29" aria-hidden="true" tabindex="-1"></a><span class="kw">template</span> <span class="op">&lt;</span>Kind K<span class="op">&gt;</span></span>
<span id="cb74-30"><a href="#cb74-30" aria-hidden="true" tabindex="-1"></a><span class="kw">auto</span><span class="op">&amp;&amp;</span> get<span class="op">(</span><span class="kw">const</span> Shape<span class="op">&amp;</span> shape<span class="op">)</span> <span class="op">{</span></span>
<span id="cb74-31"><a href="#cb74-31" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> <span class="kw">static_cast</span><span class="op">&lt;</span><span class="kw">const</span> std<span class="op">::</span>variant_alternative_t<span class="op">&lt;</span>K, Shape<span class="op">&gt;&amp;&gt;(</span>shape<span class="op">)</span>;</span>
<span id="cb74-32"><a href="#cb74-32" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb74-33"><a href="#cb74-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-34"><a href="#cb74-34" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> get_area<span class="op">(</span><span class="kw">const</span> Shape<span class="op">&amp;</span> shape<span class="op">)</span> <span class="op">{</span></span>
<span id="cb74-35"><a href="#cb74-35" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> inspect <span class="op">(</span>shape<span class="op">)</span> <span class="op">{</span></span>
<span id="cb74-36"><a href="#cb74-36" aria-hidden="true" tabindex="-1"></a>    <span class="op">&lt;</span>Circle<span class="op">&gt;</span> c <span class="op">=&gt;</span> <span class="fl">3.14</span> <span class="op">*</span> c<span class="op">.</span>radius <span class="op">*</span> c<span class="op">.</span>radius;</span>
<span id="cb74-37"><a href="#cb74-37" aria-hidden="true" tabindex="-1"></a>    <span class="op">&lt;</span>Rectangle<span class="op">&gt;</span> r <span class="op">=&gt;</span> r<span class="op">.</span>width <span class="op">*</span> r<span class="op">.</span>height;</span>
<span id="cb74-38"><a href="#cb74-38" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span>;</span>
<span id="cb74-39"><a href="#cb74-39" aria-hidden="true" tabindex="-1"></a>  <span class="co">// switch (index(shape)) {</span></span>
<span id="cb74-40"><a href="#cb74-40" aria-hidden="true" tabindex="-1"></a>  <span class="co">//   case Shape::Circle: {</span></span>
<span id="cb74-41"><a href="#cb74-41" aria-hidden="true" tabindex="-1"></a>  <span class="co">//     const std::variant_alternative_t&lt;Shape::Circle, Shape&gt;&amp; c =</span></span>
<span id="cb74-42"><a href="#cb74-42" aria-hidden="true" tabindex="-1"></a>  <span class="co">//         get&lt;Shape::Circle&gt;(shape);</span></span>
<span id="cb74-43"><a href="#cb74-43" aria-hidden="true" tabindex="-1"></a>  <span class="co">//     return 3.14 * c.radius * c.radius;</span></span>
<span id="cb74-44"><a href="#cb74-44" aria-hidden="true" tabindex="-1"></a>  <span class="co">//   }</span></span>
<span id="cb74-45"><a href="#cb74-45" aria-hidden="true" tabindex="-1"></a>  <span class="co">//   case Shape::Rectangle: {</span></span>
<span id="cb74-46"><a href="#cb74-46" aria-hidden="true" tabindex="-1"></a>  <span class="co">//     const std::variant_alternative_t&lt;Shape::Rectangle, Shape&gt;&amp; r =</span></span>
<span id="cb74-47"><a href="#cb74-47" aria-hidden="true" tabindex="-1"></a>  <span class="co">//         get&lt;Shape::Rectangle&gt;(shape);</span></span>
<span id="cb74-48"><a href="#cb74-48" aria-hidden="true" tabindex="-1"></a>  <span class="co">//     return r.width * r.height;</span></span>
<span id="cb74-49"><a href="#cb74-49" aria-hidden="true" tabindex="-1"></a>  <span class="co">//   }</span></span>
<span id="cb74-50"><a href="#cb74-50" aria-hidden="true" tabindex="-1"></a>  <span class="co">// }</span></span>
<span id="cb74-51"><a href="#cb74-51" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h2 data-number="17.3" id="matcher-any_of"><span class="header-section-number">17.3</span> Matcher:
<code class="sourceCode default">any_of</code><a href="#matcher-any_of" class="self-link"></a></h2>
<p>The logical-or pattern in other languages is typically spelled
<em>pattern</em><sub>0</sub> <code class="sourceCode default">|</code>
<em>pattern</em><sub>1</sub>
<code class="sourceCode default">| ... |</code>
<em>pattern</em><sub>N</sub>, and matches value
<code class="sourceCode default">v</code> if any
<em>pattern<sub>i</sub></em> matches
<code class="sourceCode default">v</code>.</p>
<p>This provides a restricted form (constant-only) of the logical-or
pattern.</p>
<div class="sourceCode" id="cb75"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb75-1"><a href="#cb75-1" aria-hidden="true" tabindex="-1"></a><span class="kw">template</span> <span class="op">&lt;</span><span class="kw">typename</span><span class="op">...</span> Ts<span class="op">&gt;</span></span>
<span id="cb75-2"><a href="#cb75-2" aria-hidden="true" tabindex="-1"></a><span class="kw">struct</span> any_of <span class="op">:</span> std<span class="op">::</span>tuple<span class="op">&lt;</span>Ts<span class="op">...&gt;</span> <span class="op">{</span></span>
<span id="cb75-3"><a href="#cb75-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">using</span> tuple<span class="op">::</span>tuple;</span>
<span id="cb75-4"><a href="#cb75-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-5"><a href="#cb75-5" aria-hidden="true" tabindex="-1"></a>  <span class="kw">template</span> <span class="op">&lt;</span><span class="kw">typename</span> U<span class="op">&gt;</span></span>
<span id="cb75-6"><a href="#cb75-6" aria-hidden="true" tabindex="-1"></a>  <span class="dt">bool</span> match<span class="op">(</span><span class="kw">const</span> U<span class="op">&amp;</span> u<span class="op">)</span> <span class="kw">const</span> <span class="op">{</span></span>
<span id="cb75-7"><a href="#cb75-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> std<span class="op">::</span>apply<span class="op">([&amp;](</span><span class="kw">const</span> <span class="kw">auto</span><span class="op">&amp;...</span> xs<span class="op">)</span> <span class="op">{</span> <span class="cf">return</span> <span class="op">(...</span> <span class="op">||</span> xs <span class="op">==</span> u<span class="op">)</span>; <span class="op">}</span>, <span class="op">*</span><span class="kw">this</span><span class="op">)</span>;</span>
<span id="cb75-8"><a href="#cb75-8" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb75-9"><a href="#cb75-9" aria-hidden="true" tabindex="-1"></a><span class="op">}</span>;</span></code></pre></div>
<div class="sourceCode" id="cb76"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb76-1"><a href="#cb76-1" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> fib<span class="op">(</span><span class="dt">int</span> n<span class="op">)</span> <span class="op">{</span></span>
<span id="cb76-2"><a href="#cb76-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> inspect <span class="op">(</span>n<span class="op">)</span> <span class="op">{</span></span>
<span id="cb76-3"><a href="#cb76-3" aria-hidden="true" tabindex="-1"></a>    x <span class="cf">if</span> <span class="op">(</span>x <span class="op">&lt;</span> <span class="dv">0</span><span class="op">)</span> <span class="op">=&gt;</span> <span class="dv">0</span>;</span>
<span id="cb76-4"><a href="#cb76-4" aria-hidden="true" tabindex="-1"></a>    any_of<span class="op">{</span><span class="dv">1</span>, <span class="dv">2</span><span class="op">}</span> <span class="op">=&gt;</span> n;  <span class="co">// 1 | 2</span></span>
<span id="cb76-5"><a href="#cb76-5" aria-hidden="true" tabindex="-1"></a>    x <span class="op">=&gt;</span> fib<span class="op">(</span>x <span class="op">-</span> <span class="dv">1</span><span class="op">)</span> <span class="op">+</span> fib<span class="op">(</span>x <span class="op">-</span> <span class="dv">2</span><span class="op">)</span>;</span>
<span id="cb76-6"><a href="#cb76-6" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span>;</span>
<span id="cb76-7"><a href="#cb76-7" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h2 data-number="17.4" id="matcher-within"><span class="header-section-number">17.4</span> Matcher:
<code class="sourceCode default">within</code><a href="#matcher-within" class="self-link"></a></h2>
<p>The range pattern in other languages is typically spelled
<code class="sourceCode default">first..last</code>, and matches
<code class="sourceCode default">v</code> if
<code class="sourceCode default">v</code> <span class="math inline">∈</span>
<code class="sourceCode default">[first, last]</code>.</p>
<div class="sourceCode" id="cb77"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb77-1"><a href="#cb77-1" aria-hidden="true" tabindex="-1"></a><span class="kw">struct</span> within <span class="op">{</span></span>
<span id="cb77-2"><a href="#cb77-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span> first, last;</span>
<span id="cb77-3"><a href="#cb77-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-4"><a href="#cb77-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">bool</span> match<span class="op">(</span><span class="dt">int</span> n<span class="op">)</span> <span class="kw">const</span> <span class="op">{</span> <span class="cf">return</span> first <span class="op">&lt;=</span> n <span class="op">&amp;&amp;</span> n <span class="op">&lt;=</span> last; <span class="op">}</span></span>
<span id="cb77-5"><a href="#cb77-5" aria-hidden="true" tabindex="-1"></a><span class="op">}</span>;</span></code></pre></div>
<div class="sourceCode" id="cb78"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb78-1"><a href="#cb78-1" aria-hidden="true" tabindex="-1"></a>inspect <span class="op">(</span>n<span class="op">)</span> <span class="op">{</span></span>
<span id="cb78-2"><a href="#cb78-2" aria-hidden="true" tabindex="-1"></a>  within<span class="op">{</span><span class="dv">1</span>, <span class="dv">10</span><span class="op">}</span> <span class="op">=&gt;</span> <span class="op">{</span>  <span class="co">// 1..10</span></span>
<span id="cb78-3"><a href="#cb78-3" aria-hidden="true" tabindex="-1"></a>    std<span class="op">::</span>cout <span class="op">&lt;&lt;</span> n <span class="op">&lt;&lt;</span> <span class="st">&quot; is in [1, 10].&quot;</span>;</span>
<span id="cb78-4"><a href="#cb78-4" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb78-5"><a href="#cb78-5" aria-hidden="true" tabindex="-1"></a>  __ <span class="op">=&gt;</span> <span class="op">{</span></span>
<span id="cb78-6"><a href="#cb78-6" aria-hidden="true" tabindex="-1"></a>    std<span class="op">::</span>cout <span class="op">&lt;&lt;</span> n <span class="op">&lt;&lt;</span> <span class="st">&quot; is not in [1, 10].&quot;</span>;</span>
<span id="cb78-7"><a href="#cb78-7" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb78-8"><a href="#cb78-8" aria-hidden="true" tabindex="-1"></a><span class="op">}</span>;</span></code></pre></div>
<h2 data-number="17.5" id="extractor-both"><span class="header-section-number">17.5</span> Extractor:
<code class="sourceCode default">both</code><a href="#extractor-both" class="self-link"></a></h2>
<p>The logical-and pattern in other languages is typically spelled
<em>pattern</em><sub>0</sub>
<code class="sourceCode default">&amp;</code>
<em>pattern</em><sub>1</sub>
<code class="sourceCode default">&amp; ... &amp;</code>
<em>pattern</em><sub>N</sub>, and matches
<code class="sourceCode default">v</code> if all of
<em>pattern</em><sub>i</sub> matches
<code class="sourceCode default">v</code>.</p>
<p>This extractor emulates binary logical-and with a
<code class="sourceCode default">std::pair</code> where both elements
are references to value <code class="sourceCode default">v</code>.</p>
<div class="sourceCode" id="cb79"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb79-1"><a href="#cb79-1" aria-hidden="true" tabindex="-1"></a><span class="kw">struct</span> Both <span class="op">{</span></span>
<span id="cb79-2"><a href="#cb79-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">template</span> <span class="op">&lt;</span><span class="kw">typename</span> U<span class="op">&gt;</span></span>
<span id="cb79-3"><a href="#cb79-3" aria-hidden="true" tabindex="-1"></a>  std<span class="op">::</span>pair<span class="op">&lt;</span>U<span class="op">&amp;&amp;</span>, U<span class="op">&amp;&amp;&gt;</span> extract<span class="op">(</span>U<span class="op">&amp;&amp;</span> u<span class="op">)</span> <span class="kw">const</span> <span class="op">{</span></span>
<span id="cb79-4"><a href="#cb79-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="op">{</span>std<span class="op">::</span>forward<span class="op">&lt;</span>U<span class="op">&gt;(</span>u<span class="op">)</span>, std<span class="op">::</span>forward<span class="op">&lt;</span>U<span class="op">&gt;(</span>u<span class="op">)}</span>;</span>
<span id="cb79-5"><a href="#cb79-5" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb79-6"><a href="#cb79-6" aria-hidden="true" tabindex="-1"></a><span class="op">}</span>;</span>
<span id="cb79-7"><a href="#cb79-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb79-8"><a href="#cb79-8" aria-hidden="true" tabindex="-1"></a><span class="kw">inline</span> <span class="kw">constexpr</span> Both both;</span></code></pre></div>
<div class="sourceCode" id="cb80"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb80-1"><a href="#cb80-1" aria-hidden="true" tabindex="-1"></a>inspect <span class="op">(</span>v<span class="op">)</span> <span class="op">{</span></span>
<span id="cb80-2"><a href="#cb80-2" aria-hidden="true" tabindex="-1"></a>  <span class="op">(</span>both<span class="op">!)</span> <span class="op">[[</span><span class="at">x</span>,<span class="at"> </span><span class="dv">0</span><span class="op">]</span>,<span class="at"> </span><span class="op">[</span><span class="dv">0</span>,<span class="at"> y</span><span class="op">]]</span> <span class="op">=&gt;</span> <span class="co">// ...</span></span>
<span id="cb80-3"><a href="#cb80-3" aria-hidden="true" tabindex="-1"></a><span class="op">}</span>;</span></code></pre></div>
<h2 data-number="17.6" id="extractor-at"><span class="header-section-number">17.6</span> Extractor:
<code class="sourceCode default">at</code><a href="#extractor-at" class="self-link"></a></h2>
<p>The binding pattern in other languages is typically spelled
<em>identifier</em> <code class="sourceCode default">@</code>
<em>pattern</em>, binds <em>identifier</em> to
<code class="sourceCode default">v</code> and matches if
<em>pattern</em> matches <code class="sourceCode default">v</code>. This
is a special case of the logical-and pattern
(<em>pattern</em><sub>0</sub>
<code class="sourceCode default">&amp;</code>
<em>pattern</em><sub>1</sub>) where <em>pattern</em><sub>0</sub> is an
<em>identifier</em>. That is, <em>identifier</em>
<code class="sourceCode default">&amp;</code> <em>pattern</em> has the
same semantics as <em>identifier</em>
<code class="sourceCode default">@</code> <em>pattern</em>, which means
we get <code class="sourceCode default">at</code> for free from
<code class="sourceCode default">both</code> above.</p>
<div class="sourceCode" id="cb81"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb81-1"><a href="#cb81-1" aria-hidden="true" tabindex="-1"></a><span class="kw">inline</span> <span class="kw">constexpr</span> at <span class="op">=</span> both;</span></code></pre></div>
<div class="sourceCode" id="cb82"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb82-1"><a href="#cb82-1" aria-hidden="true" tabindex="-1"></a>inspect <span class="op">(</span>v<span class="op">)</span> <span class="op">{</span></span>
<span id="cb82-2"><a href="#cb82-2" aria-hidden="true" tabindex="-1"></a>  <span class="op">&lt;</span>Point<span class="op">&gt;</span> <span class="op">(</span>at<span class="op">!)</span> <span class="op">[</span>p, <span class="op">[</span>x, y<span class="op">]]</span> <span class="op">=&gt;</span> <span class="co">// ...</span></span>
<span id="cb82-3"><a href="#cb82-3" aria-hidden="true" tabindex="-1"></a>  <span class="co">// ...</span></span>
<span id="cb82-4"><a href="#cb82-4" aria-hidden="true" tabindex="-1"></a><span class="op">}</span>;</span></code></pre></div>
<h2 data-number="17.7" id="red-black-tree-rebalancing"><span class="header-section-number">17.7</span> Red-black Tree Rebalancing<a href="#red-black-tree-rebalancing" class="self-link"></a></h2>
<p>Dereference patterns frequently come into play with complex patterns
using recursive variant types. An example of such a problem is the
rebalance operation for red-black trees. Using pattern matching this can
be expressed succinctly and in a way that is easily verified visually as
having the correct algorithm.</p>
<p>Given the following red-black tree definition:</p>
<div class="sourceCode" id="cb83"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb83-1"><a href="#cb83-1" aria-hidden="true" tabindex="-1"></a><span class="kw">enum</span> Color <span class="op">{</span> Red, Black <span class="op">}</span>;</span>
<span id="cb83-2"><a href="#cb83-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb83-3"><a href="#cb83-3" aria-hidden="true" tabindex="-1"></a><span class="kw">template</span> <span class="op">&lt;</span><span class="kw">typename</span> T<span class="op">&gt;</span></span>
<span id="cb83-4"><a href="#cb83-4" aria-hidden="true" tabindex="-1"></a><span class="kw">struct</span> Node <span class="op">{</span></span>
<span id="cb83-5"><a href="#cb83-5" aria-hidden="true" tabindex="-1"></a>  <span class="dt">void</span> balance<span class="op">()</span>;</span>
<span id="cb83-6"><a href="#cb83-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb83-7"><a href="#cb83-7" aria-hidden="true" tabindex="-1"></a>  Color color;</span>
<span id="cb83-8"><a href="#cb83-8" aria-hidden="true" tabindex="-1"></a>  std<span class="op">::</span>shared_ptr<span class="op">&lt;</span>Node<span class="op">&gt;</span> lhs;</span>
<span id="cb83-9"><a href="#cb83-9" aria-hidden="true" tabindex="-1"></a>  T value;</span>
<span id="cb83-10"><a href="#cb83-10" aria-hidden="true" tabindex="-1"></a>  std<span class="op">::</span>shared_ptr<span class="op">&lt;</span>Node<span class="op">&gt;</span> rhs;</span>
<span id="cb83-11"><a href="#cb83-11" aria-hidden="true" tabindex="-1"></a><span class="op">}</span>;</span></code></pre></div>
<p>The following is what we can write with pattern matching:</p>
<div class="sourceCode" id="cb84"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb84-1"><a href="#cb84-1" aria-hidden="true" tabindex="-1"></a><span class="kw">template</span> <span class="op">&lt;</span><span class="kw">typename</span> T<span class="op">&gt;</span></span>
<span id="cb84-2"><a href="#cb84-2" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> Node<span class="op">&lt;</span>T<span class="op">&gt;::</span>balance<span class="op">()</span> <span class="op">{</span></span>
<span id="cb84-3"><a href="#cb84-3" aria-hidden="true" tabindex="-1"></a>  <span class="op">*</span><span class="kw">this</span> <span class="op">=</span> inspect <span class="op">(*</span><span class="kw">this</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb84-4"><a href="#cb84-4" aria-hidden="true" tabindex="-1"></a>    <span class="co">// left-left case</span></span>
<span id="cb84-5"><a href="#cb84-5" aria-hidden="true" tabindex="-1"></a>    <span class="co">//</span></span>
<span id="cb84-6"><a href="#cb84-6" aria-hidden="true" tabindex="-1"></a>    <span class="co">//        (Black) z              (Red) y</span></span>
<span id="cb84-7"><a href="#cb84-7" aria-hidden="true" tabindex="-1"></a>    <span class="co">//         /     \               /      </span><span class="er">\</span></span>
<span id="cb84-8"><a href="#cb84-8" aria-hidden="true" tabindex="-1"></a><span class="co">    //     (Red) y    d        (Black) x  (Black) z</span></span>
<span id="cb84-9"><a href="#cb84-9" aria-hidden="true" tabindex="-1"></a>    <span class="co">//     /      \       -&gt;     /   \      /   </span><span class="er">\</span></span>
<span id="cb84-10"><a href="#cb84-10" aria-hidden="true" tabindex="-1"></a><span class="co">    //  (Red) x    c            a     b    c     d</span></span>
<span id="cb84-11"><a href="#cb84-11" aria-hidden="true" tabindex="-1"></a>    <span class="co">//   /    </span><span class="er">\</span></span>
<span id="cb84-12"><a href="#cb84-12" aria-hidden="true" tabindex="-1"></a><span class="co">    //  a      b</span></span>
<span id="cb84-13"><a href="#cb84-13" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span><span class="cf">case</span> Black, <span class="op">(*?)</span> <span class="op">[</span><span class="cf">case</span> Red, <span class="op">(*?)</span> <span class="op">[</span><span class="cf">case</span> Red, a, x, b<span class="op">]</span>, y, c<span class="op">]</span>, z, d<span class="op">]</span></span>
<span id="cb84-14"><a href="#cb84-14" aria-hidden="true" tabindex="-1"></a>      <span class="op">=&gt;</span> Node<span class="op">{</span>Red, std<span class="op">::</span>make_shared<span class="op">&lt;</span>Node<span class="op">&gt;(</span>Black, a, x, b<span class="op">)</span>,</span>
<span id="cb84-15"><a href="#cb84-15" aria-hidden="true" tabindex="-1"></a>                   y,</span>
<span id="cb84-16"><a href="#cb84-16" aria-hidden="true" tabindex="-1"></a>                   std<span class="op">::</span>make_shared<span class="op">&lt;</span>Node<span class="op">&gt;(</span>Black, c, z, d<span class="op">)}</span>;</span>
<span id="cb84-17"><a href="#cb84-17" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span><span class="cf">case</span> Black, <span class="op">(*?)</span> <span class="op">[</span><span class="cf">case</span> Red, a, x, <span class="op">(*?)</span> <span class="op">[</span><span class="cf">case</span> Red, b, y, c<span class="op">]]</span>, z, d<span class="op">]</span>  <span class="co">// left-right case</span></span>
<span id="cb84-18"><a href="#cb84-18" aria-hidden="true" tabindex="-1"></a>      <span class="op">=&gt;</span> Node<span class="op">{</span>Red, std<span class="op">::</span>make_shared<span class="op">&lt;</span>Node<span class="op">&gt;(</span>Black, a, x, b<span class="op">)</span>,</span>
<span id="cb84-19"><a href="#cb84-19" aria-hidden="true" tabindex="-1"></a>                   y,</span>
<span id="cb84-20"><a href="#cb84-20" aria-hidden="true" tabindex="-1"></a>                   std<span class="op">::</span>make_shared<span class="op">&lt;</span>Node<span class="op">&gt;(</span>Black, c, z, d<span class="op">)}</span>;</span>
<span id="cb84-21"><a href="#cb84-21" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span><span class="cf">case</span> Black, a, x, <span class="op">(*?)</span> <span class="op">[</span><span class="cf">case</span> Red, <span class="op">(*?)</span> <span class="op">[</span><span class="cf">case</span> Red, b, y, c<span class="op">]</span>, z, d<span class="op">]]</span>  <span class="co">// right-left case</span></span>
<span id="cb84-22"><a href="#cb84-22" aria-hidden="true" tabindex="-1"></a>      <span class="op">=&gt;</span> Node<span class="op">{</span>Red, std<span class="op">::</span>make_shared<span class="op">&lt;</span>Node<span class="op">&gt;(</span>Black, a, x, b<span class="op">)</span>,</span>
<span id="cb84-23"><a href="#cb84-23" aria-hidden="true" tabindex="-1"></a>                   y,</span>
<span id="cb84-24"><a href="#cb84-24" aria-hidden="true" tabindex="-1"></a>                   std<span class="op">::</span>make_shared<span class="op">&lt;</span>Node<span class="op">&gt;(</span>Black, c, z, d<span class="op">)}</span>;</span>
<span id="cb84-25"><a href="#cb84-25" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span><span class="cf">case</span> Black, a, x, <span class="op">(*?)</span> <span class="op">[</span><span class="cf">case</span> Red, b, y, <span class="op">(*?)</span> <span class="op">[</span><span class="cf">case</span> Red, c, z, d<span class="op">]]]</span>  <span class="co">// right-right case</span></span>
<span id="cb84-26"><a href="#cb84-26" aria-hidden="true" tabindex="-1"></a>      <span class="op">=&gt;</span> Node<span class="op">{</span>Red, std<span class="op">::</span>make_shared<span class="op">&lt;</span>Node<span class="op">&gt;(</span>Black, a, x, b<span class="op">)</span>,</span>
<span id="cb84-27"><a href="#cb84-27" aria-hidden="true" tabindex="-1"></a>                   y,</span>
<span id="cb84-28"><a href="#cb84-28" aria-hidden="true" tabindex="-1"></a>                   std<span class="op">::</span>make_shared<span class="op">&lt;</span>Node<span class="op">&gt;(</span>Black, c, z, d<span class="op">)}</span>;</span>
<span id="cb84-29"><a href="#cb84-29" aria-hidden="true" tabindex="-1"></a>    self <span class="op">=&gt;</span> self;  <span class="co">// do nothing</span></span>
<span id="cb84-30"><a href="#cb84-30" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span>;</span>
<span id="cb84-31"><a href="#cb84-31" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>The following is what we currently need to write:</p>
<div class="sourceCode" id="cb85"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb85-1"><a href="#cb85-1" aria-hidden="true" tabindex="-1"></a><span class="kw">template</span> <span class="op">&lt;</span><span class="kw">typename</span> T<span class="op">&gt;</span></span>
<span id="cb85-2"><a href="#cb85-2" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> Node<span class="op">&lt;</span>T<span class="op">&gt;::</span>balance<span class="op">()</span> <span class="op">{</span></span>
<span id="cb85-3"><a href="#cb85-3" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(</span>color <span class="op">!=</span> Black<span class="op">)</span> <span class="cf">return</span>;</span>
<span id="cb85-4"><a href="#cb85-4" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(</span>lhs <span class="op">&amp;&amp;</span> lhs<span class="op">-&gt;</span>color <span class="op">==</span> Red<span class="op">)</span> <span class="op">{</span></span>
<span id="cb85-5"><a href="#cb85-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span><span class="kw">const</span> <span class="kw">auto</span><span class="op">&amp;</span> lhs_lhs <span class="op">=</span> lhs<span class="op">-&gt;</span>lhs; lhs_lhs <span class="op">&amp;&amp;</span> lhs_lhs<span class="op">-&gt;</span>color <span class="op">==</span> Red<span class="op">)</span> <span class="op">{</span></span>
<span id="cb85-6"><a href="#cb85-6" aria-hidden="true" tabindex="-1"></a>      <span class="co">// left-left case</span></span>
<span id="cb85-7"><a href="#cb85-7" aria-hidden="true" tabindex="-1"></a>      <span class="co">//</span></span>
<span id="cb85-8"><a href="#cb85-8" aria-hidden="true" tabindex="-1"></a>      <span class="co">//        (Black) z              (Red) y</span></span>
<span id="cb85-9"><a href="#cb85-9" aria-hidden="true" tabindex="-1"></a>      <span class="co">//         /     \               /      </span><span class="er">\</span></span>
<span id="cb85-10"><a href="#cb85-10" aria-hidden="true" tabindex="-1"></a><span class="co">      //     (Red) y    d        (Black) x  (Black) z</span></span>
<span id="cb85-11"><a href="#cb85-11" aria-hidden="true" tabindex="-1"></a>      <span class="co">//     /      \       -&gt;     /   \      /   </span><span class="er">\</span></span>
<span id="cb85-12"><a href="#cb85-12" aria-hidden="true" tabindex="-1"></a><span class="co">      //  (Red) x    c            a     b    c     d</span></span>
<span id="cb85-13"><a href="#cb85-13" aria-hidden="true" tabindex="-1"></a>      <span class="co">//   /    </span><span class="er">\</span></span>
<span id="cb85-14"><a href="#cb85-14" aria-hidden="true" tabindex="-1"></a><span class="co">      //  a      b</span></span>
<span id="cb85-15"><a href="#cb85-15" aria-hidden="true" tabindex="-1"></a>      <span class="op">*</span><span class="kw">this</span> <span class="op">=</span> Node<span class="op">{</span></span>
<span id="cb85-16"><a href="#cb85-16" aria-hidden="true" tabindex="-1"></a>          Red,</span>
<span id="cb85-17"><a href="#cb85-17" aria-hidden="true" tabindex="-1"></a>          std<span class="op">::</span>make_shared<span class="op">&lt;</span>Node<span class="op">&gt;(</span>Black, lhs_lhs<span class="op">-&gt;</span>lhs, lhs_lhs<span class="op">-&gt;</span>value, lhs_lhs<span class="op">-&gt;</span>rhs<span class="op">)</span>,</span>
<span id="cb85-18"><a href="#cb85-18" aria-hidden="true" tabindex="-1"></a>          lhs<span class="op">-&gt;</span>value,</span>
<span id="cb85-19"><a href="#cb85-19" aria-hidden="true" tabindex="-1"></a>          std<span class="op">::</span>make_shared<span class="op">&lt;</span>Node<span class="op">&gt;(</span>Black, lhs<span class="op">-&gt;</span>rhs, value, rhs<span class="op">)}</span>;</span>
<span id="cb85-20"><a href="#cb85-20" aria-hidden="true" tabindex="-1"></a>      <span class="cf">return</span>;</span>
<span id="cb85-21"><a href="#cb85-21" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb85-22"><a href="#cb85-22" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span><span class="kw">const</span> <span class="kw">auto</span><span class="op">&amp;</span> lhs_rhs <span class="op">=</span> lhs<span class="op">-&gt;</span>rhs; lhs_rhs <span class="op">&amp;&amp;</span> lhs_rhs<span class="op">-&gt;</span>color <span class="op">==</span> Red<span class="op">)</span> <span class="op">{</span></span>
<span id="cb85-23"><a href="#cb85-23" aria-hidden="true" tabindex="-1"></a>      <span class="op">*</span><span class="kw">this</span> <span class="op">=</span> Node<span class="op">{</span>  <span class="co">// left-right case</span></span>
<span id="cb85-24"><a href="#cb85-24" aria-hidden="true" tabindex="-1"></a>          Red,</span>
<span id="cb85-25"><a href="#cb85-25" aria-hidden="true" tabindex="-1"></a>          std<span class="op">::</span>make_shared<span class="op">&lt;</span>Node<span class="op">&gt;(</span>Black, lhs<span class="op">-&gt;</span>lhs, lhs<span class="op">-&gt;</span>value, lhs_rhs<span class="op">-&gt;</span>lhs<span class="op">)</span>,</span>
<span id="cb85-26"><a href="#cb85-26" aria-hidden="true" tabindex="-1"></a>          lhs_rhs<span class="op">-&gt;</span>value,</span>
<span id="cb85-27"><a href="#cb85-27" aria-hidden="true" tabindex="-1"></a>          std<span class="op">::</span>make_shared<span class="op">&lt;</span>Node<span class="op">&gt;(</span>Black, lhs_rhs<span class="op">-&gt;</span>rhs, value, rhs<span class="op">)}</span>;</span>
<span id="cb85-28"><a href="#cb85-28" aria-hidden="true" tabindex="-1"></a>      <span class="cf">return</span>;</span>
<span id="cb85-29"><a href="#cb85-29" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb85-30"><a href="#cb85-30" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb85-31"><a href="#cb85-31" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(</span>rhs <span class="op">&amp;&amp;</span> rhs<span class="op">-&gt;</span>color <span class="op">==</span> Red<span class="op">)</span> <span class="op">{</span></span>
<span id="cb85-32"><a href="#cb85-32" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span><span class="kw">const</span> <span class="kw">auto</span><span class="op">&amp;</span> rhs_lhs <span class="op">=</span> rhs<span class="op">-&gt;</span>lhs; rhs_lhs <span class="op">&amp;&amp;</span> rhs_lhs<span class="op">-&gt;</span>color <span class="op">==</span> Red<span class="op">)</span> <span class="op">{</span></span>
<span id="cb85-33"><a href="#cb85-33" aria-hidden="true" tabindex="-1"></a>      <span class="op">*</span><span class="kw">this</span> <span class="op">=</span> Node<span class="op">{</span>  <span class="co">// right-left case</span></span>
<span id="cb85-34"><a href="#cb85-34" aria-hidden="true" tabindex="-1"></a>          Red,</span>
<span id="cb85-35"><a href="#cb85-35" aria-hidden="true" tabindex="-1"></a>          std<span class="op">::</span>make_shared<span class="op">&lt;</span>Node<span class="op">&gt;(</span>Black, lhs, value, rhs_lhs<span class="op">-&gt;</span>lhs<span class="op">)</span>,</span>
<span id="cb85-36"><a href="#cb85-36" aria-hidden="true" tabindex="-1"></a>          rhs_lhs<span class="op">-&gt;</span>value,</span>
<span id="cb85-37"><a href="#cb85-37" aria-hidden="true" tabindex="-1"></a>          std<span class="op">::</span>make_shared<span class="op">&lt;</span>Node<span class="op">&gt;(</span>Black, rhs_lhs<span class="op">-&gt;</span>rhs, rhs<span class="op">-&gt;</span>value, rhs<span class="op">-&gt;</span>rhs<span class="op">)}</span>;</span>
<span id="cb85-38"><a href="#cb85-38" aria-hidden="true" tabindex="-1"></a>      <span class="cf">return</span>;</span>
<span id="cb85-39"><a href="#cb85-39" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb85-40"><a href="#cb85-40" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span><span class="kw">const</span> <span class="kw">auto</span><span class="op">&amp;</span> rhs_rhs <span class="op">=</span> rhs<span class="op">-&gt;</span>rhs; rhs_rhs <span class="op">&amp;&amp;</span> rhs_rhs<span class="op">-&gt;</span>color <span class="op">==</span> Red<span class="op">)</span> <span class="op">{</span></span>
<span id="cb85-41"><a href="#cb85-41" aria-hidden="true" tabindex="-1"></a>      <span class="op">*</span><span class="kw">this</span> <span class="op">=</span> Node<span class="op">{</span>  <span class="co">// right-right case</span></span>
<span id="cb85-42"><a href="#cb85-42" aria-hidden="true" tabindex="-1"></a>          Red,</span>
<span id="cb85-43"><a href="#cb85-43" aria-hidden="true" tabindex="-1"></a>          std<span class="op">::</span>make_shared<span class="op">&lt;</span>Node<span class="op">&gt;(</span>Black, lhs, value, rhs<span class="op">-&gt;</span>lhs<span class="op">)</span>,</span>
<span id="cb85-44"><a href="#cb85-44" aria-hidden="true" tabindex="-1"></a>          rhs<span class="op">-&gt;</span>value,</span>
<span id="cb85-45"><a href="#cb85-45" aria-hidden="true" tabindex="-1"></a>          std<span class="op">::</span>make_shared<span class="op">&lt;</span>Node<span class="op">&gt;(</span>Black, rhs_rhs<span class="op">-&gt;</span>lhs, rhs_rhs<span class="op">-&gt;</span>value, rhs_rhs<span class="op">-&gt;</span>rhs<span class="op">)}</span>;</span>
<span id="cb85-46"><a href="#cb85-46" aria-hidden="true" tabindex="-1"></a>      <span class="cf">return</span>;</span>
<span id="cb85-47"><a href="#cb85-47" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb85-48"><a href="#cb85-48" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb85-49"><a href="#cb85-49" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h1 data-number="18" id="future-work"><span class="header-section-number">18</span> Future Work<a href="#future-work" class="self-link"></a></h1>
<h2 data-number="18.1" id="language-support-for-variant"><span class="header-section-number">18.1</span> Language Support for Variant<a href="#language-support-for-variant" class="self-link"></a></h2>
<p>The design of this proposal also accounts for a potential language
support for variant. It achieves this by keeping the alternative pattern
flexible for new extensions via
<code class="sourceCode default">&lt;</code> <em>new_entity</em>
<code class="sourceCode default">&gt;</code> <em>pattern</em>.</p>
<p>Consider an extension to
<code class="sourceCode default">union</code> that allows it to be
tagged by an integral, and has proper lifetime management such that the
active alternative need not be destroyed manually.</p>
<div class="sourceCode" id="cb86"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb86-1"><a href="#cb86-1" aria-hidden="true" tabindex="-1"></a><span class="co">// `: type` specifies the type of the underlying tag value.</span></span>
<span id="cb86-2"><a href="#cb86-2" aria-hidden="true" tabindex="-1"></a><span class="kw">union</span> U <span class="op">:</span> <span class="dt">int</span> <span class="op">{</span> <span class="dt">char</span> small<span class="op">[</span><span class="dv">32</span><span class="op">]</span>; std<span class="op">::</span>vector<span class="op">&lt;</span><span class="dt">char</span><span class="op">&gt;</span> big; <span class="op">}</span>;</span></code></pre></div>
<p>We could then allow <code class="sourceCode default">&lt;</code>
<em>qualified-id</em> <code class="sourceCode default">&gt;</code> that
refers to a <code class="sourceCode default">union</code> alternative to
support pattern matching.</p>
<div class="sourceCode" id="cb87"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb87-1"><a href="#cb87-1" aria-hidden="true" tabindex="-1"></a>U u <span class="op">=</span> <span class="co">/* ... */</span>;</span>
<span id="cb87-2"><a href="#cb87-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-3"><a href="#cb87-3" aria-hidden="true" tabindex="-1"></a>inspect <span class="op">(</span>u<span class="op">)</span> <span class="op">{</span></span>
<span id="cb87-4"><a href="#cb87-4" aria-hidden="true" tabindex="-1"></a>  <span class="op">&lt;</span>U<span class="op">::</span>small<span class="op">&gt;</span> s <span class="op">=&gt;</span> <span class="op">{</span> std<span class="op">::</span>cout <span class="op">&lt;&lt;</span> s; <span class="op">}</span></span>
<span id="cb87-5"><a href="#cb87-5" aria-hidden="true" tabindex="-1"></a>  <span class="op">&lt;</span>U<span class="op">::</span>big<span class="op">&gt;</span> b <span class="op">=&gt;</span> <span class="op">{</span> std<span class="op">::</span>cout <span class="op">&lt;&lt;</span> b; <span class="op">}</span></span>
<span id="cb87-6"><a href="#cb87-6" aria-hidden="true" tabindex="-1"></a><span class="op">}</span>;</span></code></pre></div>
<p>The main point is that whatever entity is introduced as the
discriminator, the presented form of alternative pattern should be
extendable to support it.</p>
<h2 data-number="18.2" id="note-on-ranges"><span class="header-section-number">18.2</span> Note on Ranges<a href="#note-on-ranges" class="self-link"></a></h2>
<p>The benefit of pattern matching for ranges is unclear. While it’s
possible to come up with a ranges pattern, e.g.,
<code class="sourceCode default">{x, y, z}</code> to match against a
fixed-size range, it’s not clear whether there is a worthwhile
benefit.</p>
<p>The typical pattern found in functional languages of matching a range
on head and tail doesn’t seem to be all that common or useful in C++
since ranges are generally handled via loops rather than recursion.</p>
<p>Ranges likely will be best served by the range adaptors / algorithms,
but further investigation is needed.</p>
<h1 data-number="19" id="acknowledgements-1"><span class="header-section-number">19</span> Acknowledgements<a href="#acknowledgements-1" class="self-link"></a></h1>
<p>Thanks to all of the following:</p>
<ul>
<li>Yuriy Solodkyy, Gabriel Dos Reis, Bjarne Stroustrup for their prior
work on <span class="citation" data-cites="N3449">[<a href="#ref-N3449" role="doc-biblioref">N3449</a>]</span>, Open Pattern Matching for C++
<span class="citation" data-cites="OpenPM">[<a href="#ref-OpenPM" role="doc-biblioref">OpenPM</a>]</span>, and the <span class="citation" data-cites="Mach7">[<a href="#ref-Mach7" role="doc-biblioref">Mach7</a>]</span> library.</li>
<li>Pattern matching presentation by Bjarne Stroustrup at
Urbana-Champaign 2014. <span class="citation" data-cites="PatMatPres">[<a href="#ref-PatMatPres" role="doc-biblioref">PatMatPres</a>]</span></li>
<li>Jeffrey Yasskin/JF Bastien for their work on <span class="citation" data-cites="P1110R0">[<a href="#ref-P1110R0" role="doc-biblioref">P1110R0</a>]</span>.</li>
<li>(In alphabetical order by last name) Dave Abrahams, John Bandela,
Agustín Bergé, Ori Bernstein, Matt Calabrese, Alexander Chow, Louis
Dionne, Michał Dominiak, Vicente Botet Escribá, Eric Fiselier, Bengt
Gustafsson, Zach Laine, Jason Lucas, Barry Revzin, John Skaller, Bjarne
Stroustrup, Tony Van Eerd, and everyone else who contributed to the
discussions.</li>
</ul>
<h1 data-number="20" id="bibliography"><span class="header-section-number">20</span> References<a href="#bibliography" class="self-link"></a></h1>
<div id="refs" class="references csl-bib-body hanging-indent" role="doc-bibliography">
<div id="ref-Mach7" class="csl-entry" role="doc-biblioentry">
[Mach7] Yuriy Solodkyy, Gabriel Dos Reis, and Bjarne Stroustrup. Mach7:
Pattern Matching for C++.
</div>
<div id="ref-N3449" class="csl-entry" role="doc-biblioentry">
[N3449] B. Stroustrup, G. Dos Reis, Y. Solodkyy. 2012-09-23. Open and
Efficient Type Switch for C++. <a href="https://wg21.link/n3449"><div class="csl-block">https://wg21.link/n3449</div></a>
</div>
<div id="ref-OpenPM" class="csl-entry" role="doc-biblioentry">
[OpenPM] Yuriy Solodkyy, Gabriel Dos Reis, and Bjarne Stroustrup. Open
Pattern Matching for C++.
</div>
<div id="ref-P0095R0" class="csl-entry" role="doc-biblioentry">
[P0095R0] David Sankel. 2015-09-24. The case for a language based
variant. <a href="https://wg21.link/p0095r0"><div class="csl-block">https://wg21.link/p0095r0</div></a>
</div>
<div id="ref-P1110R0" class="csl-entry" role="doc-biblioentry">
[P1110R0] Jeffrey Yasskin, JF Bastien. 2018-06-07. A placeholder with no
name. <a href="https://wg21.link/p1110r0"><div class="csl-block">https://wg21.link/p1110r0</div></a>
</div>
<div id="ref-P1371R0" class="csl-entry" role="doc-biblioentry">
[P1371R0] Sergei Murzin, Michael Park, David Sankel, Dan Sarginson.
2019-01-21. Pattern Matching. <a href="https://wg21.link/p1371r0"><div class="csl-block">https://wg21.link/p1371r0</div></a>
</div>
<div id="ref-P1371R1" class="csl-entry" role="doc-biblioentry">
[P1371R1] Sergei Murzin, Michael Park, David Sankel, Dan Sarginson.
2019-06-17. Pattern Matching. <a href="https://wg21.link/p1371r1"><div class="csl-block">https://wg21.link/p1371r1</div></a>
</div>
<div id="ref-P1371R2" class="csl-entry" role="doc-biblioentry">
[P1371R2] Sergei Murzin, Michael Park, David Sankel, Dan Sarginson.
2020-01-13. Pattern Matching. <a href="https://wg21.link/p1371r2"><div class="csl-block">https://wg21.link/p1371r2</div></a>
</div>
<div id="ref-P1371R3" class="csl-entry" role="doc-biblioentry">
[P1371R3] Michael Park, Bruno Cardoso Lopes, Sergei Murzin, David
Sankel, Dan Sarginson, Bjarne Stroustrup. 2020-09-15. Pattern Matching.
<a href="https://wg21.link/p1371r3"><div class="csl-block">https://wg21.link/p1371r3</div></a>
</div>
<div id="ref-P2392R0" class="csl-entry" role="doc-biblioentry">
[P2392R0] Herb Sutter. 2021-06-14. Pattern matching using
<span>“is”</span> and <span>“as.”</span> <a href="https://wg21.link/p2392r0"><div class="csl-block">https://wg21.link/p2392r0</div></a>
</div>
<div id="ref-PatMatPres" class="csl-entry" role="doc-biblioentry">
[PatMatPres] Yuriy Solodkyy, Gabriel Dos Reis, and Bjarne Stroustrup.
<span>“Pattern Matching for C++”</span> presentation at Urbana-Champaign
2014.
</div>
<div id="ref-Patterns" class="csl-entry" role="doc-biblioentry">
[Patterns] Michael Park. Pattern Matching in C++.
</div>
<div id="ref-SimpleMatch" class="csl-entry" role="doc-biblioentry">
[SimpleMatch] John Bandela. Simple, Extensible C++ Pattern Matching
Library.
</div>
<div id="ref-Warnings" class="csl-entry" role="doc-biblioentry">
[Warnings] Luc Maranget. Warnings for pattern matching.
</div>
<div id="ref-YAMLParser" class="csl-entry" role="doc-biblioentry">
[YAMLParser] <a href="http://llvm.org/doxygen/YAMLParser_8h_source.html"><div class="csl-block">http://llvm.org/doxygen/YAMLParser_8h_source.html</div></a>
</div>
</div>
</div>
</div>
</body>
</html>
